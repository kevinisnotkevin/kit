# VLAN

- [Что такое VLAN?](materials/networks/vlan.md)

> Построение сети между виртуальными машинами на базе Debian в одном VLAN. Пингуем, перехватываем пакеты, анализируем заголовки

Требования:
- Стенд из двух виртуальных машин на базе Debian10

# 1 Добавляем новый сетевой интерфейс на каждую виртуальную машину

Добавляем новый сетевой интерфейс для каждой машины из стенда в vmware.

# 2 Добавляем новый интерфейс

```bash
ip link add link ens33 name ens33.100 type vlan id 100
```
- Добавляем новый сетевой интерфейс на каждой машине. Он будет называться ens33.100 и представлять собой тегированный интерфейс с id=100
```bash
ip addr add 10.10.10.10/24 dev ens33.100
# или
ip a a 10.10.10.10/24 dev ens33.100
```
- Присваиваем созданному интерфейсу IP-адрес. Второй машине присваиваем адрес `10.10.10.20`
```bash
ip link set dev ens33.100 up
```
- Включаем интерфейс

Таким образом, мы создали интерфейс и назначили ему IP-адреса, который будет получать тегированные пакеты с vlan id = 100 и вешать на пакеты тег 100 при выпуске пакета в сеть через этот интерфейс.

# 3 Проверяем связность между виртуальными машинами

```bash
ping 10.10.10.20
```
- Пингуем вторую машину. Потерь быть не должно

# 4 Снифаем трафик

```bash
nohup nc -lvp 3000 & tcpdump -n host 10.10.10.20 -i ens33 -e
```
- Запускаем на первой машине приемник
```bash
nc 10.10.10.10 3000
```
- Запускаем на второй машине команду

Мы должны видеть в заголовках канального уровня vlan 100. Значит пакетам по сети реально присваиваются теги.

# 5 Сохранение настроек

```bash
auto ens33.100
iface ens33.100 inet static
address 10.10.10.10
netmask 255.255.255.0
vlan-raw-device ens33
```
- Вносим необходимые параметры в файл etc/netwok/interfaces на каждой виртуальной машине 

# 6 Настройка VLAN для Ubuntu

```bash
apt-get install vlan
```
- В отличии от FreeBSD для работы с VLAN в Ubuntu необходимо установить дополнительный пакет
```bash
sudo modprobe 8021q
```
- Подгружаем модуль для работы с VLAN
```bash
vconfig add ens33 100
```
- Создаем интерфейс, где ens33 - сетевая карта к которой подведен VLAN, 100 - VLAN ID
```bash
ip addr add 10.10.10.10/24 dev ens33.100
ip link set up ens33.100
```
- Назначаем IP-адрес новому интерфейсу и включаем его
```bash
su -c 'echo "8021q" >> /etc/modules'
```
- Добавляем параметры в файлы конфигурации, чтобы они сохранились после перезагрукзки
```bash
auto ens33.100
iface ens33.100 inet static
address 10.10.10.10
netmask 255.255.255.0
vlan-raw-device ens33
```
- Добавляем конфигурацию виртуального интерфейса для работы с VLAN в файл конфигурации сетевых карт /etc/network/interfaces
