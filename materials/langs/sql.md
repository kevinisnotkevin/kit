# SQL
## 1 **Что такое SQL?**

SQL (Structured Query Language) - это язык программирования, используемый в большинстве реляционных баз данных для запросов, обработки и определения данных, а также контроля доступа. SQL был разработан в IBM в 1970-х годах. Со временем у стандарта SQL ANSI появились многочисленные расширения, разработанные такими компаниями как IBM, Oracle и Microsoft. Хотя в настоящее время SQL все еще широко используется, начали появляться новые языки программирования запросов.

Является, прежде всего, информационно-логическим языком, предназначенным для описания, изменения и извлечения данных, хранимых в реляционных базах данных. В общем случае SQL (без ряда современных расширений) считается языком программирования неполным по Тьюрингу, но вместе с тем стандарт языка спецификацией SQL/PSM предусматривает возможность его процедурных расширений.

Одна из ключевых особенностей языка SQL заключается в том, что с его помощью формируются запросы, описывающие, какую информацию из БД необходимо получить, а пути решения этой задачи программа определяет сама.

### 1.1 Для чего нужен SQL

SQL позволяет:

- получать доступ к данным в системах управления РБД
- описывать данные (их структуру)
- определять данные в БД и управлять ими
- взаимодействовать с другими языками через модули SQL, библиотеки и предварительные компиляторы
- создавать и удалять БД и таблицы
- создавать представления, хранимые процедуры (stored procedures) и функции в БД
- устанавливать разрешения на доступ к таблицам, процедурам и представлениям

### 1.2 Принцип работы запросов

Чтобы разобраться, как именно работает магия запроса, давайте представим его путь от пользователя до нужных ему данных:

Пользователь → Клиент → Запрос → Система управления → База данных → Таблица с базами данных

- Клиент - способ введения запроса. В случае с Google, например, клиентом будет поисковая строка браузера, в которую пользователь вводит сформулированный запрос
- Система управления базами данных (СУБД) - комплекс программ, которые позволяют управлять данными. Эта система помогает таблицам понять, чего хочет пользователь, а пользователю - что ему отвечают таблицы
- База данных - система хранения таблиц, в которой они связаны между собой. База данных сама по себе не умеет манипулировать информацией - это просто хранилище, где у каждого объекта есть свое место

## 2 Элементы SQL

Язык SQL представляет собой совокупность операторов, инструкций, вычисляемых функций.

Операторы в SQL делятся на несколько групп в соответствии с задачами, которые они решают.

### DDL

DDL (Data Definition Language) - операторы определения данных. Они работают с объектами, то есть с целыми таблицами. Если базу нужно дополнить таблицей с новыми данными или, наоборот, убрать одну из таблиц с ошибочными данными - используется этот набор операторов.

- `CREATE` - создание объекта в базе данных
- `ALTER` - изменение объекта
- `DROP` - удаление объекта

### DML

DML (Data Manipulation Language) - операторы манипуляции данными. Эти операторы уже работают с содержимым таблиц - строками, атрибутами и значениями. С их помощью можно вносить изменения в конкретное значение. Например, заменить поле в колонке «Фамилия» в строке с данными сотрудницы компании посте того, как она вышла замуж. Или удалить строку с данными уволенного сотрудника.

- `SELECT` - выбор данных в соответствии с условием
- `INSERT` - добавление новых данных
- `UPDATE` - изменение существующих данных
- `DELETE` - удаление данных

### DCL

DCL (Data Control Language) - оператор определения доступа к данным. Он определяет, кто из пользователей может отправлять запросы к базе, менять объекты и значения. Например, можно отозвать доступ у сотрудника, перешедшего в другой отдел, а также открыть доступ к базе новому маркетологу или разработчику.

- `GRANT` - предоставление доступа к объекту
- `REVOKE` - отзыв ранее выданного разрешения
- `DENY` - запрет, который является приоритетным над разрешением

### TCL

TCL (Transaction Control Language) - язык управления транзакциями. Транзакции - это набор команд, которые выполняются поочередно. Если все команды выполнены, транзакция считается успешной, а если где-то произошла ошибка — транзакция откатывается назад, отменяя все выполненные команды. Наглядный пример такой транзакции - оплата онлайн, когда банк просит сначала ввести сумму и получателя, затем проверить и подтвердить операцию, а после ввести одноразовый код. На каждом из этих этапов оплату можно отменить и транзакция откатится назад.

- `BEGIN TRANSACTION` - обозначение начала транзакции
- `COMMIT TRANSACTION` - изменение команд внутри транзакции
- `ROLLBACK TRANSACTION` - откат транзакции
- `SAVE TRANSACTION` - указание промежуточной точки сохранения внутри транзакции

### 2.0 Создание БД и таблиц

```bash
# Создание БД
CREATE DATABASE dbname;

# Создание пользователя
CREATE USER dbuser WITH PASSWORD 'password';

# Назначение прав пользователю на БД
GRANT ALL PRIVILEGES ON DATABASE dbname TO dbuser;

# Удаление пользователя
DROP ROLE dbuser;
```

```bash
\c db_test
```

```bash
CREATE TABLE Customers (
    CustomerID INT PRIMARY KEY,
    CustomerName VARCHAR(255),
    City VARCHAR(255),
    Country VARCHAR(255)
);

CREATE TABLE Orders (
    OrderID INT PRIMARY KEY,
    CustomerID INT,
    Total_amount DECIMAL(10, 2),
    FOREIGN KEY (CustomerID) REFERENCES Customers(CustomerID)
);

CREATE TABLE employees (
    Employee_id INT PRIMARY KEY,
    Name VARCHAR(255),
    Salary DECIMAL(10, 2),
    Department_id INT,
    Email VARCHAR(255)
);

CREATE TABLE products (
    Product_id INT PRIMARY KEY,
    Price DECIMAL(10, 2),
    Category VARCHAR(255)
);

CREATE TABLE OrderDetails (
    OrderDetail_id INT PRIMARY KEY,
    OrderID INT,
    ProductID INT,
    Quantity INT,
    FOREIGN KEY (OrderID) REFERENCES Orders(OrderID)
);
```

Добавим данные:

```bash
INSERT INTO Customers (CustomerID, CustomerName, City, Country) VALUES
(1, 'Ivan Ivanov', 'Moscow', 'Russia'),
(2, 'John Smith', 'New York', 'USA'),
(3, 'Anna Schmidt', 'Berlin', 'Germany');

INSERT INTO Orders (OrderID, CustomerID, Total_amount) VALUES
(1, 1, 100),
(2, 2, 200),
(3, 3, 300);

INSERT INTO Employees (Employee_id, Name, Salary, Department_id, Email) VALUES
(1, 'John Doe', 5000, 10, 'johndoe@email.com'),
(2, 'Jane Smith', 6000, 20, 'janesmith@email.com'),
(3, 'Emily Johnson', 7000, 30, 'emilyjohnson@email.com');

INSERT INTO products (Product_id, Price, Category) VALUES
(1, 100, 'Category A'),
(2, 200, 'Category B'),
(3, 300, 'Category C');

INSERT INTO OrderDetails (OrderDetail_id, OrderID, ProductID, Quantity) VALUES
(1, 1, 1, 10),
(2, 2, 2, 20),
(3, 3, 3, 30);
```

### 2.1 Оператор SELECT

```sql
SELECT * FROM employees;
```
- Оператор SELECT используется для выборки данных из таблиц баз данных.

### 2.2 Условный оператор WHERE

```sql
SELECT * FROM orders WHERE total_amount > 100;
```
- Условный оператор WHERE используется для фильтрации результатов запроса в соответствии с определенным условием.

### 2.4 Оператор HAVING

```sql
SELECT City, COUNT(CustomerID) 
FROM Customers 
GROUP BY City 
HAVING COUNT(CustomerID) >= 5;
```
- HAVING - необязательный элемент запроса, который отвечает за фильтрацию на уровне сгруппированных данных (по сути, WHERE, но только на уровень выше). Фильтрация агрегированной таблицы с количеством клиентов по городам, в данном случае оставляем в выгрузке только те города, в которых не менее 5 клиентов.

```sql
SELECT City, COUNT(CustomerID) as number_of_clients 
FROM Customers 
WHERE CustomerName not in ('Around the Horn', 'Drachenblut Delikatessend') 
GROUP BY City 
HAVING COUNT(CustomerID) >= 1;
```
- Пример запроса, содержащего WHERE и HAVING. В данном запросе сначала фильтруется исходная таблица по пользователям, рассчитывается количество клиентов по городам и остаются только те города, где количество клиентов не менее 1.

### 2.5 Операторы INSERT, UPDATE и DELETE

```sql
INSERT INTO employees (employee_id, name, salary) VALUES (14, 'John', 5000);

UPDATE employees SET salary = 10000 WHERE name = 'John';

DELETE FROM employees WHERE employee_id = 14;
```
- Операторы INSERT, UPDATE и DELETE используются для добавления, обновления и удаления данных в таблицах баз данных соответственно.

### 2.6 Операторы CREATE TABLE и ALTER TABLE

```sql
CREATE TABLE employees_2 (
	employee_id INT PRIMARY KEY,
	name VARCHAR(100),
	department_id INT
);

ALTER TABLE employees_2 ADD COLUMN email VARCHAR(255);
```
- Операторы CREATE TABLE и ALTER TABLE используются для создания и изменения структуры таблиц баз данных.

### 2.7 Операторы INDEX и CONSTRAINT

```sql
CREATE INDEX idx_customer_name ON customers (customername);

ALTER TABLE orders 
ADD CONSTRAINT fk_customerid 
FOREIGN KEY (customerid) 
REFERENCES customers(customerid);
```
- Операторы INDEX и CONSTRAINT используются для определения индексов и ограничений целостности данных в базе данных. Индексация позволяет базе данных быстрее находить записи в таблице на основе значений указанного столбца (в данном случае, "name"). Это очень полезно для ускорения процесса поиска в больших таблицах.

### 2.8 Операторы GROUP BY

GROUP BY - необязательный элемент запроса, с помощью которого можно задать агрегацию по нужному столбцу (например, если нужно узнать какое количество клиентов живет в каждом из городов).

При использовании GROUP BY обязательно:
1. перечень столбцов, по которым делается разрез, был одинаковым внутри SELECT и внутри GROUP BY,
2. агрегатные функции (SUM, AVG, COUNT, MAX, MIN) должны быть также указаны внутри SELECT с указанием столбца, к которому такая функция применяется.

```sql
SELECT City, COUNT(CustomerID) 
FROM Customers 
GROUP BY City;
```
- Группировка количества клиентов по городу.

```sql
SELECT Country, City, COUNT(CustomerID) 
FROM Customers 
GROUP BY Country, City;
```
- Группировка количества клиентов по стране и городу.

```sql
SELECT ProductID, COUNT(OrderID), SUM(Quantity) 
FROM OrderDetails 
GROUP BY ProductID;
```
- Группировка продаж по ID товара с разными агрегатными функциями: количество заказов с данным товаром и количество проданных штук товара.

```sql
SELECT City, COUNT(CustomerID) 
FROM Customers 
WHERE Country = 'Germany' 
GROUP BY City;
```
- Группировка продаж с фильтрацией исходной таблицы. В данном случае на выходе будет таблица с количеством клиентов по городам Германии.

```sql
SELECT City, COUNT(CustomerID) AS Number_of_clients 
FROM Customers 
GROUP BY City;
```
- Переименование столбца с агрегацией с помощью оператора AS. По умолчанию название столбца с агрегацией равно примененной агрегатной функции, что далее может быть не очень удобно для восприятия.

### 2.9 Оператор JOIN

Оператор JOIN используется для объединения таблиц по ключу, который присутствует в обеих таблицах. Перед ключом ставится оператор ON.

```sql
SELECT * 
FROM Orders 
JOIN Customers ON Orders.CustomerID = Customers.CustomerID;
```
- Запрос, в котором соединяем таблицы Order и Customer по ключу CustomerID, при этом перед названиям столбца ключа добавляется название таблицы через точку.

```sql
SELECT * 
FROM Orders 
JOIN Customers ON Orders.CustomerID = Customers.CustomerID 
WHERE Customers.CustomerID > 2;
```
- Нередко может возникать ситуация, когда надо промэппить одну таблицу значениями из другой. В зависимости от задачи, могут использоваться разные типы присоединений. INNER JOIN - пересечение, RIGHT/LEFT JOIN для мэппинга одной таблицы знаениями из другой.

## 3 Процесс SQL

При выполнении любой SQL-команды в любой RDBMS (Relational Database Management System — система управления РБД, СУБД, например, PostgreSQL, MySQL, MSSQL, SQLite и др.) система определяет наилучший способ выполнения запроса, а движок SQL определяет способ интерпретации задачи.

В данном процессе участвует несколько компонентов:

- диспетчер запросов (Query Dispatcher)
- движок оптимизации (Optimization Engines)
- классический движок запросов (Classic Query Engine)
- движок запросов SQL (SQL Query Engine) и т.д.

Классический движок обрабатывает все не-SQL-запросы, а движок SQL-запросов не обрабатывает логические файлы.

## 4 Диалекты SQL (расширения SQL)

Язык SQL - универсальный язык для всех реляционных систем управления базами данных, но многие СУБД вносят свои изменения в язык, применяемый в них, тем самым отступая от стандарта. Такие языки называют диалектами или расширениями языка.

Вот некоторые из них:

- T-SQL – диалект Microsoft SQL Server
- PL/SQL – диалект Oracle Database
- PL/pgSQL – диалект PostgreSQL

### 4.1 Диалект SQL: MySQL

- **Особенности:** MySQL - это одна из самых популярных реляционных баз данных, широко используемая в веб-разработке и других областях. Его диалект SQL характеризуется простым и интуитивно понятным синтаксисом.
- **Основные различия:** Одним из отличительных особенностей MySQL является использование двойных кавычек для обозначения строковых значений, в то время как в других диалектах SQL используются одинарные кавычки. Кроме того, MySQL имеет свои собственные функции и операторы, такие как LIMIT для ограничения количества возвращаемых записей в запросе.

### 4.2 Диалект SQL: PostgreSQL

- **Особенности:** PostgreSQL - это мощная и расширяемая реляционная база данных с открытым исходным кодом. Ее диалект SQL предоставляет богатый набор функций и возможностей.
- **Основные различия:** PostgreSQL часто использует двойные кавычки для обозначения идентификаторов, таких как имена таблиц и столбцов, что отличается от стандартного использования одинарных кавычек в других диалектах. Кроме того, PostgreSQL предоставляет множество расширений и возможностей, таких как оконные функции и генерируемые столбцы.

### 4.3 Диалект SQL: Microsoft SQL Server

- **Особенности:** Microsoft SQL Server - это коммерческая реляционная база данных, разработанная корпорацией Microsoft. Ее диалект SQL широко используется в корпоративной среде и имеет свои собственные особенности.
- **Основные различия:** В SQL Server, например, используется функция TOP вместо LIMIT для ограничения количества возвращаемых записей. Также в SQL Server могут присутствовать различия в типах данных и синтаксисе для некоторых операторов и функций.

При работе с SQL важно учитывать различия между диалектами SQL конкретных систем управления базами данных. Понимание этих различий помогает разработчикам писать более эффективные и переносимые запросы к базам данных. В ходе работы с различными системами управления базами данных рекомендуется обращаться к документации и руководствам по соответствующему диалекту SQL для получения дополнительной информации о его особенностях и функциональных возможностях.
