# service mesh

**service mesh** - это инфраструктурный слой для обеспечения сетевых коммуникаций между сервисами с использованием прокси.

Запросы между сервисами перехватываются прокси-серверами, работа которых координируется централизованной сетевой службой, предоставляющей api для управления сетью и наблюдения за ней.

Наиболее популярные реализации service mesh - istio, consul, linkerd.

Существует три изолированных контура сети:

- внешняя: граничит с внутрисетевым пространством service mesh
- внутренняя: содержит сущности развертки (deployment) оркестровщика сети
- локальная: сеть внутри контейнера

**control plane** - это управляющие сервисы.

**data plane** - это управляемые прокси серверы.

**sidecar pattern** - это концепция внедрения контейнера с прокси сервером в атомарную группу контейнеров (например, под в к8с). Эта концепция позволяет реализовать необходимую сетевую логику и безопасность, получить телеметрию.

## istio

istio - это oss платформа, реализующая сетевую инфраструктурную логику масштабируемых приложений.

- Поддерживает платформы телеметрии (prometheus, jaeger)
- Не требует изменения бизнес-сервисов при внедрении
- Обеспечивает безопасность межсервисных коммуникаций с помощью сквозной аутентификации и авторизации
- Автоматическая балансировка нагрузки
- Контроллирует http, grpc, websocket, tcp трафик с помощью правил маршрутизации, аварийных переключений, лимитов запросов, внедрений неисправностей

**Архитектура**

istio внедряет контейнер с прокси сервером в каждый под с бизнес сервисом. прокси сервер перехватывает и управляет всем входящим и исходящим трафиком из контейнера с бизнес сервисом.

istio внедряет два контейнера с прокси сервером на границе service mesh и внешней сети, один для контроля всем входящим трафиком (ingress шлюз), а второй для управления всем исходящим трафиком (egress шлюз).

Конфигурация service mesh происходит при помощи api istio, который передает необходимые конфигурации на каждый перехватывающий прокси сервер.

control plane istio представлен сервисом istiod, который разворачивается в service mesh. Он включает в себя сервисы, поддерживающие реестр сервисов внутри сети, управляющие конфигурациями, выпускающие сертификаты, поддерживающие расширения.

### envoy

**envoy proxy** - это многопоточное приложение с событийно-ориентированной архитектурой. Каждое TCP соединение обрабатывается в отдельном потоке. Разделен на две основные подсистемы: listener, cluster.

**envoy proxy** - это обратный высокопроизводительный oss прокси сервер L3/L4 на C++, который поддерживает TCP, UDP, HTTP/(1,2,3), gRPC, TLS, Redis, MongoDB, Postgres и др. Поддерживает сетевые фильтры HTTP L7, позволяя реализовать буферизацию, квотирование запросов, маршрутизацию на основе заголовков в запросе и др. Используется в качестве прокси сервера в istio.

- Динамически применяет конфигурации
- Имеет встроенную систему проверки работоспособности сервисов
- Обеспечивает балансировку нагрузки
- Обеспечивает максимальную наблюдаемость сети за счет фиксации событий на поддерживаемых уровнях сетевой модели

**Архитектура**

- Listener
	- транспортный сокет TLS
	- произвольный фильтр в цепи HTTP фильтров
	- HTTP роутер
- Cluster
	- Пул соединений с upstream
	- балансировщик нагрузки
	- транспортный сокет TLS
	- HTTP кодек

**Терминология**

**cluster** - это логический сервис с набором эндпоинтов, на который envoy совершает редирект запроса. создает и конфигурирует соединения с поставщиком данных (upstream) и обеспечивает сведениями об эндпоинтах в сети. Имеет такие компоненты, как пул соединений с upstream, балансировщик нагрузки, компонент контроля работоспособности upstream, HTTP и TLS кодеки.

**downstream** - это сущность, которая инициирует соединение с envoy и является источником запроса, она может быть представлена как приложение в том же поде, так и другим envoy прокси в service mesh или внешним сетевым узлом.

**endpoints** - это сетевые узлы, которые относятся к логическому сервису.

**filter** - это один из модулей, представляющий собой какой-либо аспект на пути установления соединения или обработки запроса, позволяющий вводить требуемое ограничение.

**listener** - это модуль, который обрабатывает запросы от источника (downstream), подготавливает ответы для него, содержит сетевые фильтры из L3, L4, L7 уровней. Здесь происходит установка соединения с вызывающим узлом, проведение рукопожатий TLS, декодирование TLS, реализация кастомных сетевых фильтров, маршрутизация запроса. Если поступает HTTP запрос, то для него создается цепь HTTP фильтров, завершающий из которых - это HTTP роутер, который передает вызов cluster-у.

**upstream** - это эндпоинт, с которым envoy соединяется для редиректа запроса, поступившего от downstream.

### Реестр сервисов

прокси серверы envoy в data plane имеют информацию о развернутых сервисах и их эндпоинтах для маршрутизации трафика.