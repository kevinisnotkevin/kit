# DNS

DNS (Domain Name System) - система доменных имен. Компьютерная распределенная система для получения информации о доменах. Чаще всего используется для получения IP адреса по имени хоста.

С виду протокол довольно простой, но на нем держится огромное количество как локальных инфраструктур, так и глобальные сети.

Основная задача протокола DNS – предоставить удобную систему для обращения к устройствам по их именам. В этом случае нам уже не требуется запоминать все ip адреса устройств, так как эти адреса будут ассоциированы с удобными именами. С помощью протокола DNS мы обращаемся к веб сайтам глобальной сети интернет, к локальным устройствам, будь то компьютер или сервер.

Как правило, считается, что DNS использует UDP port 53, но TCP port 53 также зарезервирован под использование для DNS.

**Достоинства:**

- Позволяет легко просматривать интернет-страницы.
- Отменяет необходимость запоминания IP-адресов, поскольку переводит доменные имена в IP-адреса.
- Хорошо настроенный DNS может повысить безопасность домашних и организационных сетей и предотвратить такие атаки, как DNS poisoning.

**Недостатки:**

- Основным недостатком DNS является тот факт, что его реестр контролируется ICANN.
- Запросы к серверам DNS обычно не несут никакой информации о запрашивающем клиенте.
- DNS-серверы могут быть уязвимы к атакам типа "отказ в обслуживании", нарушающим их функционирование в сети.

## Принцип работы

Если очень упростить схему, то есть DNS сервер, цель которого, на ваш DNS запрос по доменному имени, предоставить информацию. Это может быть IPv4, IPv6 адреса.

Нам необходим ip адрес ресурса, поэтому система, когда видит, что в URL не IPv4/IPv6 адрес, делает запрос по протоколу DNS до DNS сервера, и получает в ответ IPv4/IPv6 адрес. Далее когда получен IPv4/IPv6 адрес, делает уже запрос по протоколу HTTP.

## Структура DNS запроса

**Transaction ID** - уникальный идентификатор транзакции, с помощью него мы можем определить, что пакет принадлежит одной и той же сессии “запрос-ответ”.

**Флаги:**

**Response (QR)** - если 0, то пакет является запросом, если 1, то пакет является ответом.

**Opcode** - тип запроса, имеет следующие значения: **0** для стандартного запроса, **1** для инверсного запроса, **2** для запроса статуса сервера.

**Trancated (TC)** - актуально только для ответов, поэтому в данном случае 0.

**Recursion desired (RD)** - если 1 устанавливается в запросе, то значит, что клиент просит вернуть только ip адрес в ответ и не сообщать промежуточные ответы, также копируется в ответ.

**Questions** - количество записей в секции запросов, в данном случае 1.

**Answer, Authority, Additional RRs** - актуально только для ответов, поэтому 0.

Далее сам **запрашиваемый адрес** - google.com

**Type** - тип записи DNS, в данном случае AAAA - ipv6 адрес, просто A означает ipv4 адрес

**Class** - тип рабочей сети, IN для internet

## Структура DNS ответа

**Transaction ID** - уникальный идентификатор транзакции, с помощью него мы можем определить, что пакет принадлежит одной и той же сессии “запрос-ответ”.

**Флаги:**

**Response (QR)** - если 0, то пакет является запросом, если 1, то пакет является ответом.

**Opcode** - тип запроса, имеет следующие значения: **0** для стандартного запроса, **1** для инверсного запроса, **2** для запроса статуса сервера.

**Trancated (TC)** - данный флаг устанавливается в пакете ответе в том случае если сервер не смог поместить всю необходимую информацию в пакет из-за существующих ограничений.

**Recursion desired (RD)** - если 1 устанавливается в запросе, то значит, что клиент просит вернуть только ip адрес в ответ и не сообщать промежуточные ответы, также копируется в ответ.

**Reply code** - код ошибок, в данном случае все отработало без ошибок.

**Questions** - количество записей в секции запросов, в данном случае 1.

**Answer RRs** - указывает на наличие 4 записей в ответе.

Далее сам **запрашиваемый адрес** - google.com

**Type** - тип записи DNS, в данном случае AAAA - ipv6 адрес, просто A означает ipv4 адрес

**Class** - тип рабочей сети, IN для internet

Ну и сами адреса в поле **Answers.**

## Разрешение имени

Как ранее уточнялось, с помощью такого протокола мы можем обратиться к устройству по его имени. Но эта информация никак не фигурирует в основных уровнях модели OSI, где используется адресация – L2 и L3. Мы не можем в заголовок ip или mac адреса подставить имя хоста, ведь там стандартизованы конкретные адреса. Поэтому DNS проводит процесс, называемый «разрешение имени». При этом процессе мы спрашиваем у специального DNS сервера, какой ip адрес у нужного нам ресурса. В примере происходит разрешение имени example.com. В ответ на такой запрос dns сервер отвечает нам ip адресом искомого устройства, после чего компьютер в заголовке L3 уже может использовать полученный ip. DNS имена также называют доменными именами.

## Иерархия DNS

DNS имеет иерархическую структуру. У каждого сайта в сети интернет есть имя, состоящее из слов, разделенных точкой. Хоть мы этого и не видим, но на самом деле любое доменное имя начинается с точки. Да, я не ошибся – именно начинается, так как начало доменного имени находится справа. После точки левее идет домен верхнего уровня, ещё левее – поддомен, или же домен второго уровня, далее поддомен третьего уровня и так далее. Таким образом выстраивается полное доменное имя ресурса. Мы привыкли к тому, что обращаемся к сайтам по имени. Но уточню, что за любым сайтом стоит сервер, который поддерживает его работу. Бэкенд сайта расположен на вычислительном устройстве, которое и отдает нам информацию о сайте и его содержимом в ответ на наш веб запрос. Поэтому получается, что доменное имя сайта можно ассоциировать с именем сервера, на котором сайт расположен.

## Уровни DNS

DNS представляет собой базу данных сопоставлений имен и ip адресов. Хранить такую базу на одном устройстве было бы крайне сложно, так как современная глобальная сеть содержит миллиарды dns записей. Поэтому и используется иерархия – такой механизм оптимизирует dns запросы и позволяет хранить информацию распределенно.

Иерархическая структура DNS выглядит следующим образом:

Всё начинается с корневых серверов. Это та самая невидимая точка в доменном имени. Корневых серверов во всём мире тринадцать штук, их ip адреса известны всем. Да, к dns серверу мы обращаемся именно по ip адресу. Когда мы хотим получить ip адрес сайта example.com, то мы обратимся сначала к корневому серверу, он же root. На этом сервере хранится информация об адресах доменов первого уровня, в нашем случае это домен .com.

Домены первого уровня ещё называются TDL – top level domain. Узнав его адрес мы обратимся уже к dns серверу .com с тем же вопросом – знает ли он об ip адресе example.com? После такого обращения мы получим ответ с искомым ip адресом, так как имя, адрес которого мы ищем, является поддоменом .com.

Если у зоны example.com есть поддомены, то тогда мы бы могли разрешить и их, обратившись к соответствующему dns серверу второго уровня, он же SLD – sub level domain

## Шаги DNS запроса

Шаг 1. Вы набираете адрес в своём браузере, например example.com. Ваш запрос направляется на получение IP-адреса на сервер доменных имён вашего провайдера.

Шаг 2. Если DNS сервер вашего провайдера не знает ответа, то он перенаправляет запрос на корневой DNS сервер.

Шаг 3. Если корневой DNS не знает ответа, он говорит обратиться к DNS сервер верхнего уровня

Шаг 4. DNS сервер провайдера обращается к DNS серверу TLD

Шаг 5. Он, на основе своей базы данных, говорит обратиться к серверу, обслуживающему example.com

Шаг 6. Сервер провайдера обращается к нужному SLD DNS серверу

Шаг 7. Он отвечает предоставляя искомый IP адрес

Шаг 8. Сервер провайдера отвечает: вот IP-адрес example.com

## Сопоставление имени

Основной процесс dns - это сопоставление имен. Бывает 2 разных вида сопоставления:

Первый вид – **прямое сопоставление**. Компьютер запрашивает у сервера ip адрес искомого ресурса по его имени. Получается, мы посылаем серверу имя, в ответ получаем адрес.

Второй вид – **обратное сопоставление**. Это процесс обнаружения доменных имен, сопоставленных с конкретным ip адресом. Отправляем серверу ip – в ответ получаем ассоциированные с этим адресом доменные имена.

## Процесс разрешения имени

Постоянные обращения клиентов к корневым серверам и серверам TLD легко могут их перегрузить. Для того, чтобы ещё больше оптимизировать процесс разрешения имен, существуют механизмы кэширования и локального сопоставителя.

При попытке разрешения имени компьютер, на самом деле, не сразу обратится к root серверу – для начала он проверит собственный кэш. В dns кэше компьютера сохраняются сопоставления dns, которые компьютер получил ранее от dns серверов.

Если проверка ничего не дала, компьютер проверит файл под названием hosts. Это специальный файл для хранения локальных DNS записей.

Если снова ничего - идет запрос к кэширующему серверу. Как и наш компьютер, другие устройства тоже кэшируют информацию о произошедших сопоставлениях. Кэширующим сервером может выступать и наш домашний роутер, и специальный сервер в организации, и глобальный кэширующий сервер.

И если на кэширующем сервере информации об искомом имени не будет, то тогда сам кэширующий сервер обратится к root серверу и далее по цепочке, рассмотренной ранее.

## DNS записи

В базе данных dns сервера содержатся различные типы dns записей.

**А** – Адресная запись, соответствие между именем и IP-адресом. Одна из самых часто используемых записей

**SOA** запись указывает местоположение эталонной записи о домене. Она содержит в себе контактную информацию лица, ответственного за данную зону, время кэширования информации на серверах и данные о взаимодействии DNS. В данной записи определяется время кеширование dns записей нашего домена.

**MX**. Это тип DNS-записи, предназначенный для маршрутизации электронной почты. Благодаря такой записи почтовые сервера других организаций смогут отправлять письма на нашу почту, привязанную к домену. Критически важна для SMTP-протокола, основа маршрутизации почты в Интернете

**NS** запись – она же nameserver. Это запись, содержащая в себе ip адрес сервера, ответственного за сопоставление имен данной dns зоны. Критически важна для функционирования самой системы доменных имён

**PTR** запись – это запись в DNS, позволяющая получить имя узла по его IP-адресу. Так как это действие противоположно стандартному запросу в DNS, его называют обратным. Широко используется для IPv4-адресов в домене in-addr.arpa, для IPv6 — в ip6.arpa
