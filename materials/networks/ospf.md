# OSPF

OSPF (Open Shortest Path First) - протокол динамической маршрутизации.

- Создан IETF в 1988 году
- OSPFv2 это текущая версия для IPv4
- IGP-протокол: используется для передачи информации между маршрутизаторами в пределах одной автономной системы
- Основан на технологии link-state

Отличий у OSPF и ранее рассмотренного RIP на самом деле много. Если RIP ориентировался при создании метрики только на количество переходов между роутерами, то OSPF использует более верную технику – он создает метрику на основе пропускной способности канала. Такая метрика называется cost – цена маршрута. Алгоритм протокола рассчитывает суммарное значение метрики всех соединений через сеть. Меньшее число указывает лучший маршрут. На рисунке видно, что роутеры R1 и R2 соединены через десяти мегабитные интерфейсы. А связь между роутерами R1 и R3, так же как и связь между R2 и R3 проложена с помощью ста мегабитного канала. Если роутеры настроены по протоколу OSPF, то трафик от R1 к R2 пойдет через роутер R3 – а все потому, что канал шире. А значит, можно передать большее количество данных за единицу времени. Если бы мы использовали RIP, то роутеры бы недолго думая направляли бы трафик по ближайшему пути.

**LSDB**

Способность быстро находить наикратчайшие пути в любые сети топологии и знать обо всех возможных связях между роутерами в протоколе ospf достигается за счет построения специальной базы LSDB – Link State Data Base. База LSDB будет содержать в себе информацию о маршрутах. То есть вообще обо всех возможных маршрутах в сети. Как ранее уточнялось, OSPF является внутренним протоколом маршрутизации. И теперь постепенно становится понятно, почему при его то популярности ospf не используют как внешний протокол маршрутизации. Ведь во внешней сети, то есть сети интернет, миллионы роутеров, хранить все маршруты между которыми физически невозможно.

**Процесс OSPF**

Для установки соединения и обмена информацией в рассматриваемом протоколе используется несколько типов пакетов.

**Первый пакет – Hello.** Такой пакет используется, чтобы устанавливать и поддерживать отношения смежности между соседними устройствами. В этом пакете есть два специальных интервала. Первый интервал, он же hello интервал, определяет, как часто будут отправляться hello пакеты соседям. По умолчанию равен десяти секундам. А второй, dead interval, определяет период времени, по прохождению которого, сосед считается недоступным, если от него не приходило Hello пакетов. По умолчанию равен сорока секундам.

**Второй пакет – DataBase Description, DBD.** С его помощью роутеры обмениваются информацией о том, какие сети они знают. В этом пакете нет полного описания сети с метрикой и прочими параметрами – только адреса подсетей.

**Третий пакет – Link-State Request, LSR.** Это запрос на обновление своей базы данных маршрутов.

**Четвертый пакет – Link-State Update, LSU.** Он нужен для отправки детальных данных о маршрутах, которые знает роутер.

**Пятый пакет – Link-State Acknowledgment, LSAck.** Используется для подтверждения получения информации. OSPF не использует транспортный уровень и инкапсулируется в IP протокол, поэтому протоколу нужен свой собственный механизм подтверждения доставки.

Теперь перейдем к процессу создания базы LSBD и к процессу работы протокола OSPF.

Первое, что происходит в сети при запуске процесса OSPF на роутерах – обмен пакетами Hello. TTL таких пакетов равен одному, поэтому hello получат только непосредственно подсоединенные роутеры. Они не смаршрутизируют эту информацию дальше, а аналогичным способом будут рассылать свои hello соседям. Hello- пакеты содержат идентификатор устройства (Router ID), который по сути является адресом одного из интерфейсов маршрутизатора. IP адреса маршрутизирующих устройств в сети не повторяются, что обеспечивает уникальную идентификацию каждого роутера. Ещё такие пакеты содержат информацию об адресе известных роутеру соседях, интервалах hello и Dead, номере зоны, адресах DR и BDR. Последние два параметра рассмотрим чуть дальше, чтобы не нарушать последовательность повествования.

После того, как роутеры обменяются hello-пакетами со своими соседями, они добавят router id соседей в свой список соседей.

Следующих шаг – обмен сообщениями DBD. Эти сообщения содержат описание Link State Data Base. Роутер сообщает своим соседям о том, какие подсети знает сам. В ответ на сообщение DBD роутер, получивший эту информацию, отправляет сообщение подтверждения LSAck.

Теперь роутеры, получив информацию от других про знание подсетей, проверяют, есть ли эти подсети в их базе данных LSDB. Если информации в базе нет, то роутер запрашивает у соседа подробную информацию о неизвестной подсети. Делает он это с помощью запроса Link-State Request.

Как только роутеры обменяются информацией между собой, они перейдут в состояние Full State. По окончании процесса база LSDB у всех роутеров должна быть одинакова.

При этом маршрутизация между известными сетями по прежнему не происходит. Да, LSDB заполнена информацией о всех подсетях, но в таблице маршрутизации пока что ничего нет. Роутеру нужно найти наикратчайшие маршруты до подсетей и только потом поместить эти маршруты в таблицу маршрутизации устройства.

Чтобы выбрать такие маршруты, используется алгоритм Дейкстры. Суть этого алгоритма в нахождении кратчайших путей от одной из вершин графа до всех остальных. А сеть маршрутизации как раз и представляет из себя такой граф.

После того, как алгоритм выберет лучшие пути в графе от каждой из вершин до всех остальных, такие пути поместятся в таблицу маршрутизации и сеть начнет работать. Теперь каждые 10 секунд каждый маршрутизатор будет отправлять Hello-пакеты, чтобы подтвердить, что он работает.

**Зоны OSPF**

Как уточнялось ранее, в hello пакетах присутствует параметр номера зоны. Настало время рассмотреть, для чего он предназначен.

Если взять в пример небольшую сеть маршрутизации, то в ней ospf будет работать довольно быстро – количество связей там невелико, алгоритм просчета графа сработает быстро и роутеры тут же начнут маршрутизировать. Но с увеличением количества связей и устройств растет нагрузка и на процесс ospf – чем больше граф, тем сложнее его считать. При всех своих плюсах OSPF не используется в интернете именно поэтому – никакое устройство в мире не сможет запомнить все разнообразие связей всех маршрутизирующих устройств в глобальной сети, так как их миллионы. Да и граф там так просто не просчитать – топология постоянно изменяется, пересчитывать надо слишком часто. Именно поэтому ospf стал наиболее популярным протоколом маршрутизации только как IGP.

Но даже в локальных сетях могут быть большие топологии, справиться с которыми роутерам не под силу. Чтобы оптимизировать маршрутизацию по ospf, существует параметр зона ospf.

Роутеры как бы делятся на отдельные зоны маршрутизации, внутри которых ospf работает как обычно, создавая LSDB и помещая лучшие маршруты в таблицу маршрутизации. А маршрутизация между зонами происходит по принципам дистанционно-векторных протоколов. Создается роутер, который знает о всех сетях двух смежных зон. При этом внутри каждой из зон все остальные роутеры строят LSDB для сетей, входящих в зону. А сети не из их зоны не обрабатываются алгоритмом дейкстры. В базе создается правило шлюза по умолчанию для всех сетей, не принадлежащих зоне, и роутером по умолчанию для таких сетей станет именно пограничный роутер.

В этом подходе присутствует ограничение – всегда должна существовать нулевая зона, она же зона по умолчанию. Именно эта зона будет отвечать за маршрутизацию между всему другими зонами, являясь ядром сети.

**DR и BDR роутеры в OSPF**

Теперь же рассмотрим оставшиеся термины – роутеры DR и BDR, они же Designated Router и Backup Designated Router.

Это роли для роутеров, созданные с целью определить главу топологии, с которым все остальные роутеры будут синхронизировать свои базы данных LSDB. DR и BDR выбираются на основе router id – у кого этот параметр больше, тот становится DR. Второй по очереди роутер становится BDR.

Информация об изменениях в сети отправляется DR, маршрутизатором обнаружившим это изменение, а DR отвечает за то, чтобы эта информация была отправлена остальным маршрутизаторам сети. Недостатком в схеме работы с DR маршрутизатором является то, что при выходе его из строя должен быть выбран новый DR. Новые отношения соседства должны быть сформированы и, пока базы данных маршрутизаторов не синхронизируются с базой данных нового DR, сеть будет недоступна для пересылки пакетов. Для устранения этого недостатка выбирается BDR.

Каждый маршрутизатор сети устанавливает отношения соседства не только с DR, но и BDR. DR и BDR также устанавливают отношения соседства и между собой. При выходе из строя DR, BDR становится главой топологии и выполняет все его функции. Так как маршрутизаторы сети установили отношения соседства с BDR, то время недоступности сети минимизируется. Обе эти роли уникальны для каждой зоны ospf. Получается, что в каждой зоне будет свой DR и BDR.
