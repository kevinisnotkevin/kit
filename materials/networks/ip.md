# IP

Internet Protocol - маршрутизируемый протокол сетевого уровня стека TCP/IP.

Это один из основных протоколов L3. Как раз в нем определено такое понятие, как адресация. Сейчас в протоколе существует два вида адресации – IPv4 и IPv6. Далее сделаем основной упор на более старый и известный IPv4.

Сетевой уровень модели OSI помогает нам, как пользователям сети, отойти от адресации по mac, предоставив нахождение mac адреса получателя автоматике благодаря широковещательным arp запросам. Не понадобится вбивать длинные mac адреса назначения и находить их, вручную опрашивая устройства. Теперь мы сами можем назначить специальный ip адрес любому устройству и взаимодействовать с получателем именно по ip. Сам ip адрес короче mac, его проще запомнить и использовать.

Не лишним будет и посмотреть, что находится внутри у ip пакета. Заголовки - это сервисная информация, благодаря которой данные могут передаваться по сетям. Различные заголовки характерны и для второго уровня модели OSI, и для третьего, и для остальных.

На третьем уровне содержится сервисная информация, позволяющая роутеру маршрутизировать пакеты по сети, проверять их целостность, отбрасывать в случае закольцовывания сети.

- __IP (Internet Protocol)__ – протокол, который отвечает за передачу пакетов, назначая уникальные IP-адреса для идентификации устройств. Определяет маршрут следования пакетов по узлам сети. Он не определяет факт передачи пакета и не контролирует целостность данных, только осуществляет пересылку. Имеет систему адресации, в качестве которой выступает IPv4 или IPv6.
- IPv4 использует 32-битную систему адресации, состоящую из четырех разделов (255.255.255.255).
- IPv6 использует 128-битную систему адресации, состоящую из восьми блоков по четыре шестнадцатеричных значения (2dab:ffff:0000:0000:01aa:00ff:dddd:2354).
- __Публичный IP-адрес__ – глобально уникальный адрес, назначенный устройству или сети. Позволяет взаимодействовать с другими устройствами в любой точке мира через Интернет. Присваивается IANA, назначается организации или поставщику услуг ISP, может быть статическим или динамическим.
- __Частный IP-адрес__ – адрес, который используется в локальных сетях и не виден в Интернете. Назначается локальными сетевыми устройствами или сетевыми администраторами. Может повторно использоваться в различных сетях, быть динамическим или статическим.
- __Внешний IP-адрес__ – адрес, который применяется в сети Интернет, должен быть уникален и распределяется ICANN.
- __Внутренний IP-адрес__ – адрес, который не маршрутизируется в Интернет, может использоваться без обращения в ICANN и допускается использование одинаковых адресов в разных сетях.

## Классовая адресация

Класс | Первые биты | Диапазон сети | Маска сети
--- | --- | --- | --- |
A | 0 | 1.0.0.0 – 126.0.0.0 | 255.0.0.0
B | 10 | 128.0.0.0 – 191.255.0.0 | 255.255.0.0
C | 110 | 192.0.0.0 – 223.255.255.0 | 255.255.255.0
D | 1110 | 224.0.0.0 – 239.255.255.255 | 255.255.255.255
E | 11110 | 240.0.0.0 – 247.255.255.255 | Зарезервировано

## Зарезервированные IP-адреса

- __10.0.0.0 – 10.255.255.255__: Частные, внутренние, внутрисетевые, локальные, серые, неанонсированные адреса
- __172.16.0.0 – 172.31.255.255__: Частные, внутренние, внутрисетевые, локальные, серые, неанонсированные адреса
- __192.168.0.0 – 192.168.255.255__: Частные, внутренние, внутрисетевые, локальные, серые, неанонсированные адреса
- __127.0.0.0 – 127.255.255.255__: Адреса обратной связи
- __0.0.0.0__: Шлюз по умолчанию
- __255.255.255.255__: Широковещательный адрес всех сетей
- __192.168.191.255__: Идентификатор сети
- __0.0.5.78__: Идентификатор хоста сети, которой он принадлежит
- __255.255.245.78__: Широковещательный адрес всем узлам текущей сети

## IPv4

Сам протокол IP разрабатывался довольно давно, а первой наиболее широко используемой версией протокола стала четвертая, отсюда и название. Рассмотрим IPv4 детально.

Для компьютера вся информация представляет собой набор нулей и единиц. Так же и в сетевых технологиях - наш трафик, передаваемый по проводам, это те же самые нули и единицы. И, как мы разобрали ранее, трафик на уровне L3 состоит из полезных данных и заголовков пакета. Каждый из заголовков можно интерпретировать как последовательность нулей и единиц, в том числе адрес отправителя и получателя. При этом количество нулей и единиц в записи ip адреса будет соответствовать его весу в битах, так как бит – минимальная единица счисления в мире информационных технологий.

В каждой части по 8 бит, такая часть называется октет. Каждый октет записывают в десятичном формате, и форма записи IP адреса следующая: четыре октета разделенных точкой (0.0.0.0). С таким видом деления адресов людям гораздо удобнее работать, чем с записью в двоичной форме длиной в 32 бита.

В свою очередь приходим к тому, что максимальное число, где скрывается ровно двести пятьдесят шесть комбинаций – это число дести пятьдесят пять. Вот и получается диапазон от нуля до двухсот пятидесяти пяти, которым можно описать один октет в ip адресе. Остальные октеты составляются по аналогии. Минимально возможный ip адрес – четыре нуля. Максимально возможный ip адрес четыре числа двести пятьдесят пять

В сетях IPv4 всего существует три типа IP-адресов, каждый тип IP-адреса ориентирован на определенную задачу, это следующие IP-адреса:
- Сетевой адрес : IP-адрес, к которому относится сеть или подсеть
- Адрес хоста : IP-адреса, назначенные конечным компьютерам в сети
- Широковещательный адрес : специальный адрес, он используется для отправки данных на все хосты в сети

Как по IP адресу узнать, где адрес сети, а где адрес хоста? Для этого используется Маска подсети. Это число похоже на ip адрес, аналогично состоит из четырех октетов и весит тридцать два бита. Маска подсети нужна, чтобы определить размерность этой самой сети. Когда мы определяем подсеть, с помощью маски сразу можно вычислить общее количество ip адресов в данной сети, тот самый диапазон. Но есть важное замечание - в любой сети присутствует два специальных ip адреса, которые не могут быть использованы в качестве адреса конечного компьютера. Эта адреса – первый и последний в подсети. Первый адрес в подсети используется как идентификатор подсети, или же название подсети. Последний адрес используется как адрес широковещательной рассылки. Если мы отправим трафик в сеть и укажем в качестве получателя последний адрес в нашей подсети – то сетевые устройства разошлют такой трафик всем работающим устройствам в рамках этой подсети.

**Недостатки IPv4**
- Проблема масштабируемости
    - сложность массового изменения IP-адресов
    - недостаточность объема 32-битного адресного пространства
    - относительная сложность обработки заголовков пакетов IPv4
    - сложность агрегирования маршрутов, разрастание таблиц маршрутизации
- Отсутствие некоторых обязательных механизмов, а именно:
    - механизмов информационной безопасности
    - средств поддержки классов обслуживания

## IPv6

IPv6 (Internet Protocol version 6) - это последняя версия Интернет-протокола, используемая для передачи данных в Интернете между устройствами. IPv6 является протоколом следующего поколения после IPv4, который вышел в конце 1970-х годов. IPv6 использует 128-битные адреса вместо 32-битных адресов, используемых в IPv4. Это позволяет создать огромное количество уникальных IP-адресов, что является необходимым для увеличения числа устройств, подключенных к Интернету, и для создания новых сервисов в Интернете. IPv6 также обеспечивает более безопасные, надежные и эффективные соединения в Интернете.

Сейчас, когда IP и IPv6 протоколы работают вместе, это приводит к существованию фактически двух параллельных сетей. Например, роутер моего Интернет-провайдера поддерживает IPv6 и IP. Если я обращаюсь к сайту, у которого есть IPv6 адрес (большинство сайтов), то мой запрос и ответ идёт по сетям (узлам) с поддержкой IPv6. Если я обращусь к сайту, у которого только IP адрес, то мой запрос и ответ на него может пойти по другому маршруту.

При анализе сети, допустим, с помощью Wireshark или tcpdump можно пропустить половину или даже больше трафика, если забыть про IPv6! То есть в качестве фильтра отображения пакетов в Wireshark вы введёте обычный фильтр для показа трафика IP протокола. Но если ввести фильтр ipv6, то картина изменится кардинально, окажется, что компьютер подключается ещё и к совершенно другим хостам.

При анализе сети, при настройке фильтров отображения по IP, при выполнении атак (например, ARP и DNS спуфинг в локальной сети), нужно помнить про IPv6.

IP и IPv6 это две параллельные сети, которые не особо связаны друг с другом (хотя одно и то же оборудование может поддерживать работу с обоими протоколами). В результате при настройке сети, например, файервола, нужно отдельно сделать настройки для протокола IP, а затем делать такую же настройку IPv6. Поскольку это разные сети, есть шанс, что системный администратор настроил их по-разному, что даёт лазейки для выполнения атак или обхода ограничений с использованием IPv6.

IPv6 адреса могут пригодиться при исследовании локальных сетей Интернет-провайдеров, стоит попробовать использовать IPv6 для обхода Captive Portal (перехватывающих порталов) и других ограничений сети, про IPv6 нужно помнить при анализе трафика на своём компьютере и в локальных сетях, либо наоборот для увеличения скрытности своего пребывания (в надежде, что в настройках логирования трафика не упомянут IPv6 или что геолокация по IPv6 сейчас в зачаточном состоянии (по крайней мере, в публичных базах данных)).

В ядра Debian включена обработка IPv6 внутри самого ядра (за исключением нескольких архитектур устройств, в которых скомпилирован модуль, называемый ipv6). Основные инструменты, такие как ping и traceroute, имеют их IPv6 эквивалентов, называемых ping6 и traceroute6, которые доступны в пакетах с соответствующими именами iputils-ping и iputils-tracepath

Сеть IPv6 настраивается аналогично тому, как это делается в IPv4, в файле /etc/network/interfaces. Но если вы хотите, чтобы сеть была доступна глобально, вы должны убедиться, что имеете IPv6-совместимый маршрутизатор, перенаправляющий трафик в глобальную IPv6 сеть.

**Формат заголовка IPv6**:
- Первое поле в заголовке протокола IPv6 также, как и в заголовке протокола IPv4, это номер версии 4 для IPv4 и 6 для IPv6
- Затем идет поле класс трафика, оно необходимо для реализации качества обслуживания. Самый простой вариант, разбиение трафика на два класса, обычный и важный. Маршрутизаторы, которые поддерживают обеспечение качества обслуживания, передают важный трафик быстрее используя специальную выделенную очередь, также возможны и другие варианты использования классов трафиков
- Следующее поле в заголовке IPv6 это метка потока, это поле используется для того чтобы объединить преимущества сетей коммутации пакетов с сетями с коммутацией каналов. У набора пакетов, которые передаются от одного отправителя к одному получателю, и требует определенного типа обслуживания, устанавливается одна и та же метка. Маршрутизаторы, которые поддерживают работу в таком режиме, обрабатывают пакет на основе метки, что гораздо быстрее
- Следующее поле это длина полезной нагрузки, в отличии от протокола IPv4, где в подобном поле указывается общая длина пакета, здесь указывается только размер данных без размера заголовка
- Затем идет поле следующий заголовок, которое необходимо, если используются дополнительные заголовки, в этом поле указывается тип первого дополнительного заголовка
- В IPv6 поле время жизни пакета переименовали в максимальное число транзитных участков, потому что на практике вместо времени жизни, даже в протоколе IPv4, указывается максимальное количество маршрутизаторов через которое может пройти пакет, перед тем как он будет отброшен

По сравнению с заголовком протокола IPv4 в протоколе IPv6 нет полей, которые отвечают за фрагментацию, и за контрольную сумму. Расчет контрольной суммы создает большую нагрузку на маршрутизаторы, однако эта операция часто является излишней, так как контрольная сумма рассчитывается на канальном уровне, и на сетевом уровне. Поэтому от расчета контрольных сумм в протоколе IPv6, было решено отказаться.

Также было принято решение отказаться от фрагментации, потому что она так же как и расчет контрольной суммы, создает большую нагрузку на маршрутизаторы. На практике во многих сетях сейчас используется один и тот же размер пакета, соответствующий размеру кадра Ethernet 1500 байт, поэтому фрагментация часто является не нужной. Если все же где-то по пути пакета встретиться сеть с меньшим максимальным размером пакета, то вместо фрагментации необходимо использовать технологию Path MTU Discovery.

Также как и заголовок протокола IPv4,  заголовок протокола IPv6 состоит из двух частей обязательный и необязательной. В необязательные части может быть несколько дополнительных заголовков.

В IPv6 могут быть дополнительные заголовки следующих типов:
- Заголовок параметры маршрутизации - содержит данные, которые необходимы маршрутизаторам для того, чтобы корректно обрабатывать пакеты
- Заголовок параметры получателя - содержит данные, которые необходимы для обработки пакета на стороне получателя
- Дополнительный заголовок маршрутизация - содержит список маршрутизаторов, через который пакет должен обязательно пройти

**Преимущества IPv6**

IPv6 во многом превосходит IPv4 и имеет ряд очевидных преимуществ. Во-первых, более широкое адресное пространство, которое уже даёт массу преимуществ:
- Адресов хватит с запасом на многие десятилетия вперед. А значит не надо будет париться над обходными решениями, и можно будет полностью избавиться от NAT
- Каждое из устройств подключенных к сети сможет получить свой “белый” IP адрес, что уже хорошо
- По настоящему хорошо заработают peer-to-peer сети, т.е. сети в которых устройства могут общаться между собой напрямую

Во-вторых, в новом протоколе упростили и причесали:
- Теперь адреса можно создавать и настраивать автоматически, благодаря технологии SLAAC - Stateless Address Autoconfiguration. А это существенно упрощает администрирования сети
- Также в IPv6 существенно упростили заголовки пакетов, которые стало проще и быстрее обрабатывать
- Ну и добавили обязательную поддержку шифрования трафика IPsec

**Проблемы IPv6**

Начнем с того, что для провайдеров обновляться на IPv6 очень дорого. Нужно закупать новое оборудование, перенастраивать его и прочее. А зачем это делать, если итак всё работает?

Во-вторых, на текущий момент всё еще очень мало понимания, как настраивать IPv6. И даже у больших профессионалов с многолетним опытом возникают сложности, чего уж говорить о рядовых пользователях.

В-третьих, IPv6 не имеет обратной совместимости с IPv4. А это значит, что на время перехода нужно работать в режиме дуал-стек, то есть поддерживать и то, и то. А это фактически двойная работа по настройке, гарантированное увеличение косяков и гарантированное уменьшение безопасности. То есть параллельная работа IPv4 и IPv6 в 2 раза увеличивает поверхность атаки. Так как нужно защищать и то, и то.

Тем не менее все специалисты сходятся во мнении, что переход на IPv6 неизбежен, это дело времени. И когда этот переход состоится, мы наконец то увидим, как на самом деле должен работать интернет.

### Структура IPv6 адреса

```
::1
2a02:6b8:a::a
2a02:f680:1:1100::3d60
2604:a880:800:c1::2ae:d001
2001:db8:11a3:9d7:1f34:8a2e:7a0:765d
```
- Примеры правильных IPv6 адресов

Адреса IPv6 в полной форме отображаются как восемь четырёхзначных шестнадцатеричных чисел (то есть восемь групп по четыре символа), разделённых двоеточием.

Шестнадцатеричные числа записываются с помощью цифр от 0 до 9 и с помощью букв от a до f.

Полная запись может быть сокращена используя несколько методов нотации, к примеру, адрес 2001:0db8:0000:0000:0000:8a2e:0370:7334 равнозначен адресу 2001:db8::8a2e:370:7334.

У IPv6 адресов в каждом сегменте 16 бит информации (hextet или hexadectet). Всего 8 сегментов по 16 бит информации, получается, что для записи IPv6 адресов используется 8*16=128 бит.

Как уже было сказано выше, в IPv6 адресах числа в группах записываются в виде шестнадцатеричных чисел, а не в виде десятеричных, как в IP. Кстати, если запись была бы в виде десятичных чисел, то в каждом сегменте были бы числа от 0 до 65535 (это 216). Что касается шестнадцатеричных чисел, то для записи 16 бит информации нужно число длиной до четырёх символов, поэтому получается, то размер раздела составляет 4 символа, но может быть меньше, поскольку нули в начале числа писать необязательно. То есть если там должно быть число 00a1, то можно записать просто a1 — это первый способ сокращения записи IPv6 адресов.

_Если в группе число равно 0 (то есть четыре нуля), то записывается один ноль._

Если групп с нулями несколько подряд, то независимо от количества нулей вся эта группа записывается как идущие два подряд двоеточия (::). Последнее сокращение можно использовать в одном IPv6 адресе только один раз, даже если имеется несколько групп с нулями. Если групп с нулями несколько, то заменяется только самая продолжительная из них. Если имеется две группы с нулями одинаковой длины, то заменяется та, которая идёт первой, то есть более левая.

Пример использования этих правил:

Начальный адрес: `2001:0db8:0000:0000:0000:ff00:0042:8329`

После удаления всех начальных нулей в каждой группе: `2001:db8:0:0:0:ff00:42:8329`
После пропуска последовательных сегментов с нулями: `2001:db8::ff00:42:8329`
Петлевой адрес `0000:0000:0000:0000:0000:0000:0000:0001` используя правила сокращения можно сократить до `::1`

Вернёмся к адресам из примеров выше: `::1`
Как мы уже выяснили, это петлевой адрес: `0000:0000:0000:0000:0000:0000:0000:0001`.

`2a02:6b8:a::a` - Здесь пропущено несколько секций с последовательными нулями. Сколько именно? Это можно узнать исходя из следующего правила: всего должно быть 8 секций, а имеется только 4, значит, пропущено 4 секции, то есть в полном виде число должно выглядеть так: `2a02:6b8:a:0:0:0:0:a`

Следующий пример: `2a02:f680:1:1100::3d60`
В этом адресе 5 сегментов, а должно быть 8, значит пропущено 3, запись адреса в полном виде: `2a02:f680:1:1100:0:0:0:3d60`

`2604:a880:800:c1::2ae:d001` - В этом адресе 6 сегментов, а должно быть 8, следовательно, полная запись этого адреса: `2604:a880:800:c1:0:0:2ae:d001`

### Зарезервированные IPv6 адреса

Рассмотрим диапазоны IPv6 адресов для целевого назначения, чтобы мы могли сразу отфильтровывать их из многочисленных IPv6 адресов сетевых интерфейсов.

У IP также есть зарезервированные диапазоны адресов: 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16, 127.0.0.0/8, 100.64.0.0/10 и ещё несколько.

![](materials/images/networks/ipv6_reserve.png)
- Специальные диапазоны IPv6 адресов

### Глобальные IPv6

Соответствуют публичным IPv4-адресам. Могут находиться в любом не занятом диапазоне. В настоящее время региональные интернет-регистраторы распределяют блок адресов 2000::/3 (с 2000:: по 3FFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF).

Это означает, что глобальными сейчас являются только IPv6 адреса, которые начинаются на «2» или на «3».

У одного сетевого интерфейса может быть много IPv6 адресов, по умолчанию. Зачем так много IPv6 одному интерфейсу? Каждый интерфейс IPv6 имеет локальный IP-адрес. Если интерфейс также может обмениваться данными с более крупной сетью (например, через Интернет), он также имеет глобальный адрес. Это как минимум два адреса. И если хост находится за многосетевым подключением к Интернету, он, вероятно, имеет ещё больше адресов.

## Аренда IP адресов. IANA. Распределение IP адресов по странам

IANA - организация, которая занимается как распределением ip адресов по миру, так и номеров автономных систем. Занимается скорее в организационном плане, так как фактически арендовать адрес или номер AS можно у RIR и LIR.

RIR (Regional Internet Registry) это региональные организации, каждая из которых отвечает за определённую часть планеты (Для Европы и России – это RIPE NCC)

А LIR (Local Internet Registry) может стать почти любая желающая организация при наличии необходимых документов. Это более локальные организации, созданные для снятия нагрузки с RIR.

Когда автономные системы только появились, максимальный номер AS был 65535. Позже этот стандарт был доработан. Сейчас этих номеров столько же, сколько существует ip адресов версии 4.

Номер AS привязывается к конкретной подсети, арендованной у LIR. Нельзя стать AS, если вы владеете блоком ip адресов меньшим, чем 256, то есть по маске 24. При этом, если организация стала автономной системой, она может стать и провайдером – выдавать в аренду ip адреса и маршрутизировать своих клиентов в глобальную сеть интернет.

