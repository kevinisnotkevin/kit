# IP

Internet Protocol - маршрутизируемый протокол сетевого уровня стека TCP/IP.

Это один из основных протоколов L3. Как раз в нем определено такое понятие, как адресация. Сейчас в протоколе существует два вида адресации – IPv4 и IPv6. Далее сделаем основной упор на более старый и известный IPv4.

Сетевой уровень модели OSI помогает нам, как пользователям сети, отойти от адресации по mac, предоставив нахождение mac адреса получателя автоматике благодаря широковещательным arp запросам. Не понадобится вбивать длинные mac адреса назначения и находить их, вручную опрашивая устройства. Теперь мы сами можем назначить специальный ip адрес любому устройству и взаимодействовать с получателем именно по ip. Сам ip адрес короче mac, его проще запомнить и использовать.

Не лишним будет и посмотреть, что находится внутри у ip пакета. Заголовки - это сервисная информация, благодаря которой данные могут передаваться по сетям. Различные заголовки характерны и для второго уровня модели OSI, и для третьего, и для остальных.

На третьем уровне содержится сервисная информация, позволяющая роутеру маршрутизировать пакеты по сети, проверять их целостность, отбрасывать в случае закольцовывания сети.

- __IP (Internet Protocol)__ – протокол, который отвечает за передачу пакетов, назначая уникальные IP-адреса для идентификации устройств. Определяет маршрут следования пакетов по узлам сети. Он не определяет факт передачи пакета и не контролирует целостность данных, только осуществляет пересылку. Имеет систему адресации, в качестве которой выступает IPv4 или IPv6.
- IPv4 использует 32-битную систему адресации, состоящую из четырех разделов (255.255.255.255).
- IPv6 использует 128-битную систему адресации, состоящую из восьми блоков по четыре шестнадцатеричных значения (2dab:ffff:0000:0000:01aa:00ff:dddd:2354).
- __Публичный IP-адрес__ – глобально уникальный адрес, назначенный устройству или сети. Позволяет взаимодействовать с другими устройствами в любой точке мира через Интернет. Присваивается IANA, назначается организации или поставщику услуг ISP, может быть статическим или динамическим.
- __Частный IP-адрес__ – адрес, который используется в локальных сетях и не виден в Интернете. Назначается локальными сетевыми устройствами или сетевыми администраторами. Может повторно использоваться в различных сетях, быть динамическим или статическим.
- __Внешний IP-адрес__ – адрес, который применяется в сети Интернет, должен быть уникален и распределяется ICANN.
- __Внутренний IP-адрес__ – адрес, который не маршрутизируется в Интернет, может использоваться без обращения в ICANN и допускается использование одинаковых адресов в разных сетях.

# Классовая адресация

Класс | Первые биты | Диапазон сети | Маска сети
--- | --- | --- | --- |
A | 0 | 1.0.0.0 – 126.0.0.0 | 255.0.0.0
B | 10 | 128.0.0.0 – 191.255.0.0 | 255.255.0.0
C | 110 | 192.0.0.0 – 223.255.255.0 | 255.255.255.0
D | 1110 | 224.0.0.0 – 239.255.255.255 | 255.255.255.255
E | 11110 | 240.0.0.0 – 247.255.255.255 | Зарезервировано

# Зарезервированные IP-адреса

- __10.0.0.0 – 10.255.255.255__: Частные, внутренние, внутрисетевые, локальные, серые, неанонсированные адреса
- __172.16.0.0 – 172.31.255.255__: Частные, внутренние, внутрисетевые, локальные, серые, неанонсированные адреса
- __192.168.0.0 – 192.168.255.255__: Частные, внутренние, внутрисетевые, локальные, серые, неанонсированные адреса
- __127.0.0.0 – 127.255.255.255__: Адреса обратной связи
- __0.0.0.0__: Шлюз по умолчанию
- __255.255.255.255__: Широковещательный адрес всех сетей
- __192.168.191.255__: Идентификатор сети
- __0.0.5.78__: Идентификатор хоста сети, которой он принадлежит
- __255.255.245.78__: Широковещательный адрес всем узлам текущей сети

# IPv4

Сам протокол IP разрабатывался довольно давно, а первой наиболее широко используемой версией протокола стала четвертая, отсюда и название. Рассмотрим IPv4 детально.

Для компьютера вся информация представляет собой набор нулей и единиц. Так же и в сетевых технологиях - наш трафик, передаваемый по проводам, это те же самые нули и единицы. И, как мы разобрали ранее, трафик на уровне L3 состоит из полезных данных и заголовков пакета. Каждый из заголовков можно интерпретировать как последовательность нулей и единиц, в том числе адрес отправителя и получателя. При этом количество нулей и единиц в записи ip адреса будет соответствовать его весу в битах, так как бит – минимальная единица счисления в мире информационных технологий.

В каждой части по 8 бит, такая часть называется октет. Каждый октет записывают в десятичном формате, и форма записи IP адреса следующая: четыре октета разделенных точкой (0.0.0.0). С таким видом деления адресов людям гораздо удобнее работать, чем с записью в двоичной форме длиной в 32 бита.

В свою очередь приходим к тому, что максимальное число, где скрывается ровно двести пятьдесят шесть комбинаций – это число дести пятьдесят пять. Вот и получается диапазон от нуля до двухсот пятидесяти пяти, которым можно описать один октет в ip адресе. Остальные октеты составляются по аналогии. Минимально возможный ip адрес – четыре нуля. Максимально возможный ip адрес четыре числа двести пятьдесят пять

В сетях IPv4 всего существует три типа IP-адресов, каждый тип IP-адреса ориентирован на определенную задачу, это следующие IP-адреса:
- Сетевой адрес : IP-адрес, к которому относится сеть или подсеть
- Адрес хоста : IP-адреса, назначенные конечным компьютерам в сети
- Широковещательный адрес : специальный адрес, он используется для отправки данных на все хосты в сети

Как по IP адресу узнать, где адрес сети, а где адрес хоста? Для этого используется Маска подсети. Это число похоже на ip адрес, аналогично состоит из четырех октетов и весит тридцать два бита. Маска подсети нужна, чтобы определить размерность этой самой сети. Когда мы определяем подсеть, с помощью маски сразу можно вычислить общее количество ip адресов в данной сети, тот самый диапазон. Но есть важное замечание - в любой сети присутствует два специальных ip адреса, которые не могут быть использованы в качестве адреса конечного компьютера. Эта адреса – первый и последний в подсети. Первый адрес в подсети используется как идентификатор подсети, или же название подсети. Последний адрес используется как адрес широковещательной рассылки. Если мы отправим трафик в сеть и укажем в качестве получателя последний адрес в нашей подсети – то сетевые устройства разошлют такой трафик всем работающим устройствам в рамках этой подсети.

**Недостатки IPv4**
- Проблема масштабируемости
    - сложность массового изменения IP-адресов
    - недостаточность объема 32-битного адресного пространства
    - относительная сложность обработки заголовков пакетов IPv4
    - сложность агрегирования маршрутов, разрастание таблиц маршрутизации
- Отсутствие некоторых обязательных механизмов, а именно:
    - механизмов информационной безопасности
    - средств поддержки классов обслуживания

# IPv6

IPv6 - новая версия интернет-протокола, призванная решить проблемы, с которыми столкнулась версия IPv4, за счёт ряда принципиальных изменений.

Первое и главное отличие: IP-адреса в новом протоколе стали длиной 128 бит. Это дает 2 в степени 128 вариантов уникальных адресов.

Соответственно, с изменением длины адреса, поменялся и его формат. Новый IP-адрес стал выглядеть немного сложнее.

IPv6 адрес теперь состоит из 8 групп шестнадцатеричных чисел, разделенных двоеточиями.

**Формат заголовка IPv6**:
- Первое поле в заголовке протокола IPv6 также, как и в заголовке протокола IPv4, это номер версии 4 для IPv4 и 6 для IPv6
- Затем идет поле класс трафика, оно необходимо для реализации качества обслуживания. Самый простой вариант, разбиение трафика на два класса, обычный и важный. Маршрутизаторы, которые поддерживают обеспечение качества обслуживания, передают важный трафик быстрее используя специальную выделенную очередь, также возможны и другие варианты использования классов трафиков
- Следующее поле в заголовке IPv6 это метка потока, это поле используется для того чтобы объединить преимущества сетей коммутации пакетов с сетями с коммутацией каналов. У набора пакетов, которые передаются от одного отправителя к одному получателю, и требует определенного типа обслуживания, устанавливается одна и та же метка. Маршрутизаторы, которые поддерживают работу в таком режиме, обрабатывают пакет на основе метки, что гораздо быстрее
- Следующее поле это длина полезной нагрузки, в отличии от протокола IPv4, где в подобном поле указывается общая длина пакета, здесь указывается только размер данных без размера заголовка
- Затем идет поле следующий заголовок, которое необходимо, если используются дополнительные заголовки, в этом поле указывается тип первого дополнительного заголовка
- В IPv6 поле время жизни пакета переименовали в максимальное число транзитных участков, потому что на практике вместо времени жизни, даже в протоколе IPv4, указывается максимальное количество маршрутизаторов через которое может пройти пакет, перед тем как он будет отброшен

По сравнению с заголовком протокола IPv4 в протоколе IPv6 нет полей, которые отвечают за фрагментацию, и за контрольную сумму. Расчет контрольной суммы создает большую нагрузку на маршрутизаторы, однако эта операция часто является излишней, так как контрольная сумма рассчитывается на канальном уровне, и на сетевом уровне. Поэтому от расчета контрольных сумм в протоколе IPv6, было решено отказаться.

Также было принято решение отказаться от фрагментации, потому что она так же как и расчет контрольной суммы, создает большую нагрузку на маршрутизаторы. На практике во многих сетях сейчас используется один и тот же размер пакета, соответствующий размеру кадра Ethernet 1500 байт, поэтому фрагментация часто является не нужной. Если все же где-то по пути пакета встретиться сеть с меньшим максимальным размером пакета, то вместо фрагментации необходимо использовать технологию Path MTU Discovery.

Также как и заголовок протокола IPv4,  заголовок протокола IPv6 состоит из двух частей обязательный и необязательной. В необязательные части может быть несколько дополнительных заголовков.

В IPv6 могут быть дополнительные заголовки следующих типов:
- Заголовок параметры маршрутизации - содержит данные, которые необходимы маршрутизаторам для того, чтобы корректно обрабатывать пакеты
- Заголовок параметры получателя - содержит данные, которые необходимы для обработки пакета на стороне получателя
- Дополнительный заголовок маршрутизация - содержит список маршрутизаторов, через который пакет должен обязательно пройти

**Преимущества IPv6**

IPv6 во многом превосходит IPv4 и имеет ряд очевидных преимуществ. Во-первых, более широкое адресное пространство, которое уже даёт массу преимуществ:
- Адресов хватит с запасом на многие десятилетия вперед. А значит не надо будет париться над обходными решениями, и можно будет полностью избавиться от NAT
- Каждое из устройств подключенных к сети сможет получить свой “белый” IP адрес, что уже хорошо
- По настоящему хорошо заработают peer-to-peer сети, т.е. сети в которых устройства могут общаться между собой напрямую

Во-вторых, в новом протоколе упростили и причесали:
- Теперь адреса можно создавать и настраивать автоматически, благодаря технологии SLAAC - Stateless Address Autoconfiguration. А это существенно упрощает администрирования сети
- Также в IPv6 существенно упростили заголовки пакетов, которые стало проще и быстрее обрабатывать
- Ну и добавили обязательную поддержку шифрования трафика IPsec

**Проблемы IPv6**

Начнем с того, что для провайдеров обновляться на IPv6 очень дорого. Нужно закупать новое оборудование, перенастраивать его и прочее. А зачем это делать, если итак всё работает?

Во-вторых, на текущий момент всё еще очень мало понимания, как настраивать IPv6. И даже у больших профессионалов с многолетним опытом возникают сложности, чего уж говорить о рядовых пользователях.

В-третьих, IPv6 не имеет обратной совместимости с IPv4. А это значит, что на время перехода нужно работать в режиме дуал-стек, то есть поддерживать и то, и то. А это фактически двойная работа по настройке, гарантированное увеличение косяков и гарантированное уменьшение безопасности. То есть параллельная работа IPv4 и IPv6 в 2 раза увеличивает поверхность атаки. Так как нужно защищать и то, и то.

Тем не менее все специалисты сходятся во мнении, что переход на IPv6 неизбежен, это дело времени. И когда этот переход состоится, мы наконец то увидим, как на самом деле должен работать интернет.

# Аренда IP адресов. IANA. Распределение IP адресов по странам

IANA - организация, которая занимается как распределением ip адресов по миру, так и номеров автономных систем. Занимается скорее в организационном плане, так как фактически арендовать адрес или номер AS можно у RIR и LIR.

RIR (Regional Internet Registry) это региональные организации, каждая из которых отвечает за определённую часть планеты (Для Европы и России – это RIPE NCC)

А LIR (Local Internet Registry) может стать почти любая желающая организация при наличии необходимых документов. Это более локальные организации, созданные для снятия нагрузки с RIR.

Когда автономные системы только появились, максимальный номер AS был 65535. Позже этот стандарт был доработан. Сейчас этих номеров столько же, сколько существует ip адресов версии 4.

Номер AS привязывается к конкретной подсети, арендованной у LIR. Нельзя стать AS, если вы владеете блоком ip адресов меньшим, чем 256, то есть по маске 24. При этом, если организация стала автономной системой, она может стать и провайдером – выдавать в аренду ip адреса и маршрутизировать своих клиентов в глобальную сеть интернет.

