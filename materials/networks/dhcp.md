# DHCP

DHCP (Dynamic Host Configuration Protocol) – протокол, который назначает IP-адреса компьютерам в сети автоматически, требует создания инфраструктуры (DHCP-сервер), ведет таблицу выделенных IP-адресов, чтобы избежать дублирования. Может использоваться для атаки MITM. 

Именно благодаря ему на компьютере при включении уже есть ip адрес, с помощью которого компьютер взаимодействует с другими устройствами в сети. Кроме ip адреса такой протокол настраивает весь сетевой стек компьютера, а в некоторых случаях и сервера. Здесь под сетевым стеком подразумеваются настройки, присущие современному стеку протоколов TCP/IP - это маска подсети, адрес роутера по умолчанию, адреса DNS серверов, серверов синхронизации времени и многих других.

IP-адрес выделяется клиентам на ограниченное время. После окончания времени аренды IP-адрес освобождается. Клиент может продлить использование IP-адреса после половины срока аренды по сокращенной процедуре получения IP-адреса.

## Уязвимости DHCP

DHCP имеет свои уязвимости. Основная заключается в четырех шагах, необходимых для получения IP.

Процесс DORA подразумевает рассылку сообщений широковещательного типа, когда первый откликнувшийся DHCP-сервер получает возможность предложить IP из своей области.

Если злоумышленник сможет использовать свой сервер, который даст самый быстрый ответ клиенту, то у него откроется возможность получить контроль над действиями пользователя в сети и нанести существенный ущерб.

## Распределение IP-адресов

Протокол DHCP предоставляет три способа распределения IP-адресов:

**Ручное распределение.** При этом способе сетевой администратор сопоставляет МАС адресу каждого клиентского компьютера определённый IP-адрес. Фактически данный способ распределения адресов отличается от ручной настройки каждого компьютера лишь тем, что сведения об адресах хранятся на сервере DHCP, и потому их проще изменять при необходимости.

**Автоматическое распределение**. При данном способе каждому компьютеру на постоянное использование выделяется произвольный свободный IP-адрес из определённого администратором диапазона.

**Динамическое распределение.** Этот способ аналогичен автоматическому распределению за исключением того, что адрес выдаётся компьютеру не на постоянное пользование, а на определённый срок. Это называется арендой адреса. По истечении срока аренды IP-адрес вновь считается свободным, и клиент обязан запросить новый. Кроме того, клиент сам может отказаться от полученного адреса.

## Опции

Помимо IP-адреса, DHCP также может сообщать клиенту дополнительные параметры, необходимые для нормальной работы в сети. Эти параметры называются опциями DHCP.

- Опция 1 - Маска подсети, из которой получен адрес
- Опция 3 - Список IP-адресов шлюзов по умолчанию
- Опция 6 - Список IP-адресов серверов DNS
- Опция 12 - Имя хоста клиента
- Опция 51 - Время выделения для возвращаемого адреса
- Опция 55 - Список запрашиваемых опций
- Опция 82 - Информация об агенте ретрансляции

## Принцип работы

Шаг первый – discover. На этом шаге клиент ищет dhcp сервера в сети. Да, DHCP серверов может быть несколько и клиент изначально не владеет информацией ни об одном из них. Такой трафик является широковещательным, его получают все узлы в сети.

Шаг второй – offer. В ответ на запрос клиента сервер подготавливает всю необходимую информацию: как ip адрес, так и остальные параметры конфигурации, включая время аренды адреса. Такой трафик направляется от сервера только к запросившему клиенту, другим компьютерам в сети эта информация ни к чему. При этом такой ответ отправит каждый dhcp сервер, работающий в сети и получивший discover. Если серверов несколько, то клиент получит несколько предложений об аренде.

Шаг третий – request. Клиент должен подтвердить, что предложенная dhcp сервером конфигурация его устраивает и он готов арендовать ip адрес. Клиент ответит серверу только на один request, который придет к нему первым, остальные офферы отбросит – несколько разных адресов клиенту не нужно.

Шаг четвертый – Acknowledgement. Сервер, получивший request, подтвердит, что он сохранил в своей базе данных информацию о клиенте (это, напомню, mac адрес клиента). После отправки ответа процесс dhcp считается завершенным. Таймер аренды адреса активен, компьютер применил полученную конфигурацию для своего сетевого адаптера и готов работать в сети.

**Дополнительные сообщения DHCP**

**Сообщение отказа аренды**, которое посылает компьютер в случае нахождения конфликта ip адресов. Конфликт происходит, если у какого либо другого компьютера уже настроен адрес, полученный компьютером от dhcp сервером. Компьютер просто рассылает широковещательное arp сообщение, где интересуется, у кого ещё есть ip адрес, который наш компьютер получил от DHCP. Если ответ на arp будет получен, то компьютер рассылает широковещательное сообщение DHCPDECLINE, в котором говорится, что выданный dhcp сервером адрес уже присутствует в сети. После отправки такого сообщение компьютер запускает процесс DORA заново до тех пор, пока не получит уникальный адрес в сети.

**Отмена подтверждения аренды**. Данный ответ генерирует dhcp сервер в том случае, если компьютер запрашивает обновление для ip адреса, уже зарезервированного под другой компьютер в сети. Ещё такое происходит, если компьютер переместился в другую сеть и опять же пытается обновить время аренды для адреса, арендованного ранее. Если компьютер получает от dhcp сервера подобное сообщение, то он должен повторить процедуру аренды с нуля.

**Освобождение**. Клиент отправляет это сообщение, чтобы уведомить сервер об освобождении занимаемого IP. Иными словами, это досрочное окончание аренды.

**Информация.** Этим сообщением клиент запрашивает у сервера локальные настройки. Отправляется, когда клиент уже получил IP, но для правильной работы ему требуется конфигурация сети. Сервер информирует клиента ответным сообщением с указанием всех запрошенных опций.

## Время аренды

**Время аренды**

DHCP сервер выдает адреса лишь на время. Для контроля за временем аренды нужен параметр «время аренды»

**Процесс обновления аренды**

Когда время аренды подходит к концу, компьютер запрашивает у сервера обновление аренды

**Таймеры обновления**

По умолчанию это происходит, когда проходит половина времени аренды. Если обновить аренду не удалось, компьютер запрашивает обновление через половину от оставшегося времени

Если не контролировать выдачу ip адресов по времени, то в обозримом будущем dhcp сервер просто раздаст все свои адреса клиентам и исчерпает пул адресов. Чтобы вечно не хранить запись об аренде клиентом, которому адрес уже не нужен, существует параметр время аренды. Вместе с другими параметрами сетевого стека клиент получает и время, на которое сервер дал ему в аренду адрес. Если клиент использует адрес, то через половину от полученного таймера к серверу придет запрос на обновление аренды. Так сервер будет отслеживать, что все выданные адреса нужны компьютерам. Если компьютер не выходит на связь, то его аренду ip адреса по истечению таймера можно прервать.

Так как протокол DHCP использует UDP, то существует вероятность, что запрос клиента на обновление аренды может не дойти до сервера. Бывают и такие моменты, что dhcp сервер перегружен запросами и физически не может ответить всем. Поэтому изначально клиент посылает запрос на продление аренды через половину от этого таймера, если ответ не был получен – то ещё раз, через половину от оставшегося времени аренды. Наконец, последний запрос от клиента будет при полном истечении аренды, и если сервер до сих пор не ответил, то клиент начинает процедуру получения адреса заново.
