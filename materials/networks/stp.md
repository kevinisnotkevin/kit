# STP

STP (Spanning Tree Protocol) - протокол связующего дерева, который отключает некоторые соединения между коммутаторами, чтобы не образовывалось кольцо. 

Для реализации протокола коммутаторы обмениваются сообщениями BPDU (Bridge Protocol Data Units) каждые 2 секунды, рассылая сообщения на групповой адрес STP. Переход состояний занимает 30 секунд. 

RSTP является улучшенной версией STP, так как срабатывает быстрее при подключении оборудования и изменении конфигурации сети.

Чтобы определить какие порты заблокировать, а какие будут передавать данные, STP выполняет следующий алгоритм: 
- Выбор корневого дерева
- Определение корневых портов
- Определение выделенных портов

Корневым становится коммутатор с наименьшим Bridge ID.

Bridge ID (идентификатор моста) - это 
- число задаваемое администратором
- tag VLAN’a
- MAC-адрес нулевого порта

## Таймеры STP

Значения таймеров Hello Time, Forward Delay и Max Age могут быть вручную настроены администратором сети на коммутаторе. Обычно эти настройки выполняются только на коммутаторе, являющемся корневым для данной топологии связующего дерева. При настройке важно помнить, что неправильно подобранные значения таймеров могут значительно увеличить время сходимости топологии STP и снизить производительность сети, поэтому рекомендуется использовать значения таймеров по умолчанию.

- Hello Time - это интервал времени, через который корневой мост отправляет конфигурационные BPDU
- Forward Delay - это интервал времени, в течение которого порт коммутатора находится в состояниях “Прослушивание” и “Обучение”
- Max Age - это интервал времени, в течение которого коммутатор хранит параметры текущей конфигурации связующего дерева

## Роли портов

Главная задача коммутатора – иметь один путь к вершине дерева, к root’у. Если коммутатор обнаруживает, что среди его интерфейсов есть те, через которые можно получить трафик от root’а, то принимается решение заблокировать такие порты. Таким образом коммутатор отключает интерфейсы, приводящие к кольцу в топологии. При этом коммутатор способен понять, какой из интерфейсов оставить включенным правильнее. Он выберет интерфейс, от которого трафик до root’a доходит быстрее всего. Это происходит на основании метрики пути. Чем длиннее путь – тем хуже метрика.

- Root Port - корневой порт коммутатора
- Designated Port - порты, находящиеся в режиме передачи данных
- Nondesignated Port - заблокированные порты

## Состояния портов

Порт коммутатора может находиться в различных статусах, в зависимости от результата сходимости Spanning Tree:

- Блокирован - как видно из названия, данный порт находится в статусе блокировки. Это означает, что порт не участвует в приеме и пересылке фреймов. Все BPDU сообщения от соседних коммутаторов исключаются.
- Слушает – коммутатор все еще не участвует в процессе передачи фреймов с данными, но получает и отправляет сообщения BPDU.
- Учится – в данном состоянии порт начинает фиксировать MAC – адреса устройств.
- Пересылка – в состоянии пересылки, коммутатор может отправлять и принимать фреймы BPDU параллельно с заполнением таблицы MAC - адресов.
- Выключен – порт выключен администратором.

## Принцип работы

После включения коммутаторов в сеть, по умолчанию каждый коммутатор считает себя корневым (root).

1. Каждый коммутатор начинает посылать по всем портам конфигурационные Hello BPDU пакеты раз в 2 секунды.
2. Если мост получает BPDU с идентификатором моста (Bridge ID) меньшим, чем свой собственный, он прекращает генерировать свои BPDU и начинает ретранслировать BPDU с этим идентификатором.
3. Таким образом в конце концов в этой сети Ethernet остаётся только один мост, который продолжает генерировать и передавать собственные BPDU. Он и становится корневым мостом (root bridge).
4. Остальные мосты ретранслируют BPDU корневого моста, добавляя в них собственный идентификатор и увеличивая счётчик стоимости и пути (path cost).
5. Для каждого сегмента сети, к которому присоединено два и более портов мостов, происходит определение designated port — порта, через который BPDU, приходящие от корневого моста, попадают в этот сегмент.
6. После этого все порты в сегментах, к которым присоединено 2 и более портов моста, блокируются за исключением root port и designated port.
7. Корневой мост продолжает посылать свои Hello BPDU раз в 2 секунды.

## RSTP

RSTP (Rapid STP, англ. Rapid spanning tree protocol, быстрый протокол основного дерева), он же IEEE 802.1w-2001 и IEEE 802.1D-2004 - версия протокола STP c ускоренной реконфигурацией дерева, использующегося для исключения петель (исключения дублирующих маршрутов) в соединениях коммутаторов Ethernet с дублирующими линиями.

Принцип работы в общих чертах похож на STP: выбирается корневой коммутатор, затем каждый коммутатор, участвующий в построении дерева, ищет кратчайший маршрут (с учётом пропускной способности канала) к корневому коммутатору через соседние коммутаторы (или напрямую). Линии, не попавшие в маршрут, переводятся в режим ожидания и не используются для передачи данных, пока работают основные линии. В случае выхода из строя основных линий, ожидающие линии используются для построения альтернативной топологии, после чего одна из линий становится активной, а остальные продолжают находиться в режиме ожидания.

## PVST

Cisco имеет свой взгляд на STP, и свою проприетарную реализацию протокола - PVST (Per-VLAN Spanning Tree) - которая предназначена для работы в сети с несколькими VLAN. В PVST для каждого влана существует свой процесс STP, что позволяет независимую и гибкую настройку под потребности каждого влана, но самое главное, позволяет использовать балансировку нагрузки за счет того, что конкретный физический линк может быть заблокирован в одном влане, но работать в другом. Минусом этой реализации является, конечно, проприетарность: для функционирования PVST требуется проприетарный же ISL транк между свичами.

Также существует вторая версия этой реализации - PVST+, которая позволяет наладить связь между свичами с CST и PVST, и работает как с ISL- транком, так и с 802.1q. PVST+ это протокол по умолчанию на коммутаторах Cisco.

## MSTP

Протокол Multiple Spanning Tree Protocol (MSTP) является расширением протокола RSTP, который позволяет настраивать отдельное связующее дерево для любой VLAN или группы VLAN, создавая множество маршрутов передачи трафика и позволяя осуществлять балансировку нагрузки.

Протокол MSTP делит коммутируемую сеть на регионы MST (Multiple Spanning Tree (MST) Region), каждый из которых может содержать множество копий связующих деревьев (Multiple Spanning Tree Instance, MSTI) с независимой друг от друга топологией.

Для того чтобы два и более коммутатора принадлежали одному региону MST, они должны обладать одинаковой конфигурацией MST, которая включает: номер ревизии MSTP (MSTP revision level number), имя региона (Region name), карту привязки VLAN к копии связующего дерева (VLAN-to-instance mapping).
