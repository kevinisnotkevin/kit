# Маршрутизация

## Принципы маршрутизации

Маршрутизация (Routing) - это процесс по определению/вычислению лучшего маршрута движения для данных в сетях связи. Есть еще второе определение - это передача пакетов данных от отправителя к получателю.

Сами маршруты могут быть статическими - задаются административно, или динамическими, т.е. рассчитываться по специальным алгоритмам-протоколам, которые базируются на данных о топологии и состоянии сети. Для маршрутизации пакета маршрутизатор должен владеть следующей информацией:
- Адрес назначения
- Соседний маршрутизатор, от которого он может узнать об удаленных сетях
- Доступные пути ко всем удаленным сетям
- Наилучший путь к каждой удаленной сети
- Методы обслуживания и проверки информации о маршрутизации

RIP, OSPF и BGP - протоколы динамической маршрутизации.

**Таблица маршрутизации**

В таблице перечислены обозначения маршрутов, в данном примере символами С в таблице маршрутизации помечены непосредственно присоединенные к маршрутизатору сети, а символом S - созданные администратором статические маршруты к удаленным сетям. Так же можно заметить такие возможные обозначения маршрутов как – O – маршрут, полученный по протоколу OSPF, R – получен про протоколу RIP, B – BGP маршрут и так далее.

**Трассировка маршрутов**

Для того, чтобы понять, как пакет данных путешествует по сети от адреса отправителя до адреса получателя, применяется трассировка.

Трассировка маршрута пакета до сетевого хоста показывает все промежуточные узлы, через которые проходит пакет, пока доберётся до указанной цели. То есть с помощью трассировки можно узнать, по каким узлам, с какими IP адресами, передаётся пакет прежде чем быть доставленным до точки назначения.

Трассировка может применяться для выявления связанных с работой компьютерной сети проблем, а также для исследования сети (определения структуры сети, поиска промежуточных сетевых узлов).

Трассировка работает следующим образом: Пересылаемые сетевые пакеты состоят из двух областей: заголовки и данные. В заголовках находится разная информация, например, IP адреса пункта отправки и пункта назначения, порты отправки и назначения, тип пакета, контрольная сумма пакета и прочее. Среди полей заголовка, у IP протокола есть такое поле как time to live (TTL) — время жизни пакета. Это счётчик с числом, которое уменьшается на единицу каждый раз, когда пакет проходит новый узел. Этот счётчик сделан для того, чтобы проблемный пакет (например, при ошибке, повлекшей закольцованный маршрут) не путешествовал по сети бесконечно.

То есть любой пакет пройдя определённое количество узлов в конце-концов достигнет точки назначения или будет отброшен одним из узлов сети, когда закончится «время жизни». Когда счётчик TTL становится равным нулю, очередной шлюз просто не пересылает этот пакет дальше. Но при этом шлюз на тот IP адрес, откуда пришёл пакет с истёкшим временем жизни, отправляет по протоколу ICMP ответ TIME_EXCEEDED (время жизни кончилось). И этот ответ содержит IP адрес шлюза, где пакет закончил своё существование.

Так вот, суть трассировки в том, что отправляется один пакет с временем жизни (TTL) установленным на единицу — первый шлюз уменьшает значение на единицу, смотрит, что счётчик стал равен нулю, никуда не отправляет этот пакет, зато нам отправляет ответ, что пакет отброшен. Из этого ответа нас интересует только IP адрес шлюза, где с пакетом случилось это несчастье. Затем отправляется пакет со счётчиком установленным на 2 — пакет проходит первый шлюз (его IP мы уже знаем), но теперь счётчик достигает нуля уже на втором шлюзе — мы получаем ICMP ответ с IP этого шлюза. Затем отправляется следующий пакет и так далее, пока не будут определены все узлы до нужного нам сетевого хоста.

## Основы статической маршрутизации

Статическая маршрутизация — вид маршрутизации, при котором маршруты вручную указываются администратором при настройке маршрутизатора

Статические маршруты полностью определены администратором, поэтому они более безопасны, Однако сети, использующие статическую маршрутизацию, плохо масштабируемы, при изменении топологии требуется внесение изменений администратором в конфигурацию, что может приводить к ошибкам.

**Типы статических маршрутов**

- Стандартный статический маршрут – настроенный вручную маршрут, который перенаправляет трафик в определённую сеть
- Шлюз по умолчанию — сетевой шлюз на который пакет отправляется в том случае, если маршрут к сети назначения пакета не известен (не задан явным образом в таблице маршрутизации хоста)

Статический маршрут по умолчанию обычно используется в качестве шлюза последней надежды, который используется для любого пакета, не имеющего маршрута назначения в таблице маршрутизации. Пунктом назначения в таких случаях часто является Интернет. Адрес маршрута по умолчанию 0.0.0.0/0 означает любые адреса сетей с любыми масками.

**Настройка статической маршрутизации**

Для настройки статического маршрута необходимо определить несколько параметров:

**Первый** – адрес подсети назначения. Если в заголовке ip адреса назначения приходящего ip пакет на интерфейс роутера будет ip адрес, входящий в указанную сеть, то тогда роутер применит такое правило маршрутизации на пакет

**Второй** – маска подсети. Она будет определять диапазон адресов, в рамках которого проверяются приходящие пакеты

И **третий** – ip адрес шлюза. Этот параметр определяет, на какой из соседних роутеров направить приходящий трафик для дальнейшей маршрутизации.

```
Router(config)#ip route <destination-network> <mask> <next-hop>
```
- Формат команды

**Суперсеть**

Суперсеть - это сеть интернет-протокола (IP), которая формируется путем объединения нескольких сетей (или подсетей) в более крупную сеть

**Рассмотрим пример**

У нас имеется сеть как на схеме и стоит задача настроить статическую маршрутизацию. Что бы PC1 знал как добраться до PC2, PC3, PC4 ему придётся прописывать сети 18.20.1.0/24, 18.20.2.0/24 и 18.20.3.0/24. Но мы можем упростить себе задачу, объединив эти сети в суперсеть. Как это сделать? У нас имеются три сети с маской 255.255.255.0, т.е. включают в себя 256 ip-адресов (первый адрес сети, последний широковещательный) каждая. Если мы хотим объединить их в одну сеть, нам нужна сеть содержащая: 254 хоста с одной сети + 254 хоста со второй сети + 254 хоста с третьей сети + 1 адрес на саму сеть + 1 широковещательный адрес. Итого минимум нам необходимо 764 ip адреса на конкретном примере. Таким образом мы можем подобрать маску нашей суперсети. /22, /21, /20 и т.д. включают в сеть нужное количество адресов. Возьмём, например, маску 255.255.252.0 (/22), а далее дело за ip калькулятором.

В поле ip адрес указываем нашу сеть, в выпадающем списке «Маска» - 22 маску и нажимаем подсчитать. Получаем что наша суперсеть – 18.20.0.0/22. Это сеть, которая включает ip адреса от 18.20.0.1 до 18.20.3.254, т.е. объединяет все необходимые нам сети. Так три строчки «ip route …» превращаются в одну.

**Достоинства и недостатки статической маршрутизации**

К преимуществам можно отнести:

- Простоту настройки
- Отсутствие дополнительной нагрузки на сеть

К недостаткам относится:

- Сложность масштабирования
- При возникновении каких-либо изменений в сети, как правило потребуется вмешательство администратора и настройка новых, актуальных статических маршрутов
- Если возникают проблемы на канальном уровне, но интерфейс по-прежнему в статусе up, то статический маршрут остается активным, хотя данные передаваться не могут

## Основы динамической маршрутизации

Динамическая маршрутизация - вид маршрутизации, при котором таблица маршрутизации редактируется программно.

Динамические протоколы делят на две группы:

- **EGP** (External Gateway Protocol) - внешний протокол маршрутизации для использования между AS. В группу входят - **BGP**
- **IGP** (Interior Gateway Protocol) - внутреннего протокола маршрутизации для использования внутри AS. В группу входят - **RIP, OSPF**
