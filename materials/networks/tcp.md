# TCP

TCP (Transmission Control Protocol) - протокол, который обеспечивает надежную передачу данных и устанавливает соединения между устройствами. Обеспечивает передачу информации по установленному соединению, проверяет статус и целостность полученной информации, повторно запрашивает потерянную информацию, регулирует загруженность сети, сегментирует данные на более мелкие пакеты, гарантирует получение и сборку информации у адресата в правильном порядке. 

Протоколы, которые работают по TCP: SSH, FTP, Telnet, SMTP, POP, IMAP, HTTP/HTTPS.

Соединение устанавливается с помощью трехстороннего рукопожатия:
- Отправитель отправляет пакет SYN получателю;
- Получатель подтверждает пакет SYN и отправляет его обратно вместе с ACK подтверждением;
- Отправитель подтверждает SYN+ACK и отправляет ACK подтверждение.

Если приложению требуется подтверждение доставки сообщения, оно использует протокол TCP.

TCP разбивает сообщение на фрагменты меньшего размера, именуемые сегментами. Эти сегменты последовательно нумеруются и передаются IP-протоколу, который затем осуществляет сборку пакетов. TCP отслеживает количество сегментов, отправленных на тот или иной узел тем или иным приложением. Если отправитель не получает подтверждения в течение определенного периода времени, то TCP рассматривает эти сегменты как потерянные и повторяет их отправку. Повторно отправляется только потерянная часть сообщения, а не все сообщение целиком.

## Структура заголовка TCP сегмента

![](materials/images/networks/tcp_packet.png)
- В TCP тоже присутствует набор заголовков, стандартизованных для транспортного протокола. В начальных заголовках TCP мы увидим порт источника и порт назначения. Это специальные номера, с помощью которых клиент может обратиться к конкретному приложению, работающему на сервере

- Порядковый номер (Sequence number) - заголовок позволяет контролировать порядок сообщений. Именно благодаря этому параметру принимающая система собирает пакеты именно так, как надо, а не в том порядке, как они пришли
- Номер подтверждения (Acknowledgment Number) - заголовок показывает, на пакет с каким Sequence number отвечает удаленная система. Таким образом мы можем понять, что удаленная система получила пакет с нашим Sequence number
- Длина заголовка (Data offset), известная также как смещение данных - заголовок содержит размер заголовка TCP, измеряемый в 32-битных сегментах. Минимальный размер заголовка TCP составляет пять 32-битных сегментов (всего 20 байт), а максимальный — пятнадцать 32-битных сегментов (или 60 байт)
- Зарезервированные биты - размер этого поля рамен трем битам. Эти данные зарезервированы для будущего использования, а сейчас просто забивается нулями. На данный момент осталось три незадействованных бита, в то время как еще три ранее зарезервированных бита уже используются как флаги
- Флаги - специальные управляющие биты, определяющие функциональность TCP соединения
- Размер окна (Window Size) - позволяет сообщить серверу, какой объем данных готов принять обратно. Этим клиент информирует сервер о размере своего буфера. Если сервер попытается ответить клиенту, отправив данные большего объема, чем размер буфера клиента, то клиент такой набор данных обработать не сможет
- Контрольная сумма - используется для проверки целостности всех заголовков TCP. Аналогичный параметр в протоколе IP
- Указатель срочности (Urgent pointer) - необходим для того, чтобы приоритизировать данный трафик для приложения. Если данные помечены с помощью этого поля как срочные, то приложение-получатель трафика обработает эти данные немедленно. В данном поле указывается смещение данных, благодаря которому приложение понимает, где приоритизированные данные в сегменте заканчиваются
- Опции - необходимы для расширения функциональности TCP. В этом заголовке разработчики приложений могут определять свои специальные опции, с которыми будет работать их приложение.

## Флаги TCP

- SYN (Синхронизация) - первый флаг между двумя хостами, используется для установки соединения
- ACK (Подтверждено) - подтверждение получения пакета
- RST (Сброс) - запрашивает разрыв соединения. Последний пакет, отправленный клиентом
- FIN - сообщает другой стороне что все пакеты были отправлены, и соединение пора завершить
- PSH - используется, если необходимо немедленно отправить все данные из буфера
- URG - указатель важности. 0 если не используется, 1 - используется

## TCP соединение

TCP-соединение можно разделить на 3 стадии:
- Установка соединения
- Передача данных
- Завершение сеанса

Процесс установки соединения (TCP handshake, Трехэтапное рукопожатие):
- Клиент отправляет SYN
- Сервер отвечает SYN-ACK
- Клиент подтверждает установку соединения ответом ACK
- Сервер переходит в состояние ESTABLISHED (Соединение установлено)

Процесс передачи данных:
- Клиент отправляет серверу ACK-PSH, чтобы сервер не ждал продолжения данных
- Сервер отвечает ACK
- Сервер обрабатывает запрос и отправляет клиенту данные, которые делятся на пакеты
- Клиент подтверждает получение ответом ACK

Процесс завершения сеанса:
- Клиент запрашивает завершение сеанса и отправляет FIN
- Сервер возвращает ACK для подтверждения запроса
- Сервер отправляет FIN
- Клиент отправляет ACK, подтверждая FIN
