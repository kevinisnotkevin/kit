# VLAN

## Сегментация сетей

Сегментация сети - метод обеспечения безопасности сети, который заключается в разделении сети на более мелкие отдельные подсети. При этом специалисты по сети могут распределять эти подсети по сегментам и предоставлять уникальные средства и службы управления безопасностью для каждой из них.

Процесс сегментации сети включает в себя разделение физической сети на разные логические подсети.

Изначально наша сеть делится на сегменты физически, благодаря различным сетевым устройствам.

Но этого недостаточно, ведь к одному коммутатору могут быть подключены компьютеры, взаимодействие которых друг с другом нужно заблокировать. Для решения такой задачи используется технология VLAN.

VLAN (Virtual Local Area Network) - группа устройств, имеющих возможность взаимодействовать между собой напрямую на канальном уровне, хотя физически при этом они могут быть подключены к разным сетевым коммутаторам. И наоборот, устройства, находящиеся в разных VLAN'ах, невидимы друг для друга на канальном уровне, даже если они подключены к одному коммутатору, и связь между этими устройствами возможна только на сетевом и более высоких уровнях.

VLAN представляет собой число от единицы до 4094. Данное число записывается в заголовок фрейма на уровне L2, этот процесс называется тегированием трафика.

**Технология VLAN обеспечивает:**
- Гибкое построение сети - VLAN позволяет произвести сегментацию локальной сети на подсети по функциональному признаку независимо от территориального расположения устройств. То есть устройства одной подсети VLAN могут быть подключены к разным коммутаторам, удаленным друг от друга. И наоборот, к одному коммутатору могут быть подключены устройства, относящиеся к разным подсетям VLAN
- Увеличение производительности - VLAN разделяет подсеть на отдельные широковещательные домены. Это означает, что широковещательные сообщения будут получать только устройства, находящиеся в одной VLAN-подсети. Построение системы с использованием технологии VLAN позволяет уменьшить широковещательный трафик внутри сети, тем самым снижается нагрузка на сетевые устройства и улучшается производительность системы в целом.
- Улучшение безопасности - Устройства из разных подсетей VLAN не могут общаться друг с другом, что уменьшает шансы произвести несанкционированный доступ к устройствам системы. Связь между разными подсетями возможна только через маршрутизатор. Кроме того, использование маршрутизатора позволяет настроить политики безопасности, которые могут быть применены сразу ко всей группе устройств, принадлежащей одной подсети.

## VLAN порты

У коммутатора в процессе работы с технологией VLAN существует два вида настройки портов.

Первый вид - access. Эта настройка применяется к порту, к которому подключено клиентское устройство. На данном порту трафик будет тегироваться.

Второй вид - trunk. Такие порты нужны для связи сетевых устройств. По этим интерфейсам трафик передается без изменений тега VLAN.

## Процесс тегирования

Компьютер формирует трафик к другому устройству. Этот трафик доходит до интерфейса ближайшего коммутатора. Далее, в соответствии с настройками интерфейса, в L2 заголовок добавляется тег VLAN, после чего фрейм идёт дальше по сети.

Когда такой трафик доходит до коммутатора, к которому подключен получатель трафика, то коммутатор в соответствии со своей таблицей мак адресов направляет трафик на интерфейс. Если интерфейс настроен в такой же VLAN, какой тег присутствует и в трафике, то из заголовка фрейма удаляется метка VLAN, а трафик проходит через интерфейс и направляется к получателю. Если VLAN отличается, то трафик отбрасывается.

По пути до получателя информации наш трафик может пройти через многие коммутаторы в сети. Такие коммутаторы связаны между собой транковыми портами, проходя через которые заголовки фрейма изменяться не будут.

## Маршрутизация между VLAN

По умолчанию трафик из одного VLAN никак не сможет оказаться в другом VLAN, так как это ограничивается на канальном уровне. Соответственно, arp запрос первого vlan не дойдет до устройств второго vlan по аналогичной причине.

Чтобы обеспечить сетевую связность между VLAN используется маршрутизация на роутере - процесс перемещения трафика из одной сети в другую.

Чтобы первый компьютер доставил трафик второму, он отправит свой трафик на роутер, чтобы тот смаршрутизировал эту информацию в другую сеть, изменив тег в фрейме.

## Как работает технология VLAN?

У каждой VLAN-подсети есть свой идентификатор, по которому определяется принадлежность той или иной подсети. Информация об идентификаторе содержится в теге, который добавляется в тело Ethernet-фрейма сети, в которой внедрено разделение на подсети VLAN.

Самый распространенный стандарт, описывающий процедуру тегирования трафика, – это открытый стандарт 802.1 Q. Кроме него есть проприетарные протоколы, но они менее популярны.

**Тег размером 4 байта состоит из нескольких полей:**
- TPID (Tag Protocol Identifier) — Идентификатор протокола тегирования. Для стандарта 802.1Q значение TPID - 0x8100
- Р-тег – Определяет приоритет пакета. Используется при работе стандарта 802.1p для определения очередности обработки пакетов
- CFI (Canonical Format Indicator) – Идентификатор формата МАС-адреса, который использовался для совместимости между сетями Ethernet и Token Ring. В настоящее время поле CFI не используется в связи с отказом от сетей Token Ring
- VLAN ID – Идентификатор VLAN. Определяет, какой подсети VLAN принадлежит пакет

Именно по тегу сетевое оборудование определяет принадлежность пакета той или иной сети VLAN, осуществляет фильтрацию пакетов и определяет дальнейшие действия с ними: снять тег и передать на конечное оборудование, отбросить пакет, переслать следующему получателю с сохранением тега. Правила, определяющие действия с пакетом на основе тега, зависят от режима работы порта сетевого оборудования. В свою очередь, режим работы выбирается в соответствии с характеристиками подключаемого оборудования. В системе может присутствовать как оборудование с поддержкой технологии VLAN, так и без нее.

## VTP

VLAN Trunking Protocol (VTP) - проприетарный протокол компании Cisco Systems, предназначенный для создания, удаления и переименования VLANов на сетевых устройствах. Передавать информацию о том, какой порт находится в каком VLANе, он не может.

## GVRP & MVRP

GARP VLAN Registration Protocol (GVRP) - сетевой протокол канального уровня модели OSI/ISO, позволяющий устройству локальной сети сообщить всем соседним устройствам, что оно желает принять пакеты для одной или нескольких VLAN. Главная цель GVRP - позволить коммутаторам автоматически обнаружить информацию о VLAN, которая иначе должна была бы быть вручную сконфигурирована в каждом коммутаторе. Этого можно достичь использованием GVRP - распространить идентификаторы VLAN по локальной сети. GVRP также может быть использован сетевыми серверами. Эти серверы обычно конфигурируются для вхождения в несколько VLAN, и затем сообщают коммутаторам о VLAN, к которым они хотят присоединиться.

MVRP (Multiple VLAN Registration Protocol) - служебный протокол канального уровня, который так же как и его предшественник, GVRP, нужен для автоматизации настроек VLAN в больших сетях. Описан в стандарте 802.1ak (как одно из приложений рамочного протокола MRP, Multiple Registration Protocol), который с 2005 года дополняет собой 802.1Q.

Основная задача MVRP - синхронизировать в LAN-сети информацию об используемых устройствами VLAN и привязке VLAN к интерфейсам. Для этого MVRP использует MRP Attribute Declaration (MAD) и MRP Attribute Propagation (MAP) - в общем-то так же, как GVRP использовал GARP Information Declaration (GID) и GARP Information Propagation (GIP). Примечательным является то, что MVRP передаёт статус всех 4096 VLANов в одной PDU, а также уведомляет об изменениях в топологии нескольких VLAN также одной пачкой TCN.
