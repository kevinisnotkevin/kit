# CI/CD

## 1 Что такое CI/CD

CI/CD - это комбинация непрерывной интеграции (continuous integration) и непрерывного развертывания (continuous delivery или continuous deployment) программного обеспечения в процессе разработки.

> Непрерывная интеграция (continuous integration) - это процесс, при котором продукт регулярно собирается из исходного кода и подвергается исполнению значительной части автоматических тестов, таких как модульные тесты. В случае, если автоматические тесты занимают много времени, их можно запускать реже, например, раз в сутки. Основной подход для организации непрерывной интеграции заключается в использовании инструментов, таких как TeamCity или Jenkins, которые загружают исходный код из системы контроля версий, осуществляют его сборку и запускают тесты.

> Непрерывная доставка (continuous delivery) представляет собой подход, при котором продукт всегда находится в готовом состоянии и может быть передан в промышленную эксплуатацию, включая последние изменения, внесенные разработчиками в код. Вероятно, непрерывная доставка будет реализована с использованием той же технологии, что и непрерывная интеграция.

> Непрерывное развертывание (continuous deployment) - это процесс, при котором обновления продукта регулярно вводятся в промышленную эксплуатацию, например, после каждого изменения, внесенного разработчиками. При этом все процессы предметной области продолжают работать без сбоев. В некотором смысле непрерывное развертывание представляет собой хорошо автоматизированную и часто выполняющуюся непрерывную доставку.

CI/CD является неотъемлемой частью devops и всех современных методик разработки. С помощью специальной платформы CI/CD мы можем оптимизировать процесс разработки в любой компании, используя средства автоматизации, тестирования и совместной работы. Эта практика позволяет разработчикам, командам по безопасности и эксплуатации работать максимально эффективно и результативно. CI/CD устраняет необходимость в ручной работе по разработке и устаревших процессах согласования и утверждения, освобождая команды devops для более инновационного подхода к разработке.

![](/materials/images/devops/devops_whatis_ci_cd.png)

Инструменты CI/CD: CircleCI, Github Actions, Gitlab CI, Drone, Travis CI, Jenkins, TeamCity, Azure DevOps.

## 2 Этапы CI/CD

**Написание кода.** Каждый разработчик создает код отведенного ему модуля и тестирует его в ручном режиме. Затем разработанный и проверенный программный блок интегрируется в основной ветке с текущей версией продукта. Как только все модули будут опубликованы в главной ветке, команда переходит к следующему этапу.

**Сборка.** Заранее подобранная система контроля версий запускает автоматизированную сборку и тестирование всего продукта. Триггеры могут быть настроены автоматически или вручную. Автоматическая сборка выполняется с помощью Jenkins или другого сервера непрерывной интеграции.

**Ручное тестирование.** Как только CI-сервер закончит автоматизированную сборку продукта, он передается тестировщикам на проверку. Они используют различные методики тестирования для выявления и устранения ошибок и уязвимостей программы.

**Релиз.** После исправления ошибок вычищенный и отлаженный код переходит на этап релиза для клиентов. Его проверяет заказчик, возможно, с привлечением своих специалистов или ограниченной группы пользователей. По результатам проверки код отправляется на доработку или согласуется.

**Развертывание.** Текущая версия программы размещается на продакшн-серверах разработчика. Заказчик может работать с программой, исследовать ее функции, искать уязвимости.

**Поддержка и отслеживание.** После развертывания приложение становится доступным конечным пользователям. Параллельно этому разработчики выполняют его поддержку и одновременно мониторят реакцию пользователей, анализируют их опыт взаимодействия с программой.

**Планирование.** На основании данных, полученных при изучении пользовательского опыта, разработчик подготавливает план доработок, включающий новые функции, исправление ошибок и т.д. После этого он вносит все корректировки в продукт — и цикл разработки начинается снова.

- __CI (Continuous Integration, Непрерывная интеграция)__ — интеграция отдельных кусочков кода приложения между собой. CI обычно выполняет две задачи, описанные далее;
    - BUILD:
        - Сборка кода;
        - Подготовка артефактов для следующих стадий;
    - TEST:
        - Тесты кодстайла;
        - Модульные тесты;
        - Интеграционные тесты;
        - Прочие тесты;
        - Отчеты о тестах.
- __CD (Continuous Delivery, Непрерывная доставка)__ — это расширение непрерывной интеграции, поскольку оно автоматически развертывает все изменения кода в тестовой и/или производственной среде после этапа сборки. CD может выполнять задачи, описанные далее;
    - PUBLISH (В случае применения докера для развёртывания):
        - Сбор образов контейнеров;
        - Пуш образов;
    - UPDATE CONFIGS:
        - Обновление конфигураций на машинах;
    - DEPLOY STAGING:
        - Развертывание тестовой среды для ручных тестов, QA, и прочих не автоматизируемых проверок;
        - Может запускаться как вручную, так и автоматически при успешном прохождении стадий CI;
    - DEPLOY PRODUCTION:
        - Разворачиваем новую версию системы на прод;
        - Этот этап желательно запускать вручную, а не автоматически;
        - По желанию можно настроить только для определенной ветки репозитория (master, release и т.п.).

## 3 Pipeline

CI/CD pipeline - это последовательность действий (скриптов) для определенной версии кода в репозитории, которая запускается автоматически при совершении изменений (Постоянная автоматизация и непрерывный мониторинг на протяжении всего жизненного цикла приложений, от этапов интеграции и тестирования до доставки и развертывания).

В общем случае, пайплайн можно представить в виде 7 основных шагов.

### 3.1 Триггер

Пайплайн должен автоматически запускаться каждый раз, когда в репозиторий отправляется новый код. Существует несколько способов достичь этого. Например, инструмент CI/CD, такой как Jenkins, может опрашивать репозиторий Git, или же определенный хук, например Git webhooks, может отправлять уведомления о push разработчика инструменту CI/CD. Хотя возможен и запуск пайплайна вручную, такое решение не является наилучшим и автоматический запуск дает больше уверенности.

### 3.2 Проверка кода

Инструмент CI/CD извлекает код из репозитория вместе с информацией о том, какой коммит вызвал запуск пайплайна, и какие шаги необходимо выполнить. На данном этапе могут быть запущены инструменты статического анализа кода, которые могут прервать выполнение пайплайна в случае обнаружения ошибки. Если все в порядке, то процесс CI/CD продолжается далее.

### 3.3 Компиляция кода

Естественно, инструмент CI/CD должен иметь доступ к необходимым инструментам сборки для компиляции кода. Например, для приложений на Java могут использоваться Maven или Gradle. К тому же, для обеспечения максимальной чистоты процесса сборки, можно использовать Docker для создания изолированной среды.

### 3.4 Unit-тестирование

Одна из важнейших составляющих пайплайна - модульное тестирование или unit testing. Для этого используются специальные библиотеки для конкретного языка программирования. Скомпилированное приложение запускается с тестами, и если выполнение проходит без ошибок, переходим к следующему шагу. Важно достичь максимального покрытия всех функций и компонентов приложения тестами, а также поддерживать и улучшать их по мере роста кодовой базы.

### 3.5 Упаковка кода

Если все тесты пройдены успешно, приложение необходимо упаковать для доставки пользователю. Для Java-приложений может быть создан JAR-файл, а для приложений, работающих в Docker-контейнере, - Docker-образ.

### 3.6 Приемочное тестирование (Здесь начинается CD)

Этот способ позволяет убедиться, что ПО соответствует всем требованиям клиента и заявлениям самого разработчика.

Требования и ожидаемые результаты формулируются в понятном для компьютерной системы формате и могут быть автоматизировано протестированы, так же как модульные тесты. Например, можно протестировать функциональные части приложения, например, проверить, сможет ли пользователь добавить товар в корзину на сайте интернет-магазина, используя Selenium для имитации действий пользователя в браузере. Приемочное тестирование сокращает время, затрачиваемое на ручное тестирование. Зачем кликать мышью на кнопку вручную, если это может сделать специальная программа по триггеру?

### 3.7 Доставка и развертывание

На этом этапе уже существует готовый к развертыванию программный продукт, который нужно доставить в рабочую среду клиента и установить корректно. Для непрерывного развертывания необходима производственная среда. Это может быть публичное облако с собственным API или инструмент Spinnaker, который работает с оркестрацией контейнеров Kubernetes и популярными облачными платформами, такими как Google Cloud Platform, AWS, Microsoft Azure и Oracle Cloud.

Таким образом, это последний этап пайплайна. В следующий раз, когда код отправляется в репозиторий разработчиком, процесс будет запущен заново.
