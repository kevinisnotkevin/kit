# Безопасность контейнеров и кластеров

## 1 Безопасность Docker инфраструктуры

### 1.1 Типовые проблемы безопасности, связанные с Docker

- **Безопасность хостовой системы**

Одно из самых важных вопросов безопасности Docker - это обеспечение безопасности хост-машин, особенно ядра операционной системы. Поскольку в уже скомпрометированной системе изоляция и другие механизмы безопасности контейнеров, которые мы могли бы использовать, не смогут помочь. Это связано с тем, что Docker спроектирован таким образом, что все запущенные контейнеры используют ядро хост-системы. Поэтому в качестве хоста должен быть использован обновленный дистрибутив Linux без известных уязвимостей и признаков заражения вредоносным ПО.

Классическим примером такой уязвимости является «выход за пределы контейнера» (container breakout) в Docker. Эта уязвимость описывает ситуацию, когда программе, запущенной внутри контейнера, удается преодолеть механизмы изоляции и обрести привилегии суперпользователя (root) или получить доступ к важной информации, хранящейся на хост-машине. Один из типичных примеров такой уязвимости - уязвимость Dirty COW (CVE-2016-5195).

Для обеспечения защиты от подобных ситуаций применяется стратегия ограничения привилегий, выдаваемых контейнеру по умолчанию. Например, если демон Docker запущен с привилегиями суперпользователя (root), для него создается пользовательское пространство имен (user-level namespace) с минимальными привилегиями.

- **Исчерпание ресурсов, или DDoS на контейнер**

Если сравнивать контейнеры с виртуальными машинами, то первые более легковесны. Даже на старом и слабом железе можно запустить много контейнеров. Однако ошибки в конфигурации демонов, сетевого стека, недостатки проектирования архитектуры и атаки хакеров могут приводить к состояниям типа «отказ в обслуживании» (Denial of Service).

К примеру, некий контейнер или целый пул контейнеров может пожрать все процессорное время хоста и просадить его производительность. Аналогичная ситуация может сложиться и с сетевыми интерфейсами, когда количество генерируемых пакетов превысит нормальную пропускную способность сети. Но выход тут, в принципе, довольно прост: должным образом настроить лимиты ресурсов для контейнера.

- **Скомпрометированные образы для Docker**

Docker является open source-программным обеспечением, распространяемым бесплатно. Оно предоставляет публичный доступ к образам, с помощью которых можно создавать контейнеры. Но данная свобода также открывает возможности для злоумышленников, которые могут использовать фишинг и другие методы социальной инженерии, чтобы манипулировать действиями пользователей, загружая предварительно скомпрометированные образы с вредоносными программами или задними дверями.

Например, в апреле этого года возникла новость о том, как неизвестные злоумышленники получили доступ к базе данных крупнейшей библиотеки образов для контейнеров Docker Hub. В результате этого инцидента были скомпрометированы личные данные пользователей, хеши паролей, а также токены для репозиториев на GitHub и Bitbucket, которые используются для автоматизированных сборок Docker. Также стоит вспомнить новость из лета 2018 года, когда семнадцать образов контейнеров, содержащих опасные backdoor программы, были удалены из официального реестра Docker Hub. Позднее эксперты обнаружили, что через эти образы на серверы пользователей проникал скрытый майнинг-софт и были установлены обратные шеллы.

Таким образом, необходимо аккуратно подойти к выбору и загрузке образов Docker, а также регулярно обновлять их для минимизации рисков и обеспечения безопасности своих систем.

### 1.2 Усиливаем безопасность Docker

- **Использование достоверных образов**

Начнем, пожалуй, с банальной для репозиториев Docker проблемы - достоверности образа. Чтобы избежать проблем с фейковыми образами, используй приватные (private) или строго доверенные репозитории (trusted repositories) вроде Docker Hub. В отличие от других репозиториев, образы, которые там хранятся, всегда сканирует и просматривает специальный робот безопасности Docker’s Security Scanning Service.

- **Верифицируем образы через сервис Docker Content Trust**

Еще один полезный и доступный всем инструмент, которым стоит воспользоваться, - Docker Content Trust. Это новая функция, доступная с версии Docker Engine 1.8. Она позволяет верифицировать владельца образа. Таким образом этот сервис защищает тебя от фейков и подделок, атак повторного воспроизведения и компрометации ключей.

- **Проверка хоста и контейнера с помощью Docker Bench Security**

Docker Bench for Security - это скрипт, который проверяет десятки распространенных рекомендаций по развертыванию контейнеров Docker в рабочей среде. Все тесты автоматизированы и основаны на тесте CIS Docker Community Edition Benchmark v1.1.0.

> [https://github.com/docker/docker-bench-security](https://github.com/docker/docker-bench-security) — Гитхаб проекта

> [https://hub.docker.com/r/docker/docker-bench-security](https://hub.docker.com/r/docker/docker-bench-security) — Документация

Инструмент основывается на рекомендациях из документа The CIS Docker 1.13 Benchmark и применяется в следующих областях:

- конфигурация хоста (ядро, процессы, разрешения);
- конфигурация демона Docker (сеть, выделение RAM, CPU);
- файлы конфигурации демона Docker;
- образы контейнеров и build-файлы;
- Runtime контейнера;
- опции «по умолчанию» Docker security.
- Использование нативных опций безопасности на хостовых ОС

Для усиления безопасности можно использовать штатные инструменты Linux: AppArmor, SELinux, grsecurity и Seccomp.

- AppArmor

AppArmor - эффективная и простая в использовании система безопасности приложений Linux. AppArmor активно защищает операционную систему и приложения от внешних или внутренних угроз, даже атак нулевого дня, обеспечивая хорошее поведение и предотвращая использование как известных, так и неизвестных недостатков приложений.

AppArmor дополняет модель Discretionary Access Control (DAC) - традиционной системы безопасности Unix, обеспечивая обязательный контроль доступа (MAC). Он включен в основное ядро Linux начиная с версии 2.6.36, а его разработка поддерживается Canonical с 2009 года.

- SELinux

Security Enhanced Linux представляет собой набор правил и механизмов доступа, основанный на моделях мандатного и ролевого доступа, для защиты систем Linux от потенциальных угроз и исправления недостатков Discretionary Access Control (DAC) - традиционной системы безопасности Unix. Проект зародился в недрах Агентства Национальной Безопасности США, непосредственно разработкой занимались, в основном, подрядчики Secure Computing Corporation и MITRE, а также ряд исследовательских лабораторий.

- grsecurity

Grsecurity - это обширное усовершенствование безопасности ядра Linux, которое защищает от широкого спектра угроз безопасности посредством интеллектуального контроля доступа, предотвращения эксплойтов на основе повреждения памяти и множества других мер по усилению защиты системы, которые обычно не требуют настройки.

- Seccomp

Seccomp (сокращение от secure computing) - механизм ядра Linuх, позволяющий процессам определять системные вызовы, которые они будут использовать. Если злоумышленник получит возможность выполнить произвольный код, seccomp не даст ему использовать системные вызовы, которые не были заранее объявлены. Seccomp - разработка Google. Он используется, в частности, в браузере Google Chrome для запуска плагинов.

### 1.3 Настройка опций усиления безопасности для Docker

- **Ограничения Docker Engine**

Вспомним, что Docker Engine - это своего рода API, который прослушивает все входящие запросы и взаимодействует с базовым ядром хоста. Docker Engine поддерживает связь на трех сокетах: `unix`, `tcp` и `fd`.

Безопасное состояние по умолчанию - это прослушивание сокета `unix`.

- **Выставляем ограничение на привилегии выполнения**

- Чтобы привилегии контейнера были эквиваленты правам обычного пользователя, создайте для ваших контейнеров изолированное пользовательское пространство имен. По возможности избегайте выполнения контейнеров с uid 0.
- Привилегии, которые не нужны приложению, должны быть сняты.
- CAP_SYS_ADMIN в плане безопасности особенно коварна, поскольку дает право на выполнение значительного количества операций уровня суперпользователя: монтирование файловых систем, вход в пространства имен ядра, операции ioctl.
- Если без привилегированного контейнера все же не обойтись, убедитесь, что он устанавливается из доверенного репозитория.
- Внимательно следите за случаями монтирования потенциально опасных ресурсов хоста: **/var/run/docker.sock**), **/proc**, **/dev** и т. д. Обычно эти ресурсы нужны для выполнения операций, связанных с базовой функциональностью контейнеров. Убедитесь, что вы понимаете, почему и как необходимо ограничивать доступ процессов к этой информации. Иногда достаточно лишь установки режима «только чтение». Никогда не давайте права на запись, не задавшись вопросом, зачем нужно это право. В любом случае Docker использует copy-on-write, чтобы предотвратить попадание изменений, произошедших в выполняющемся контейнере, в его базовый образ и потенциально в другие контейнеры, которые будут созданы на базе этого образа.

Чтобы максимально уменьшить площадь потенциальной атаки, подумай над следующими вопросами:

- Какое сетевое подключение требуется для работы приложения и вообще требуется ли оно?
- Нужен ли приложению прямой доступ к сокету?
- Требуется ли приложению отправлять и получать UDP-запросы?

Для настройки ограничений будем использовать команды `--cap-drop and` и `--cap-add`.

Предположим, приложению абсолютно не требуется изменять системные процессы или биндить привилегированные порты, но при этом нужно загружать и выгружать модули ядра.

```bash
docker run \\
  --cap-drop SETPCAP \\
  --cap-drop NET_BIND_SERVICE \\
  --cap-add SYS_MODULE \\
  -ti busybox /bin/sh
```

Для обеспечения безопасности сетевого взаимодействия можно настроить правила iptables, реализованные в Docker. Например, указать диапазон IP-адресов для источника пакетов, чтобы ограничить трафик на контейнер. Это поможет предотвратить обращение глубоко изолированного контейнера во внешнюю сеть.

- **Ограничиваем потребление системных ресурсов**

Чтобы откалибровать пул ресурсов, выделяемых для контейнера (CPU, RAM, SWAP, I/O), нужно задать пороговые значения следующими флагами:

- `-m`, `--memory` — установить лимит выделения оперативной памяти (hard);
- `--memory-reservation` — установить мягкий лимит памяти (soft);
- `--kernel-memory` — установить лимит памяти ядра (kernel OS);
- `--cpus` — ограничить количество используемых CPU;
- `--device-read-bps` — ограничить пропускную способность чтения для конкретного устройства.

### 1.4 Легитимность используемых образов

Легитимность использования образов для развертывания контейнеров - один из ключевых критериев безопасности.

1. [Clair](https://coreos.com/clair) - это проект с открытым исходным кодом для статического анализа уязвимостей в контейнерах [appc](http://github.com/appc/spec) и [docker](https://github.com/moby/moby/blob/master/image/spec/v1.md). Данные об уязвимостях постоянно импортируются из известных источников и соотносятся с индексированным содержимым образов контейнера, чтобы сформировать списки уязвимостей, угрожающих каждому контейнеру в отдельности.

2. Еще одна похожая утилита носит название [Dagda](https://github.com/eliasgranderubio/dagda). Это инструмент для статического анализа известных уязвимостей, поиска троянов, вирусов, вредоносных программ, а также других угроз в образах и контейнерах Docker. Кроме того, Dagda используется для мониторинга сетевых служб Docker и запуска контейнеров в целях обнаружения аномальных действий. Проверка зависимостей основана на проектах [OWASP](https://www.owasp.org/index.php/Main_Page) и [Retire.js](https://retirejs.github.io/retire.js/) для анализа безопасности таких слоев, как Java, Python, Node.js, JS, Ruby, PHP.

## 2 Безопасность кластера Kubernetes

### 2.1 Типовые векторы атак на K8s

![](/materials/images/devops/k8s_attacks.png)

### 2.2 Проблемы безопасности K8s

Типичные проблемы безопасности в инфраструктуре кластера **K8s:**

- **Explosion of East-West Traffic**, или атака «Взрыв трафика Восток - Запад».

Суть этой атаки заключается в том, что контейнеры могут быть динамически развернуты в нескольких независимых друг от друга облаках, что значительно увеличивает трафик обмена данными внутри логического кластера. Это похоже на перегон поездов по железной дороге, и именно поэтому данный вид атак получил название «С востока на запад». Удаленное расположение контейнеров может использоваться злоумышленниками, например, для реализации DDoS-атак.

- **Increased Attack Surface** (увеличенная площадь атаки).

Проблема основывается на том, что каждый контейнер может иметь различную поверхность атаки и собственные уникальные уязвимости, которые используются хакерами для дальнейшего взлома. К примеру, могут использоваться уязвимости для Docker или системы авторизации AWS.

- **Container compromise** (компрометация контейнера).

Суть атаки кроется в использовании неверной конфигурации (security misconfiguration) для всех контейнеров кластера, которые косвенным образом способствуют компрометации или же включают в себя уязвимости приложений. К компрометациям контейнера относятся манипуляции внутренней коммутацией, управлением процессами или доступом к файловой системе.

- **Unauthorized connections between pods** (несанкционированные соединения между подами внутри единого кластера).

Скомпрометированные контейнеры могут соединяться с другими контейнерами на том же или на других хостах, чтобы запустить какую-либо атаку. Несмотря на то что фильтрация на уровне L3 (ACL-листы) обеспечивается сетевым оборудованием согласно настроенным правилам, некоторые неавторизованные обращения могут быть обнаружены только с помощью фильтрации на седьмом уровне модели OSI.

### 2.3 Примеры критических ошибок

- [CVE-2019-5736](https://nvd.nist.gov/vuln/detail/CVE-2019-5736)

Он позволяет вредоносному контейнеру перезаписать исполняемый файл runC на хост-системе, при этом никакого взаимодействия с пользователем не требуется. В результате подобной атаки злоумышленник может получить root-доступ к хосту и возможность исполнять на нем произвольный код. В феврале 2019 года эксплоит для CVE-2019-5736 был опубликован на [GitHub](https://github.com/Frichetten/CVE-2019-5736-PoC).

- [CVE-2019-11246](https://www.sdxcentral.com/articles/news/kubernetes-kubectl-cli-tool-stung-by-high-severity-security-flaw/2019/03/)

Он позволяет атакующему доставлять файлы из пода на компьютер оператора или модифицировать их с помощью подмены tar binary, используя обычную внутреннюю команду kubectl cp.

- [CVE-2018-1002105](https://nvd.nist.gov/vuln/detail/CVE-2018-1002105)

Он позволяет атакующему повысить привилегии в кластере и получить к нему доступ из-за логической ошибки обработки API-вызовов. Эксперты по безопасности оценили уязвимость в 9,8 балла по шкале CVSS, поскольку брешь не требует предварительной аутентификации и проста в эксплуатации. Несанкционированный доступ открывается после отправки специфического запроса к API-серверу Kubernetes. Все уязвимые сборки Kubernetes некорректно обрабатывают вредоносный запрос, позволяя обратиться к бэкенду с использованием учетных данных TLS, прописанных в настройках API-сервера. Через несколько дней после обнаружения проблемы PoC-эксплоит был [опубликован на GitHub](https://github.com/gravitational/cve-2018-1002105). Позже выпустили [патч](https://access.redhat.com/security/vulnerabilities/3716411), закрывающий эту уязвимость.

- **Еще один громкий кейс**, связанный с K8s, имел место в 2018 году. Речь идет о взломе аккаунта всем известной компании Tesla в облаке Amazon Web Services. Как позже выяснили эксперты, учетные данные в одном из подов Kubernetes открыли доступ к среде AWS Tesla, которая содержала корзину Amazon S3. В ней, в свою очередь, хранились конфиденциальные данные, в том числе телеметрия. Однако вместо кражи этих данных хакеры начали майнить криптовалюту на одном из подов Tesla.

### 2.4 Общие советы и рекомендации по безопасности

1. **Использование шифрования TLS повсеместно.** Для каждого компонента инфраструктуры K8s, поддерживающего протокол TLS, необходимо включить его использование. Это обеспечит защиту от осуществления прослушивания трафика, подделки удостоверения сервера и, в случае взаимного TLS, проверки удостоверения клиента.
2. **Применение RBAC-ориентированной модели доступа и предоставление минимально возможных привилегий.** Управление доступом на основе ролей (Role-Based Access Control, RBAC) обеспечивает точное управление политиками, с помощью которых пользователи получают доступ к ресурсам, таким как пространства имен.
3. **Использование внешней аутентификации для API сервера.** Централизованная аутентификация и авторизация для всей компании, например, на основе LDAP и Single Sign-On, помогает выдавать и отзывать права для сотрудников предприятия.
4. **Изоляция кластера ETCD за сетевым экраном.** Поскольку кластер ETCD содержит информацию о состоянии Kubernetes и секретные данные доступа (токены, сертификаты), он является критическим компонентом K8s. Поэтому ETCD должен быть защищен отдельно от остального кластера, предпочтительно с использованием файрвола и изолированной виртуальной частной сети (VPC).
5. **Систематическая ротация ключей шифрования.** Регулярное обновление (в соответствии с сроком и по событию) безопасных ключей и сертификатов - одна из лучших практик для обеспечения безопасности любой IT-системы. Это позволяет сократить возможные последствия компрометации доступа к ключу.
6. **Регулярный статический анализ YAML-файлов конфигурации.** Конфиденциальная информация, представленная в формате YAML, не должна храниться в открытом виде внутри подов. Конфиденциальные настройки и секреты доступа (пароли) должны быть зашифрованы с использованием инструментов, таких как `git-crypt`. Статический анализ YAML-конфигурации может использоваться для определения базовых параметров безопасности, и такой анализ следует проводить регулярно.
7. **Ограничение запуска контейнеров с учетной записью root.** Часто контейнеры, запускающиеся с правами суперпользователя root, обладают большими привилегиями, чем требуется для выполнения своих рабочих задач, что в случае компрометации позволяет злоумышленникам получить еще больше возможностей.
8. **Обязательное применение сетевых политик.** По умолчанию, в Kubernetes весь трафик между подами разрешен без каких-либо ограничений. Однако с помощью сетевых политик (NetworkPolicy) эту настройку можно ограничить или изменить.

Чтобы повысить безопасность сетевой инфраструктуры в Kubernetes, можно использовать специальный набор флагов:

**Для API-сервера:**

```bash
// Отключение анонимного доступа 
--anonymous-auth=false 

// Разрешение только авторизованных запросов 
--authorizationmode AlwaysAllow

// Форсирование ограничений прав на kubelets, включая NodeRestriction на API server
--admission-control

// Форсирование использования RBAC-модели доступа к объектам K8s
--authorization-mode=RBAC

// Отключение небезопасных портов
--insecure-port=0
```

**Для etcd-сервера:**

```bash
// Форсирование использования защищенного HTTPS connections к серверу etcd
--cert-file and --key-file 

// Включение принудительной авторизации при обращении к etcd
--client-cert-auth=true 

// Использование только подписанных сертификатов
--trusted-ca-file 

// Отключение использования автоподписанных сертификатов
--auto-tls=false 

// Использование только безопасных методов подключения
--peer-client-cert-auth=true
--peer-autotls=false and specify --peer-cert-file, --peer-key-file

// Запуск etcd в защищенном исполнении
--peer-trusted-ca-file

// Форсирование авторизации с использованием сертификатов для API-сервера
--etcd-cafile 
```

### 2.5 Рекомендуемые шаги для усиления безопасности перед развертыванием кластера

- Используй на всю катушку пространства имен (namespaces).
- Форсируй SELinux (хотя бы в продакшен-среде!).
- Используй Seccomp.
- Используй Cgroups.
- Используй минимальное количество запущенных хостов.
- Не забывай про установку обновлений и патчей (обновления ядра, библиотек и так далее).
- Периодически запускай тесты безопасности CIS Benchmark для контроля состояния защищенности.

### 2.6 Утилиты для аудита безопасности

Аудит безопасности Kubernetes для эффективной комплексной оценки должен включать в себя несколько следующих областей:

- безопасность конечных хостов (Host security);
- безопасность мастер-ноды и API-сервера Kubernetes (Master node Kubernetes security);
- безопасность демонов Docker (Docker daemon security);
- контейнерную безопасность (Container security);
- правила использования модели RBAC-доступа (Properly configured RBACs);
- безопасность хранимых и передаваемых данных (Securing data at rest and in transit).

1. Утилитка-сканер [kube-bench](https://github.com/aquasecurity/kube-bench) — это шустрое приложение, написанное на Go, которое проверяет, насколько безопасно развернут Kubernetes. Для этого kube-bench прогоняет все проверки, описанные в тесте [CIS Kubernetes](https://releases.rancher.com/documents/security/latest/Rancher_Benchmark_Assessment.pdf). Тесты настраиваются с помощью файлов YAML, что позволяет легко обновлять их по мере развития спецификаций.
2. Еще одна утилита — [Kubeaudit](https://github.com/Shopify/kubeaudit) — это инструмент командной строки для аудита кластеров Kubernetes на предмет различных проблем безопасности. Поддерживает проверку множества опций, к примеру таких, как запуск контейнеров под учетной записью root, хранение секретов доступа (токены, сертификаты), возможность записи в корневую директорию.
3. [Kubesec](https://kubesec.io/) — инструмент управления секретами доступа для Kubernetes с поддержкой таких сервисов, как GPG, Google Cloud KMS и AWS KMS backends. Служба оценивает, насколько ресурсы Kubernetes используют возможности для повышения безопасности. Пользователь получает рекомендации, как повысить общую безопасность системы.

### 2.7 Безопасность сетевого взаимодействия

1. Решение [Calico](https://docs.projectcalico.org/v3.1/introduction/) обеспечивает безопасное сетевое взаимодействие между контейнерами и виртуальными машинами в одном кластере. По сути, Сalico представляет собой софтовый свитч (Softswitch), который создает сеть третьего уровня и управляет ею, назначая каждому инстансу полностью маршрутизируемый IP-адрес. В средах, где требуется наложение, Calico использует туннелирование IP-in-IP, что позволяет работать с другими наложенными сетями.

2. Еще одно полезное приложение — [Cilium](https://cilium.io/) представляет собой контейнерный межсетевой экран. Программа использует технологию ядра Linux BPF для фильтрации, детекта, мониторинга и перенаправления данных с использованием вызовов ядра. Cilium помогает развертывать политики доступа к сети на основе идентификатора контейнера с использованием меток тегов. Помимо этого, софтина интерпретирует несколько протоколов уровня 7, таких как HTTP или [gRPC](https://grpc.io/), что позволяет использовать набор вызовов REST.
