# Мониторинг

Мониторинг инфраструктуры - это процесс постоянного отслеживания и анализа состояния компонентов инфраструктуры, таких как серверы, сети, приложения и базы данных. Он позволяет обнаруживать проблемы и сбои в работе системы, а также прогнозировать возможные проблемы в будущем.

Основные цели мониторинга инфраструктуры:

1. Обнаружение проблем: Мониторинг позволяет быстро обнаруживать проблемы в работе системы, что помогает предотвратить серьезные сбои и минимизировать время простоя.
2. Прогнозирование проблем: Мониторинг позволяет анализировать данные о работе системы и прогнозировать возможные проблемы в будущем. Это помогает предотвратить сбои и оптимизировать работу системы.
3. Улучшение производительности: Мониторинг позволяет выявить узкие места в работе системы и оптимизировать ее производительность.
4. Управление ресурсами: Мониторинг позволяет контролировать использование ресурсов системы и оптимизировать их использование.
5. Обеспечение безопасности: Мониторинг позволяет обнаруживать потенциальные угрозы безопасности и предотвращать их.

## 1 Что означает мониторинг контейнеров?

Системы мониторинга помогают командам DevOps быстрее обнаруживать и решать проблемы с производительностью. Поскольку Docker и Kubernetes постоянно развиваются, важно с самого начала обеспечить мониторинг контейнеров и управление журналами.

Мониторинг Docker-контейнеров очень сложен. Разработать стратегию и построить соответствующую систему мониторинга совсем непросто.

## 2 Почему нужно мониторить контейнеры?

Мониторинг контейнеров в режиме реального времени необходим для обеспечения максимальной производительности приложения. Однако когда дело доходит до контейнеров Docker, мониторинг помогает решать следующие задачи:

- Выявлять и устранять проблемы на ранней стадии, чтобы избежать рисков в проекте.
- Безопасно внедрять изменения, поскольку вся среда контролируется.
- Точечно настраивать приложения для повышения производительности и удобства работы пользователей.
- Оптимизировать распределение ресурсов.

## 3 Что означает мониторинг кластеров Kubernetes?

Мониторинг Kubernetes - это процесс непрерывного отслеживания, измерения и анализа характеристик производительности, работоспособности и стоимости контейнерных приложений, работающих в кластере Kubernetes.

Целью мониторинга в DevOps часто является упреждающее обеспечение оптимальной производительности и работоспособности контейнеров, чтобы предотвратить влияние проблем на качество обслуживания клиентов.

## 4 Почему нужно мониторить кластеры Kubernetes?

Возможности мониторинга Kubernetes:

- Позволяет постоянно отслеживать изменения в высокораспределенных и динамичных средах K8s.
- Помогает оценить влияние таких изменений с учетом контекста, чтобы предотвратить нежелательные аномалии или простои.
- Помогает визуализировать, как все контейнеры и другие компоненты работают вместе.
- Позволяет выявлять и устранять угрозы безопасности и требования соответствия Kubernetes до того, как они станут проблемой.
- Позволяет отслеживать использование ресурсов в Kubernetes и связанные с этим затраты, чтобы можно было более точно их распределять.
- Помогает обнаружить коренные причины аномалий производительности, безопасности и затрат в установке K8s, что позволяет сократить время простоя.
- Позволяет отслеживать пользовательский опыт, чтобы оптимизировать его для целевых клиентов.
- Обеспечивает непрерывность бизнеса, обнаруживая проблемы до их возникновения.
- Повышает прозрачность сети Kubernetes, позволяя вам оценить конфигурацию и производительность ваших коммутаторов, маршрутизаторов, серверов, виртуальных машин и других компонентов.

## 5 Какие метрики нужно собирать, при мониторинге кластеров Kubernetes?

Метрики мониторинга помогают анализировать работу приложений и контейнеров K8s после развертывания. Существует несколько показателей мониторинга Kubernetes, которые необходимо отслеживать, в том числе те, которые указывают:

- Состояние кластера Kubernetes, такое как его состояние, запущенные контейнеры, сетевой ввод/вывод и индикаторы потребления ресурсов.
- Время ответа на запросы к API.
- Запуск и развертывание подов Kubernetes.
- Метрики ресурсов, такие как загрузка ЦП, использование памяти и использование диска как на уровне узла, так и на уровне пода.
- Метрики плоскости управления, такие как хранилища данных etcd, серверы API, жизненные циклы контроллеров и состояние планировщика.
- Контейнерные и прикладные метрики.

Тем не менее, как вы собираете и анализируете метрики Kubernetes?

Команды инженеров делают это, оценивая различные уровни абстракции, такие как контейнеры, поды, узлы и кластеры Kubernetes. Инженеры часто собирают как можно больше показателей, прежде чем они смогут сосредоточиться на выбранных ключевых показателях эффективности (KPI), которые соответствуют их уникальным потребностям в мониторинге K8s.

В целом метрики Kubernetes собираются одним из двух способов:

1. Использование DaemonSets:

DaemonSets - это класс Kubernetes, которые запускают копии необходимых подов на всех узлах. При этом на всех нужных подах запускается агент мониторинга для сбора показателей работоспособности и производительности. Многие инструменты используют этот подход, поскольку DaemonSets легко подготовить к использованию.

2. Использование сервера метрик:

Инженеры устанавливают сервер метрик как обычный под внутри кластера Kubernetes для сбора данных и событий из модулей и контейнеров внутри кластера. До прекращения поддержки сервером метрик использовался Heapster. Серверы метрик - отличный выбор, если вы работаете с большими рабочими нагрузками, поскольку они могут отслеживать кластеры, содержащие до 5000 узлов.

## 6 Системы мониторинга

### 6.1 Sematext

Sematext Monitoring - это полнофункциональное решение для наблюдения с возможностями мониторинга Docker и Kubernetes. Он предоставляет более полную и простую в настройке панель мониторинга метрик, событий и журналов, предоставляющую полезную информацию о контейнерах и инфраструктуре. Sematext обеспечивает полную видимость для оркестраторов контейнеров и контейнеров, если вам нужно комплексное решение для ведения журналов и мониторинга. Тем не менее, он также совместим с традиционными системами.

Вы можете собирать все события, журналы и метрики, работающие в кластере Kubernetes, структурировать их и визуализировать на настраиваемых панелях мониторинга. Все это происходит в режиме реального времени.

С помощью Sematext вы также можете обнаруживать аномалии в режиме реального времени и получать оповещения о проблемах на уровне модуля. Помимо мониторинга использования ресурсов, он также фиксирует пропускную способность сети. Кроме того, его также легко установить в качестве оператора Sematext, DaemonSet, Helmchart или оператора Kubernetes.

### 6.2 Datadog

Datadog - это инструмент для мониторинга и аналитики, используемый для отслеживания производительности и состояния контейнерных сред, таких как Docker и Kubernetes. Он позволяет отслеживать такие метрики, как использование CPU и памяти, сетевой трафик, а также состояние контейнеров.

Datadog позволяет видеть содержимое приложений или стеков из любого места и в любом масштабе. Он предлагает комплексные услуги DevOps, включая сеть, безопасность и мониторинг в реальном времени. Он также обеспечивает управление журналами, включая фильтры, функции поиска и инструмент анализа журналов для устранения неполадок.

Мониторинг инфраструктуры Datadog на базе SaaS предоставляет метрики, визуализацию и оповещения, чтобы команда могла поддерживать, оптимизировать и защищать облачные или гибридные среды. Благодаря широкому охвату популярных технологий, простому процессу развертывания, минимальному обслуживанию и удобному интерфейсу, Datadog помогает эффективно общаться и устранять неполадки. Он также предлагает глубокий анализ безопасности, что дополнительно обеспечивает защиту вашей инфраструктуры.

Все, что необходимо, для мониторинга контейнеров - это установить агент Datadog. Следует иметь в виду, это то, что ограничение по умолчанию составляет 350 метрик на отслеживаемый экземпляр.

Инструмент предлагает полный доступ к API для всех приложений и инфраструктуры для повышения наглядности. Кроме того, его можно запустить на каждом узле кластера с помощью DaemonSet.

### 6.3 Dynatrace

Dynatrace также представляет собой полнофункциональное решение для наблюдения, которое обеспечивает удобный подход к мониторингу показателей и журналов ваших контейнеров Docker и кластерной инфраструктуры Kubernetes. Вы можете использовать его для мониторинга доступности и работоспособности приложений и процессов, зависимостей и соединений между хостами, контейнерами и облачными экземплярами.

Доступный как в модели «программное обеспечение как услуга» (SaaS), так и в локальной модели, он удовлетворит большинство ваших потребностей в мониторинге.

Dynatrace позволяет исследовать использование ресурсов контейнера на отдельных хостах так же, как в противном случае вы могли бы это сделать, только выполнив команду статистики Docker. Вы получаете доступ к метрикам Docker, таким как использование ЦП, RSS и использование кэш-памяти, как входящий, так и исходящий сетевой трафик, а также общее время, в течение которого использование ЦП контейнером было ограничено.

Dynatrace позволяет вам объединить и использовать информацию из более чем 500 различных инструментов, которые вы, вероятно, уже используете, включая AWS, Azure, OpenShift, Google Cloud и Kubernetes, среди других. Более того, он использует события, трассировки, метрики и информацию о поведении, чтобы раскрыть внутреннюю работу приложений Kubernetes.

### 6.4 Prometheus

Prometheus - это база данных временных рядов с открытым исходным кодом. Однако к нему можно подключить множество различных инструментов, чтобы расширить функционал. Prometheus мониторит самые разные системы: серверы, базы данных, отдельные виртуальные машины.

У Prometheus есть заметное отличие от других баз данных временных рядов: он активно сканирует целевые объекты, чтобы получить у них метрики. Также сочетает в себе мощный язык запросов (PromQL) с многомерной моделью данных, в отличие от альтернативных баз данных временных рядов, таких как InfluxDB, Cassandra и Graphite.

InfluxDB, например, работает иначе: вы сами напрямую отправляете ему данные.

Он считается более современным инструментом, который используют, когда требуется решение для мониторинга базы данных с временными показателями и нужно долговременное хранилище для метрик. Есть версия, которая включает хранение ваших данных в течение одного года, полную настройку панели управления Grafana для визуализации данных и многое другое.

Не имеет встроенного инструмента визуализации.

### 6.5 Grafana

Grafana - это платформа с открытым исходным кодом для визуализации, мониторинга и анализа данных. Grafana позволяет пользователям создавать дашборды с панелями, каждая из которых отображает определенные показатели в течение установленного периода времени. Каждый дашборд универсален, поэтому его можно настроить для конкретного проекта или с учетом любых потребностей разработки и/или бизнеса.

Grafana лишь монитор. Для работы платформы необходима база данных. Зачастую Grafana можно увидеть в связке с Prometheus.

Предлагает надежные оповещения, может запрашивать несколько объектов одновременно, поддерживает Elasticsearch и совместим со многими источниками данных. Grafana также позволяет просматривать журналы логов.

### 6.6 Loki

Loki - это горизонтально масштабируемая, высокодоступная, многопользовательская система агрегирования логов, вдохновленная Prometheus. Он спроектирован так, чтобы быть очень экономичным и простым в эксплуатации. Он индексирует не содержимое журналов, а набор меток для каждого потока журналов.

Проект Loki был запущен в Grafana Labs в 2018 году и анонсирован на KubeCon Seattle. Loki выпускается под лицензией AGPLv3.

### 6.7 Promtail

Promtail - это агент, который отправляет содержимое локальных журналов в локальный экземпляр Grafana Loki или Grafana Cloud. Обычно он развертывается на каждой машине, на которой работают приложения, которые необходимо отслеживать. В настоящее время Promtail может отслеживать журналы из двух источников: локальных файлов журналов и журнала systemd (только на машинах AMD64).

Прежде чем Promtail сможет отправить какие-либо данные из файлов журналов в Loki, ему необходимо найти информацию о своей среде. В частности, это означает обнаружение приложений, отправляющих строки журнала в файлы, которые необходимо отслеживать.

### 6.8 cAdvisor

cAdvisor - сокращенно от «Container Advisor», - это сборщик метрик с открытым исходным кодом, созданный Google для анализа и предоставления данных об использовании ресурсов и производительности запущенных контейнеров. Он также предоставляет готовые метрики Prometheus.

cAdvisor автоматически обнаруживает активные контейнеры, поэтому вы можете отслеживать их показатели, такие как использование ЦП, сети и памяти (на уровне узла, а не для каждого модуля). Однако, как и в случае с панелью управления Kubernetes, она в первую очередь ориентирована на сбор метрик, а не журналов событий, трассировок и событий, и не хранит долгосрочные данные.

В репозитории Github говорится: «cAdvisor (Container Advisor) предоставляет пользователям контейнеров понимание использования ресурсов и характеристик производительности их работающих контейнеров».

Проще говоря, это означает, что cAdvisor работает как демон и собирает, агрегирует, обрабатывает и экспортирует информацию о контейнерах. Он сохраняет параметры изоляции ресурсов, историческое использование ресурсов, гистограммы полного исторического использования ресурсов и сетевую статистику для каждого контейнера. Эти данные экспортируются по контейнерам и по всему компьютеру.

### 6.9 Node Exporter

Node Exporter - это программное обеспечение, которое можно установить на ядро NIX (Linux, OpenBSD, FreeBSD или Darwin) и оно будет отслеживать системные метрики. Используя эти метрики, можно строить графики и создавать оповещения о возможных инцидентах. Для обработки оповещений, как правило, используется Alertmanager. Он предоставит метрики, которые Prometheus сможет затем получить.

Node Exporter применяется для мониторинга состояния и производительности отдельных серверов или узлов в кластере. Это позволяет выявлять узкие места в использовании ресурсов, обнаруживать сбои оборудования и оптимизировать распределение ресурсов.

В словаре Prometheus это называется экспортером и будет использоваться в качестве цели в конфигурации Prometheus. Prometheus будет подключаться к Node Exporter с использованием TCP-порта 9100 и протокола HTTP через определенные промежутки времени для получения этих показателей.

### 6.10 Kubernetes Dashboard

Kubernetes Dashboard - собственный инструмент мониторинга Kubernetes.

Dashboard - это веб-интерфейс пользователя Kubernetes. Вы можете использовать Dashboard для развертывания контейнерных приложений в кластере Kubernetes, устранения неполадок контейнерного приложения и управления ресурсами кластера. Вы можете использовать Dashboard для обзора приложений, работающих в вашем кластере, а также для создания или изменения отдельных ресурсов Kubernetes (таких как Deployments, Jobs, DaemonSets и т. д.). Например, вы можете масштабировать Deployment, инициировать чередующееся обновление, перезапустить под или развернуть новые приложения с помощью мастера развертывания.

Панель мониторинга также предоставляет информацию о состоянии ресурсов Kubernetes в вашем кластере и обо всех возможных ошибках.

Dashboard нельзя использовать для мониторинга Docker контейнеров.

### 6.11 Zabbix

Zabbix - это система мониторинга ИТ-инфраструктуры. Применяется для выявления и предотвращения потенциальных проблем с оборудованием или в работе сайта, домена приложений.

Система характеризуется широким функционалом, поэтому используется для различных целей.

- Отслеживание бизнес-показателей.
- Контроль состояния устройств и сетевой активности.
- Пинг для проверки доступности узлов.
- Анализ логов и т.д.

Zabbix имеет распределенную архитектуру сервера и клиента, поэтому на каждой стороне клиента необходимо установить Zabbix для сбора и отправки данных на сервер. Подходит при использовании MySQL, MariaDB, PostgreSQL, SQLite, Oracle или IBM DB2 для хранения данных. Есть встроенная функция оповещения (триггер), позволяющая управлять событиями различными способами: отправка сообщений, выполнение удаленных команд и т.д.

### 6.12 DefectDojo

DefectDojo - это открытый инструмент управления уязвимостями с исходным кодом, который помогает командам разработчиков программного обеспечения выявлять, отслеживать и исправлять уязвимости в системе безопасности. Разработанный командой безопасности Rackspace, он сейчас поддерживается сообществом начинающих и экспертов по безопасности.

Этот инструмент предоставляет командам платформу для управления всем процессом управления уязвимостями - от сканирования приложений до отслеживания усилий по исправлению. Он интегрируется с различными инструментами безопасности, включая сканеры, системы отслеживания проблем и создания отчетов, что обеспечивает комплексное решение для управления уязвимостями в системе безопасности.

С помощью DefectDojo команды могут легко планировать автоматическое сканирование своих приложений и выявлять уязвимости в реальном времени. Платформа позволяет командам совместно работать над устранением дефектов и отслеживать прогресс, чтобы гарантировать оперативное исправление уязвимостей. Кроме того, DefectDojo предоставляет централизованное хранилище данных об уязвимостях, позволяя командам легко отслеживать тенденции и определять области для улучшения.