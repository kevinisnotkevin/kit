# IPTABLES

Firewall (межсетевой экран, брандмауэр) - программа, которая осуществляет контроль и фильтрацию проходящего через него сетевого трафика в соответствии с заданными правилами.

Брандмауэр используется для:  
- Фильтрации трафика
- Журналирования сетевой активности
- Отравки уведомлений при обнаружении подозрительной сетевой активности
- Анализа использования портов и сетевых подключений

iptables - утилита Linux, выполняющая функции межсетевого экрана. 

![](materials/images/linux/iptables.png)
- Схема путей пакетов через iptables

Настройка iptables производится в командной строке, с помощью правил iptables можно разрешать или блокировать прохождение трафика. Когда происходит попытка установления соединения с текущей машиной, iptables просматривает список правил в списке, чтобы понять, как нужно поступить в этом случае. Если правила нет, то выполняется действие по умолчанию.  

Tables (таблицы) - файлы, которые объединяют похожие действия. Таблица состоит из нескольких цепочек.  

Chains (цепочки) - цепочки правил. Когда пакет получен, iptables находит соответствующую таблицу, затем пропускаетего через цепочку правил, пока не найдет совпадение.  

Rules (правила) - утверждение, которое указывает системе, что делать с пакетом. Правила могут блокировать пакеты одного типа или пересылать пакеты другого типа.  
  
Targets (цели, действия) - решение о том, что делать с пакетом. Обычно это принятие, отбрасывание или отклонение (при этом отправителю посылается ошибка).

```bash
service iptables save
```
- Для сохранения цепочек нужно выполнить команду. Если не сохранить правила, то они будут действовать только до первой перезагрузки, после которой настройки будут сброшены, и всё придётся настраивать заново

# Флаги

```bash
-A - добавить правило в конец цепочки. В качестве параметра указывается имя цепочки INPUT, OUTPUT или FORWARD
-C - проверить все правила
-D - удалить правило с указанным номером из заданной цепочки
-I - вставить правило в указанную первым аргументом цепочку под номером, заданным во втором параметре. Если номер равен 1, то правило станет первым в цепочке
-L - просмотреть содержимое указанной цепочки
-S - вывести все правила
-F - удалить все правила из цепочки
-N - создать цепочку
-X - удалить цепочку
-R - заменить правило с указанным номером в цепочке
-E - переименовать цепочку
-V - отобразить версию
-P - установить действие по умолчанию
-p - указать протокол, один из tcp, udp, udplite, icmp, icmpv6,esp, ah, sctp, mh
-s - указать ip адрес устройства-отправителя пакета
-d - указать ip адрес получателя
-i - определяет сетевой интерфейс, с которого данные были получены. Здесь можно использовать INPUT, FORWARD или PREROUTING
-o - задает интерфейс, на который направляется пакет. Здесь можно указывать OUTPUT, FORWARD или POSTROUTING
-j - операция, которая должна быть выполнена над пакетом. В качестве аргументов можно указать следующие значения (рассмотрим только основные): а) LOG — поместить в журнал запись о получении пакета; б) REJECT — отправителю будет направлено сообщение об ошибке; в) DROP — удалить пакет; г) BLOCK — блокировать пакеты
-v - вывести более подробную информацию
-x - отобразить точные значения
-g - переход к другой цепочке правил
```
- Основные флаги

# Виды пакетов  

Все пакеты делятся на три типа: входящие, исходящие и проходящие. Входящие - это те, которые были отправлены на этот компьютер, исходящие - отправленные из этого компьютера в сеть. А проходящие - это пакеты, которые просто должны быть пересланы дальше, например, если ваш компьютер выступает в качестве маршрутизатора.

Input - обрабатывает входящие пакеты и подключения. Например, если какой-либо внешний пользователь пытается подключиться к вашему компьютеру по ssh или любой веб-сайт отправит вам свой контент по запросу браузера. Все эти пакеты попадут в эту цепочку.

forward - эта цепочка применяется для проходящих соединений. Сюда попадают пакеты, которые отправлены на ваш компьютер, но не предназначены ему, они просто пересылаются по сети к своей цели. Такое наблюдается на маршрутизаторах или, например, если ваш компьютер раздает wifi.
  
output - эта цепочка используется для исходящих пакетов и соединений. Сюда попадают пакеты, которые были созданы при попытке выполнить ping 8.8.8.8 или когда вы запускаете браузер и пытаетесь открыть любой сайт.

# Таблицы  

Над цепочками правил в iptables есть еще один уровень абстракции, и это таблицы. В системе есть несколько таблиц, и все они имеют стандартный набор цепочек input, forward и output. Таблицы предназначены для выполнения разных действий над пакетами, например для модификации или фильтрации.

- raw - предназначена для работы с сырыми пакетами, пока они еще не прошли обработку
- mangle - предназначена для модификации пакетов
- nat - обеспечивает работу nat, если вы хотите использовать компьютер в качестве маршрутизатора
- filter - основная таблица для фильтрации пакетов, используется по умолчанию

# Правила и действия (targets)  

Перед тем как перейти к созданию списка правил iptables нужно рассмотреть как они работают и какие бывают. Для каждого типа пакетов можно установить набор правил, которые по очереди будут проверяться на соответствие с пакетом и если пакет соответствует, то применять к нему указанное в правиле действие. Правила образуют цепочку, поэтому input, output и forward называют цепочками, цепочками правил. Действий может быть несколько:

- ACCEPT - разрешить прохождение пакета дальше по цепочке правил
- DROP - удалить пакет
- REJECT - отклонить пакет, отправителю будет отправлено сообщение, что пакет был отклонен
- LOG - сделать запись о пакете в лог файл
- QUEUE - отправить пакет пользовательскому приложению
  
Правила могут проверять любые соответствия, например, по ip, по порту получателя или отправителя, заголовкам пакета и многому другому. Если пакет не подходит ни одному из правил, то к нему применяется действие по умолчанию, обычно ACCEPT.

Когда мы разобрались с правилами, можно вернутся обратно к цепочкам. Кроме перечисленных выше, есть еще две дополнительные цепочки правил:
- prerouting - в эту цепочку пакет попадает перед обработкой iptables, система еще не знает куда он будет отправлен, в input, output или forward
- postrouting - сюда попадают все проходящие пакеты, которые уже прошли цепочку forward

Таблица filter

|Действие|Описание|
|---|---|
|ACCEPT|Разрешает пакет.|
|DROP|Запрещает пакет.|
|REJECT|Запрещает с отправкой сообщения источнику.|

Таблица nat

|Действие|Описание|
|---|---|
|MASQUERADE|Для исходящих пакетов заменяет IP-адрес источника на адрес интерфейса, с которого уходит пакет.|
|SNAT|Аналогично MASQUERADE, но с указанием конкретного сетевого интерфейса, чей адрес будет использоваться для подмены.|
|DNAT|Подмена адреса для входящих пакетов.|
|REDIRECT|Перенаправляет запрос на другой порт той же самой системы.

Таблица nagle

| Действие | Описание                                                                 |
| -------- | ------------------------------------------------------------------------ |
| TOS      | Видоизменение поля TOS (приоритезация трафика).                          |
| DSCP     | Изменение DSCP (тоже приоритезация трафика).                             |
| TTL      | Изменение TTL (время жизни пакета).                                      |
| HL       | Аналогично TTL, но для IPv6.                                             |
| MARK     | Маркировка пакета. Используется для последующей фильтрации или шейпинга. |
| CONNMARK | Маркировка соединения.                                                   |
| TCPMSS   | Изменение значения MTU.                                                  |

# Состояния соединений  

Можно ограничивать подключения к службам на основе состояния их подключения.

- NEW - Пакет, запрашивающий новое соединение, например, HTTP-запрос
- ESTABLISHED - Пакет, являющийся частью уже существующего соединения
- RELATED - Пакет, запрашивающий новое соединение, но являющийся частью существующего соединения. Например, FTP использует порт 21 для установления соединения, но данные передаются через другой порт (обычно порт 20)
- INVALID - Пакет, который не является частью какого-либо соединения в таблице отслеживания соединений

# Практика

## Отклонить все исходящие сетевые подключения

```bash
iptables -F OUTPUT
iptables -A OUTPUT -m state --state ESTABLISHED -j ACCEPT
iptables -A OUTPUT -j REJECT
```
- Вторая строка правил разрешает только текущие исходящие и установленные соединения. Это очень полезно, когда вы вошли на сервер через ssh или telnet

## Отклонение всех входящих сетевых подключений

```bash
iptables -F INPUT
iptables -A INPUT -m state --state ESTABLISHED -j ACCEPT
iptables -A INPUT -j REJECT
```

## Отклонение всех сетевых подключений

```bash
iptables -F  
iptables -A INPUT -j REJECT  
iptables -A OUTPUT -j REJECT  
iptables -A FORWARD -j REJECT
```
- Это правило отключит и заблокирует все сетевые соединения, входящие или исходящие

## Отклонение входящих запросов ping

```bash
iptables -A INPUT -p icmp --icmp-type echo-request -j DROP
```
- Это правило iptables сбрасывает все входящие запросы ping. Разница между DROP и REJECT заключается в том, что DROP автоматически отбрасывает входящий пакет, тогда как REJECT приведет к возврату ошибки ICMP

## Правило iptables: Разрыв исходящих telnet-соединений

```bash
iptables -A OUTPUT -p tcp --dport telnet -j REJECT
iptables -A INPUT -p tcp --dport telnet -j REJECT

iptables -A OUTPUT -p tcp --dport telnet -j DROP
iptables -A INPUT -p tcp --dport telnet -j DROP
```
- Это правило iptables блокирует любой исходящий трафик на любой хост, порт назначения которого равен 23 (telnet)

```bash
telnet <ip address>
```
- Организация сеанса Telnet-связи с другим компьютером

## Отклонение исходящих ssh-соединений 

```bash
iptables -A OUTPUT -p tcp --dport ssh -j REJECT
```
- Это правило iptables будет отклонять все исходящие соединения, поступающие с локального порта 22 (ssh)

## Отклонение входящих ssh-соединений

```bash
iptables -A INPUT -p tcp --dport ssh -j REJECT
```
- Сброс всех входящих подключений к локальному порту 22 (ssh)

## Отклонение всего входящего трафика, кроме ssh и локальных подключений

```bash
iptables -A INPUT -i lo -j ACCEPT
iptables -A INPUT -p tcp --dport ssh -j ACCEPT
iptables -A INPUT -j REJECT
```
- Эти правила будут отклонять все входящие подключения к серверу, кроме подключений к порту 22 (SSH)

## Прием входящих ssh-соединений с определенного IP-адреса

```bash
iptables -A INPUT -p tcp -s 77.66.55.44 --dport ssh -j ACCEPT
iptables -A INPUT -p tcp --dport ssh -j REJECT
```
- Используя это правило iptables, мы заблокируем все входящие подключения к порту 22 (ssh), кроме хоста с IP-адресом 77.66.55.44. Это означает, что только данный хост сможет использовать ssh

## Прием входящих ssh-соединений с определенного MAC-адреса

```bash
iptables -A INPUT -m mac --mac-source 00:e0:4c:f1:41:6b -p tcp --dport ssh -j ACCEPT
iptables -A INPUT -p tcp --dport ssh -j REJECT
```
- Используя это правило iptables, мы заблокируем все входящие подключения к порту 22 (ssh), кроме хоста с MAC-адресом 00:e0:4c:f1:41:6b. Другими словами, все ssh-соединения будут ограничены одним хостом с MAC-адресом 00:e0:4c:f1:41:6b

## Отклонение входящих подключений на определенном TCP-порту

```bash
iptables -A INPUT -p tcp --dport 3333 -j REJECT
```
- Следующее правило iptables сбрасывает весь входящий трафик на TCP-порту 3333

## Отклонять весь входящий трафик Telnet, кроме указанного IP-адреса

```bash
iptables -A INPUT -t filter ! -s 222.111.111.222 -p tcp --dport 23 -j REJECT 
```
- Следующее правило iptables отклоняет весь входящий трафик Telnet, кроме запроса на соединение с IP-адреса 222.111.111.222

Восклицательный знак, разделенный пробелом со значением параметра, означает, что правило распространяется на все пакеты. Напоминаю, все правила в netfilter распределены по таблицам. Чтобы работать с конкретной таблицей, необходимо использовать ключ -t. t filter. Таблица по умолчанию. С ней работаем, если упускаем ключ -t. Встроены три цепочки - INPUT (входящие), OUTPUT (исходящие) и FORWARD (проходящие пакеты).
 
```bash
iptables -A INPUT -s ! 192.168.0.50 -j DROP
```
- Восклицательный знак инвертирует условие. Запретить соединение всем хостам, кроме указанного

## Отклонять весь входящий трафик ssh, кроме указанного диапазона IP-адресов

```bash
iptables -A INPUT -t filter -m iprange ! --src-range 10.1.1.90-10.1.1.100 -p tcp --dport 22 -j REJECT
```
- Следующее правило iptables отклоняет весь входящий трафик ssh, кроме запроса на соединение из диапазона IP-адресов 10.1.1.90 - 10.1.1.100. Удаление “!” из приведенного ниже правила отклонит весь трафик ssh, исходящий из указанного диапазона IP-адресов

```bash
--src-range – диапазон IP источников; в отличии от --source и --destination позволяет указать диапазон между двумя конкретными адресами, а не подсетью; допустимо инвертирование (!)
```
- Описание флага

## Отклонять весь весь исходящий трафик на конкретный удаленный хост

```bash
iptables -A OUTPUT -d 222.111.111.222 -j REJECT
```
- Следующее правило iptables отклоняет весь исходящий трафик на удаленный хост с указанным IP-адресом

## Записать событие и сбросить

```bash
iptables -A INPUT -i eth1 -s 10.0.0.0/8 -j LOG --log-prefix "IP_SPOOF A: "

iptables -A INPUT -i eth1 -s 10.0.0.0/8 -j DROP
```
- Чтобы записать в журнал движение пакетов перед сбросом, добавим правило
 
```bash
 tail -f /var/log/messages $ grep -i --color 'IP SPOOF' /var/log/messages 
```
- Проверим журнал (по умолчанию /var/log/messages)

## Проверка содержимого

Очень мощной особенностью iptables является возможность проверки содержимого пакетов. Это очень удобно, например, для фильтрации веб-запрос. Можно разрешить доступ к порту 80, но контролировать, чтобы пакеты содержали только допустимые параметры. Допустим, что мы хотим разрешить доступ к FTP-серверу, но при этом быть уверенными, что пользователь не сможет обратиться к файлам /etc/passwd и /etc/shadow.Для этого можно запретить пакеты, в которых есть этот текст. Если хакер попытается послать запрос, содержащий ссылки на эти файлы, то такой пакет будет отклонен. Следующие команды запрещают доступ к этим файлам по протоколу FTP и WWW:
```bash
iptables -A INPUT -m string --string "/etc/passwd" -s 0/0 -d localhost -p tcp --dport 21 -j DROP

iptables -A INPUT -m string --string "/etc/shadow" -s 0/0 -d localhost -p tcp --dport 21 -j DROP

iptables -A INPUT -m string --string "/etc/passwd" -s 0/0 -d localhost -p tcp --dport 80 -j DROP

iptables -A INPUT -m string --string "/etc/shadow" -s 0/0 -d localhost -p tcp --dport 80 -j DROP
```