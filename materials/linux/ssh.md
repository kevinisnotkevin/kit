# SSH

- [**Что такое SSH?**](materials/networks/ssh.md)
- http://tdkare.ru/sysadmin/index.php/Sshd_config

Метапакет SSH базово включает в себя сервер SSH (sshd) в качестве программы-демона, а также несколько утилит:
- ssh - удаленная регистрация и выполнение команд
- scp - передача файлов
- ssh-keygen - для генерации пар SSH-ключей

Чтобы подключиться к удаленному хосту Linux через SSH, соответствующий SSH-сервер должен быть доступен и запущен. Наиболее часто используемый SSH-сервер - это сервер OpenSSH. 

Сразу после окончания разработки система SSH стала активно трансформироваться в закрытый коммерческий продукт в виде версии SSH2. Но благодаря сообществу GNU версии протокола SSH1 и SSH2 были реализованы в виде открытого и свободно распространяемого ПО openSSH.

OpenSSH - это бесплатная реализация протокола Secure Shell (SSH) с открытым исходным кодом, которая обеспечивает безопасную передачу данных и команд по сети. OpenSSH можно настроить, отредактировав файл /etc/ssh/sshd_config.

# Установка

```bash
apt install openssh-server
```
- Установка сервера

## Проверка конфигурации

```
sshd -t
```
- Проверка конфигурации sshd_config позволяет убедиться, что синтаксис и опции корректны. Не должно ничего возвращать

# Пример файла конфигурации /etc/ssh/sshd_config

#TODO: Оформить в виде кода
1. **`# $OpenBSD: sshd_config,v 1.103 2018/04/09 20:41:22 tj Exp $`**
    - Эта строка содержит информацию о версии и истории изменений файла **`sshd_config`**. Обычно она не влияет на настройки SSH, но предоставляет информацию о версии и истории файла.
2. **`# This is the sshd server system-wide configuration file. See sshd_config(5) for more information.`**
    - Это комментарий, объясняющий, что это конфигурационный файл для SSH-сервера, который применяется системно. Ссылка на **`sshd_config(5)`** указывает на руководство по настройке SSH.
3. **`# This sshd was compiled with PATH=/usr/bin:/bin:/usr/sbin:/sbin`**
    - Это комментарий, указывающий на путь (**`PATH`**), используемый при компиляции SSH-сервера. Это может быть полезной информацией для отладки.
4. **`# The strategy used for options in the default sshd_config shipped with OpenSSH is to specify options with their default value where possible, but leave them commented. Uncommented options override the default value.`**
    - Этот комментарий объясняет стратегию настройки параметров в конфигурационном файле SSH (**`sshd_config`**). В основном, параметры указываются с комментариями и значениями по умолчанию, но если параметр разкомментирован, его значение переопределяет значение по умолчанию.
5. **`Include /etc/ssh/sshd_config.d/*.conf`**
    - Эта строка указывает на возможность включения дополнительных конфигурационных файлов из директории **`/etc/ssh/sshd_config.d/`**, имеющих расширение **`.conf`**. Это позволяет разделять настройки на несколько файлов для более удобного управления конфигурацией.
6. **`#Port 22`**
    - Этот параметр определяет порт, на котором SSH-сервер будет слушать запросы. Значение по умолчанию - 22. В данном случае, порт закомментирован, что означает использование значения по умолчанию.
7. **`#AddressFamily any`**
    - Этот параметр определяет семейство адресов, которые будут приниматься сервером. **`any`** означает, что сервер будет слушать все доступные адреса. Также закомментирован.
8. **`#ListenAddress 0.0.0.0`**
    - Этот параметр определяет конкретный IP-адрес, на котором SSH-сервер будет слушать. **`0.0.0.0`** означает, что сервер будет слушать на всех доступных IP-адресах.
9. **`#ListenAddress ::`**
    - Этот параметр аналогичен предыдущему, но определяет IPv6-адреса. **`::`** означает, что сервер будет слушать на всех доступных IPv6-адресах.
10. **`#HostKey /etc/ssh/ssh_host_rsa_key`**
    - Этот параметр определяет путь к файлу, содержащему закрытый ключ RSA, используемый сервером для шифрования и аутентификации. В данном случае, закомментирован.
11. **`#HostKey /etc/ssh/ssh_host_ecdsa_key`**
    - Этот параметр аналогичен предыдущему, но определяет путь к файлу закрытого ключа ECDSA.
12. **`#HostKey /etc/ssh/ssh_host_ed25519_key`**
    - Этот параметр аналогичен предыдущему, но определяет путь к файлу закрытого ключа Ed25519.
13. **`# Ciphers and keying`**
    - Этот комментарий указывает на начало секции, в которой обычно определяются шифры и настройки для ключей шифрования.
14. **`#RekeyLimit default none`**
    - Этот параметр определяет ограничение на переустановку ключей шифрования (**`RekeyLimit`**). В данном случае, значение по умолчанию (**`default`**) не задано, и переустановка ключей отключена (**`none`**).
15. **`# Logging`**
    - Этот комментарий указывает на начало секции, в которой определяются настройки журналирования и логирования.
16. **`#SyslogFacility AUTH`**
    - Этот параметр определяет, в какой системной категории будут сохраняться логи для SSH. В данном случае, логи сохраняются в категории **`AUTH`**.
17. **`#LogLevel INFO`**
    - Этот параметр определяет уровень журналирования (логирования) для SSH-сервера. В данном случае, уровень **`INFO`** указывает на детализированный уровень журналирования.
18. **`# Authentication:`**:
    - Этот комментарий указывает на начало секции конфигурации, связанной с настройками аутентификации.
19. **`# LoginGraceTime 2m`**:
    - Этот параметр определяет максимальное время (2 минуты в данном случае), в течение которого пользователь может войти в систему после установления соединения. По истечении этого времени соединение будет закрыто.
20. **`# PermitRootLogin prohibit-password`**:
    - Этот параметр указывает на разрешение (или запрет) входа пользователя **`root`** в систему. **`prohibit-password`** означает, что вход разрешен только при наличии пароля (без использования ключей).
21. **`# StrictModes yes`**:
    - С этим параметром включен строгий режим проверки прав доступа к домашним каталогам и файлам пользователя. Это улучшает безопасность, требуя правильных прав доступа.
22. **`# MaxAuthTries 6`**:
    - Этот параметр ограничивает количество попыток аутентификации для одного соединения. Если пользователь не сможет аутентифицироваться после 6 попыток, соединение будет разорвано.
23. **`# MaxSessions 10`**:
    - Этот параметр определяет максимальное количество параллельных сеансов, которые пользователь может установить на сервере.
24. **`# PubkeyAuthentication yes`**:
    - Этот параметр разрешает аутентификацию с использованием публичных ключей. Это позволяет пользователям входить в систему, предоставляя дополнительный уровень безопасности.
25. **`# Expect .ssh/authorized_keys2 to be disregarded by default in future.`**:
    - Этот комментарий говорит о том, что файл **`authorized_keys2`** ожидается быть проигнорированным в будущем. Вместо этого, ожидается использование файла **`authorized_keys`**.
26. **`# AuthorizedKeysFile .ssh/authorized_keys .ssh/authorized_keys2`**:
    - Этот параметр определяет список файлов, в которых сервер ищет открытые ключи для аутентификации. В данном случае, указаны файлы **`authorized_keys`** и **`authorized_keys2`** в директории **`.ssh`**.
27. **`# AuthorizedPrincipalsFile none`**:
    - Этот параметр определяет файл, содержащий принципалов, для которых разрешена аутентификация. Значение **`none`** означает, что такой файл не используется.
28. **`# AuthorizedKeysCommand none`**:
    - Этот параметр определяет команду, которая может быть использована для получения списка авторизованных ключей. В данном случае, значение **`none`** указывает на отсутствие такой команды.
29. **`# AuthorizedKeysCommandUser nobody`**:
    - Этот параметр определяет пользователя, от имени которого будет запущена команда **`AuthorizedKeysCommand`**.
30. **`# HostbasedAuthentication no`**:
    - Этот параметр определяет разрешение или запрет аутентификации на основе хостовой аутентификации. В данном случае, аутентификация на основе хоста отключена (**`no`**).
31. **`# IgnoreUserKnownHosts no`**:
    - Этот параметр определяет, будет ли игнорироваться файл **`known_hosts`** в домашнем каталоге пользователя. В данном случае, игнорирование отключено (**`no`**).
32. **`# IgnoreRhosts yes`**:
    - Этот параметр определяет, будут ли игнорироваться файлы **`~/.rhosts`** и **`~/.shosts`**. В данном случае, игнорирование включено (**`yes`**).
33. **`# PasswordAuthentication yes`**:
    - Этот параметр разрешает аутентификацию по паролю. Если установлено значение **`yes`**, то пользователи могут входить, используя пароль.
34. **`# PermitEmptyPasswords no`**:
    - Этот параметр определяет разрешение или запрет использования пустых паролей. Если установлено значение **`no`**, то пустые пароли не разрешены.
35. **`# ChallengeResponseAuthentication no`**:
    - Этот параметр определяет разрешение или запрет аутентификации с вызовом вызовом и ответом. В данном случае, аутентификация вызовом и ответом отключена (**`no`**).
36. **`# Kerberos options`**:
    - Этот комментарий указывает на начало секции опций, связанных с Kerberos аутентификацией.
37. **`# KerberosAuthentication no`**:
    - Этот параметр определяет разрешение или запрет аутентификации с использованием Kerberos. В данном случае, Kerberos аутентификация отключена (**`no`**).
38. **`# KerberosOrLocalPasswd yes`**:
    - Этот параметр определяет, будет ли использоваться Kerberos аутентификация или локальный пароль при аутентификации. Если установлено значение **`yes`**, то после неудачной Kerberos аутентификации будет предложено использовать локальный пароль.
39. **`# KerberosTicketCleanup yes`**:
    - Этот параметр определяет, будет ли сервер удалять Kerberos билеты после завершения сеанса. Если установлено значение **`yes`**, билеты будут удаляться.
40. **`# KerberosGetAFSToken no`**:
    - Этот параметр определяет, будет ли сервер запрашивать AFS (Andrew File System) токены в случае успешной Kerberos аутентификации. Если установлено значение **`no`**, токены не будут запрашиваться.
41. **`# GSSAPI options`**:
    - Этот комментарий указывает на начало секции опций, связанных с GSSAPI аутентификацией.
42. **`# GSSAPIAuthentication no`**:
    - Этот параметр определяет разрешение или запрет аутентификации с использованием GSSAPI. В данном случае, GSSAPI аутентификация отключена (**`no`**).
43. **`# GSSAPICleanupCredentials yes`**:
    - Этот параметр определяет, будет ли сервер автоматически очищать учетные данные GSSAPI после завершения сеанса. Если установлено значение **`yes`**, учетные данные будут очищены.
44. **`# GSSAPIStrictAcceptorCheck yes`**:
    - Этот параметр определяет, будет ли сервер строго проверять допустимость GSSAPI аутентификации на стороне сервера. Если установлено значение **`yes`**, сервер будет строго проверять, что клиент имеет право на аутентификацию.
45. **`# GSSAPIKeyExchange no`**:
    - Этот параметр определяет разрешение или запрет использования GSSAPI для обмена ключами. В данном случае, обмен ключами с использованием GSSAPI отключен (**`no`**).
46. **`# Set this to 'yes' to enable PAM authentication...`**:
    - Этот комментарий объясняет, как работает параметр **`UsePAM`**.
47. **`UsePAM yes`**:
    - Этот параметр определяет, будет ли использоваться аутентификация PAM (Pluggable Authentication Module). Если установлено значение **`yes`**, то PAM будет использоваться для аутентификации, обработки учетных записей и сессий. Это позволяет использовать дополнительные методы аутентификации, определенные в PAM-конфигурации, и выполнять проверки учетных записей и сессий.
48. **`#AllowAgentForwarding yes`**
    - Этот параметр определяет разрешение или запрет передачи агента SSH (SSH agent forwarding). Если установлено значение **`yes`**, то агент SSH будет доступен на сервере для аутентификации с удаленными хостами.
49. **`#AllowTcpForwarding yes`**
    - Этот параметр определяет разрешение или запрет TCP-перенаправления. Если установлено значение **`yes`**, то пользователи могут использовать TCP-перенаправление в своих сеансах SSH.
50. **`#GatewayPorts no`**
    - Этот параметр определяет разрешение или запрет создания прокси-шлюзов с открытыми портами. Если установлено значение **`no`**, то прокси-шлюзы будут доступны только на сервере.
51. **`X11Forwarding yes`**
    - Этот параметр разрешает или запрещает X11 Forwarding, что позволяет пользователю выполнять графические приложения с удаленного сервера. Здесь установлено значение **`yes`**, что разрешает X11 Forwarding.
52. **`#X11DisplayOffset 10`**
    - Этот параметр определяет смещение дисплея X11. Закомментировано, что означает использование значения по умолчанию.
53. **`#X11UseLocalhost yes`**
    - Этот параметр определяет, будет ли использоваться локальный хост для X11 Forwarding. Закомментировано, что означает использование значения по умолчанию.
54. **`#PermitTTY yes`**
    - Этот параметр определяет разрешение или запрет выделения терминала для сеансов SSH. Закомментировано, что означает использование значения по умолчанию.
55. **`PrintMotd no`**
    - Этот параметр разрешает или запрещает вывод сообщения дня (MOTD) при входе пользователя в систему через SSH. Здесь установлено значение **`no`**, что отключает вывод MOTD.
56. **`#PrintLastLog yes`**
    - Этот параметр определяет, будет ли выводиться последний успешный вход пользователя в систему. Закомментировано, что означает использование значения по умолчанию.
57. **`#TCPKeepAlive yes`**
    - Этот параметр определяет разрешение или запрет использования TCP keep-alive для поддержания активности соединения. Закомментировано, что означает использование значения по умолчанию.
58. **`#PermitUserEnvironment no`**
    - Этот параметр определяет разрешение или запрет пользовательских переменных среды. Закомментировано, что означает использование значения по умолчанию.
59. **`#Compression delayed`**
    - Этот параметр определяет метод сжатия данных для SSH-соединения. Здесь используется метод "delayed" (отложенного сжатия). Закомментировано, что означает использование значения по умолчанию.
60. **`#ClientAliveInterval 0`**
    - Этот параметр определяет интервал в секундах для проверки активности клиента. Закомментировано, что означает использование значения по умолчанию.
61. **`#ClientAliveCountMax 3`**
    - Этот параметр определяет максимальное количество проверок активности клиента. Закомментировано, что означает использование значения по умолчанию.
62. **`#UseDNS no`**
    - Этот параметр определяет разрешение или запрет разрешения DNS имен для клиентов SSH. Закомментировано, что означает использование значения по умолчанию.
63. **`#PidFile /var/run/sshd.pid`**
    - Этот параметр определяет путь к файлу PID (идентификатор процесса) SSH-сервера. Закомментировано, что означает использование значения по умолчанию.
64. **`#MaxStartups 10:30:100`**
    - Этот параметр определяет максимальное количество одновременных подключений к SSH-серверу и ограничения для этого. Закомментировано, что означает использование значения по умолчанию.
65. **`#PermitTunnel no`**
    - Этот параметр определяет разрешение или запрет использования SSH-туннелей. Закомментировано, что означает использование значения по умолчанию.
66. **`#ChrootDirectory none`**
    - Этот параметр определяет директорию для chroot-окружения (ограниченной среды) пользователей SSH. Закомментировано, что означает использование значения по умолчанию.
67. **`#VersionAddendum none`**
    - Этот параметр определяет дополнение к версии SSH-сервера. Закомментировано, что означает использование значения по умолчанию.
68. **`# no default banner path`**
    - Этот комментарий указывает на отсутствие пути к баннеру (приветственному сообщению). Закомментировано, что означает отсутствие баннера.
69. **`#Banner none`**
    - Этот параметр определяет путь к файлу баннера, который будет отображаться перед аутентификацией пользователя. Закомментировано, что означает использование значения по умолчанию.
70. **`# Allow client to pass locale environment variables`**
    - Этот комментарий говорит о разрешении передачи клиентом переменных среды для локали.
71. **`AcceptEnv LANG LC_*`**
    - Этот параметр разрешает передачу клиентом переменных среды для локали, начинающихся с **`LANG`** и **`LC_`**.
72. **`# override default of no subsystems`**
    - Этот комментарий указывает на возможность переопределения настроек подсистем SSH.
73. **`Subsystem sftp /usr/lib/openssh/sftp-server`**
    - Этот параметр определяет подсистему SFTP и указывает путь к исполняемому файлу **`sftp-server`** для обработки подсистемы SFTP.
74. **`# Example of overriding settings on a per-user basis`**
    - Этот комментарий указывает на возможность переопределения настроек на уровне конкретного пользователя.
75. **`#Match User anoncvs`**
    - Этот комментарий показывает пример использования параметра **`Match`** для определенного пользователя **`anoncvs`**.
76. **`# X11Forwarding no`**
    - Этот параметр определен внутри секции **`Match`** и отключает X11 Forwarding для пользователя **`anoncvs`**.
77. **`# AllowTcpForwarding no`**
    - Этот параметр внутри секции **`Match`** отключает TCP-перенаправление для пользователя **`anoncvs`**.
78. **`# PermitTTY no`**
    - Этот параметр внутри секции **`Match`** отключает выделение терминала для пользователя **`anoncvs`**.
79. **`PasswordAuthentication yes`**
    - Этот параметр разрешает или запрещает аутентификацию по паролю при входе через SSH. Здесь установлено значение **`yes`**, что разрешает аутентификацию по паролю.

# Использование

```bash
/etc/ssh/sshd/config

# Changes default SSH port (22)
Port 9809

# Disables root login
PermitRootLogin no

# Restricts access to specificusers
AllowUsers user1, user2

# Enables login through ssh key
PubkeyAuthentication yes

# Disables login through password
PasswordAuthentication no

# Disables usage of files .rhosts and .shosts
IgnoreRhosts yes

# Disables a less secure type of login
HostbasedAuthentication no

# Number of unauthenticated connections before dropping
MaxStartups 10:30:100

# No. of failed tries before the servers stops accepting new tries
MaxAuthTries 3

# Max current ssh sessions
MaxSessions 1

# Disables interactive password authentication
ChallengeResponseAuthentication no

# No empty password allowed
PermitEmptyPasswords no

# Disables Rhost authentication
RhostsAuthentication no

# Disables port forwarding (blocks i.e MySQL Workbrench)
AllowTcpForwarding no
X11Forwarding no

# Prints much more info about SSH connections
LogLevel VERBOSE
```
- SSH config

```bash
# Connects to a server (default port 22)
ssh user@server

# Uses a specific port declared in sshd_config
ssh user@server -p other_port

# Runs a script on a remote server
ssh user@server script_to_run

# Invoke a local script
ssh user@server bash < script.sh

# Compresses and downloads from a remote server
ssh user@server "tar cvzf - ~/source" > output.tgz

# Specifies other ssh key for connection
ssh -i ~/.ssh/specific_ssh_key
```
- SSH connections

```bash
# Copies a file from a remote server to a local machine
scp user@server:/dir/file.txt local_dest/

# Copies a file between two servers
scp user@server:/dir/file.txt user@server:/dir

# Copies a file from a local machine to a remote server
scp local_dest/file.txt user@server:/dir

# Uses a specific port declared for SSH in sshd_config
scp -P port

# Coppies recursive a whole folder
scp -r user@server:/dir local_dest/

# Coppies all files from a folder
scp -r user@server:/dir/* local_dest/

# Copies all files from a server folder to the current folder
scp user@server:/dir/* .

# Compresses data on network using gzip
scp -C

# Prints verbose info about the current transfer
scp -v
```
- SCP

```bash
# Generates a new ssh key (-t – type of key, -b – the number of bits in the key)
ssh-keygen -t rsa -b 4096

# Sends the key to the server
ssh-copy-id user@example.com

# Converts ids_rsa into ppk
puttygen current_key -o keyname.ppk
```
- SSH keys

```bash
# User-specific config.
~/.ssh/config

# Private key.
~/.ssh/id_type

# Public key.
~/.ssh/id_type.pub

# Logged in host.
~/.ssh/known_hosts

# Authorized login key.
~/.ssh/authorized_keys
```
- .ssh

```bash
# Установка пакетов SSH
sudo apt-get install ssh

# Статус SSH-сервера в режиме демона
systemctl status sshd
service sshd status

# Получение отладочной информации о попытке подключения по ssh
ssh user@0.0.0.0 -v
```
- Примеры

Режим работы SSH-сервера с настройками по-умолчанию хоть и является вполне работоспособным для небольших частных сетей, всё же нуждается в задании некоторых важных параметров для использования на высоконадёжных публичных серверах. Настройки демона хранятся в файле `/etc/ssh/sshd_config`.

В первую очередь следует обратить внимание на следующие параметры: - **Port** - **AddressFamily** - **ListenAddress**

Первый глобально задаёт номер порта, через который будет работать соединение и если оставить его стандартным, т. е. 22, то велика вероятность, что он будет слишком часто сканироваться роботами.

Для активации параметра необходимо раскомментировать соответствующую строку — убрать символ «#» в её начале. Второй параметр задаёт семейство используемых IP-адресов — IPv4 и IPv6. Если, к примеру, используются только адреса IPv4, то очень рекомендуется установить для параметра
- AddressFamily значение inet
- AddressFamily inet
- Для адресов семейства IPv6 используется значение inet6.

**Параметр ListenAddress позволяет задавать порты для отдельных сетевых интерфейсов:**
- ListenAddress 10.24.205.75:2123
- ListenAddress 10.24.205.76:2124

Поскольку реализация openSSH позволяет работать с протоколами SSH1 и SSH2, то разумно отключить использование SSH1, т. к. эта версия является устаревшей. Работа по SSH1 крайне не рекомендуется: Protocol 2

Очень полезным является параметр, позволяющий проводить авторизацию и шифрование трафика с помощью специальных SSH-ключей:
```bash
PubkeyAuthentication yes
```

Следует заметить, что в таком случае серверу необходимо явно указывать, где хранятся открытые ключи пользователей. Это может быть как один общий файл для хранения ключей всех пользователей (обычно это файл `etc/.ssh/authorized_keys`), так и отдельные для каждого пользователя ключи. Второй вариант предпочтительнее в силу удобства администрирования и повышения безопасности:
```bash
# Для общего файла
AuthorizedKeysFile %h/.ssh/authorized_keys 
# Файл -> пользователь
AuthorizedKeysFile etc/ssh/authorized_keys 
```
- Во втором варианте благодаря шаблону автоподстановки с маской «%h» будет использоваться домашний каталог пользователя.
    

**Важно также отключать парольный доступ:**
```bash
PasswordAuthentication no
```

Или же, в случае, если всё-таки необходимо использовать доступ по паролю, то обязательно нужно отключать авторизацию по пустому паролю:
```bash
PermitEmptyPasswords no
```

Для указания разрешённых или запрещённых пользователей и групп служат директивы DenyUsers, AllowUsers, DenyGroups, и AllowGroups. Значениями для них являются списки имён, разделяемых пробелами, например:
```
DenyUsers fred john
AllowGroups root clients administrators
```

Следует также отключать root-доступ:
```bash
PermitRootLogin no
```

Иногда, когда следует задавать мультисерверную конфигурацию, очень удобно использовать алиасы (Aliases), что позволяет настроить сразу несколько режимов доступа (с разными хостами, портами и т. д.) и использовать их, указывая при этом конкретный алиас:
```bash
ssh alias_name
```

Настройки для алиасов хранятся либо глобально в `/etc/ssh/ssh_config`, либо раздельно для пользователей в `~/.ssh/config`. Здесь нужно не спутать с `ssh_config!` Пример:
```
Host your_alias
Port your_ssh_port
HostName 0.0.0.0 # IP или имя хоста
User your_user_name
```

**Для применения сделанных настроек необходим перезапуск SSH-сервера:**
```bash
systemctl restart sshd
service sshd restart
```

```bash
ssh user_name@host_name
```
- Подключение к серверу, где **user_name** - имя пользователя в системе, **host_name** - имя узла, к которому производится подключение. При этом утилита ssh запросит (в зависимости от настроек сервера) **логин, пароль** или парольную фразу для разблокировки приватного ключа пользователя. В случае авторизации по ключу, должна быть предварительно сгенерирована пара SSH-ключей - открытый, который хранится на стороне сервера, обычно в файле `.ssh/authorized_keys` в домашнем каталоге пользователя, и закрытый - используется для авторизации клиента и хранится, как правило, в каталоге `.ssh/` домашней директории пользователя

```bash
# Посмотреть какие есть ключи и агент ssh
ls -l /etc/ssh/ssh_host_*
ps -ef | grep ssh-agent

# Покажет какие ключи в данный момент используются
ssh-add -L -
```

# ssh-tools

**ssh-tools** - это обобщенное название для набора утилит и инструментов, связанных с SSH (Secure Shell) и предназначенных для работы с этим протоколом. Эти утилиты предоставляют различные функции и возможности для аутентификации, управления ключами, установления SSH-соединений и других операций в контексте SSH.

**В состав "ssh-tools" входят следующие утилиты:**
1. **`/usr/bin/ssh-certinfo`**: Утилита **`ssh-certinfo`** предназначена для анализа и вывода информации о сертификатах SSH, используемых для аутентификации на сервере SSH. Она позволяет пользователю получить информацию о сертификатах, включая владельца, срок действия, ключи и другие параметры.
2. **`/usr/bin/ssh-diff`**: Утилита **`ssh-diff`** позволяет сравнивать два ключа SSH и выявлять различия между ними. Это может быть полезно при обнаружении изменений в ключах SSH или при управлении ключами для безопасности.
3. **`/usr/bin/ssh-facts`**: Утилита **`ssh-facts`** предназначена для сбора фактов о серверах SSH, включая их версию, поддерживаемые алгоритмы шифрования, аутентификационные методы и другие характеристики. Она может помочь администраторам серверов SSH получить информацию о конфигурации и параметрах сервера.
4. **`/usr/bin/ssh-hostkeys`**: Эта утилита позволяет администраторам SSH управлять хост-ключами, которые используются для аутентификации серверов SSH. Она может быть использована для создания новых хост-ключей или управления существующими ключами.
5. **`/usr/bin/ssh-keyinfo`**: Утилита **`ssh-keyinfo`** позволяет анализировать и выводить информацию о ключах SSH, включая их тип, длину и другие параметры. Она может быть полезной при проверке ключей SSH на безопасность.
6. **`/usr/bin/ssh-ping`**: Эта утилита позволяет проверить доступность SSH-сервера и замерить время ответа. Она может быть полезной при диагностике сетевых проблем или мониторинге доступности серверов SSH.
7. **`/usr/bin/ssh-version`**: Утилита **`ssh-version`** предназначена для вывода версии OpenSSH, установленной на вашей системе. Это может быть полезно для проверки версии SSH-сервера или клиента, используемой на вашей системе.

`dpkg -L ssh-tools` представляет собой список файлов и каталогов, которые находятся в системной директории **`/usr`** на системе Linux. Вот краткое описание каждой из них:
1. **`/usr`**: Это корневой каталог, который содержит системные файлы и программы вторичной важности. В нем находятся множество подкаталогов и файлов, включая установленные пакеты.
2. **`/usr/bin`**: Этот каталог содержит исполняемые файлы (программы), доступные для всех пользователей системы. В данном случае, он содержит различные утилиты, связанные с SSH.
3. **`/usr/share`**: Этот каталог содержит общие данные, такие как документация, ресурсы и т. д., используемые различными программами.
4. **`/usr/share/doc`**: Этот каталог содержит документацию для различных пакетов или программ, включая, возможно, документацию для пакета **`ssh-tools`**.
5. **`/usr/share/doc/ssh-tools`**: Этот подкаталог содержит документацию, связанную с пакетом **`ssh-tools`**.
6. **`/usr/share/doc/ssh-tools/changelog.Debian.gz`**: Этот файл, вероятно, содержит журнал изменений (changelog) для пакета **`ssh-tools`** в формате Debian.
7. **`/usr/share/doc/ssh-tools/copyright`**: Этот файл, вероятно, содержит информацию о лицензии и правах на программы внутри пакета **`ssh-tools`**.
8. **`/usr/share/man`**: Этот каталог содержит документацию в формате "man" (manual pages) для различных программ.
9. **`/usr/share/man/man1`**: Этот подкаталог содержит страницы руководства (man pages) для различных программ из каталога **`/usr/bin`**.
10. **`/usr/share/man/man1/ssh-certinfo.1.gz`**: Этот файл содержит man-страницу для утилиты **`ssh-certinfo`**.
11. **`/usr/share/man/man1/ssh-diff.1.gz`**: Этот файл содержит man-страницу для утилиты **`ssh-diff`**.
12. **`/usr/share/man/man1/ssh-facts.1.gz`**: Этот файл содержит man-страницу для утилиты **`ssh-facts`**.
13. **`/usr/share/man/man1/ssh-hostkeys.1.gz`**: Этот файл содержит man-страницу для утилиты **`ssh-hostkeys`**.
14. **`/usr/share/man/man1/ssh-keyinfo.1.gz`**: Этот файл содержит man-страницу для утилиты **`ssh-keyinfo`**.
15. **`/usr/share/man/man1/ssh-ping.1.gz`**: Этот файл содержит man-страницу для утилиты **`ssh-ping`**.
16. **`/usr/share/man/man1/ssh-version.1.gz`**: Этот файл содержит man-страницу для утилиты **`ssh-version`**.

## 1 ssh-ping

Утилита **`ssh-ping`** предназначена для проверки доступности SSH-сервера на удаленном хосте.

**Функционал утилиты:**
1. **Проверка доступности SSH-сервера:** **`ssh-ping`** может использоваться для проверки того, отвечает ли удаленный хост на SSH-запросы. Это полезно, чтобы убедиться, что SSH-сервер на хосте работает и готов принимать подключения.
2. **Оценка времени отклика:** Утилита выводит время отклика (в миллисекундах) для каждого запроса. Это может быть полезно для измерения производительности сетевой связи между клиентом и сервером.
3. **Тестирование настройки SSH:** Путем отправки запросов с разными параметрами (например, различными пользователями или портами), вы можете проверить правильность настроек SSH-сервера на удаленном хосте.
4. **Мониторинг доступности:** Утилита может использоваться в сценариях мониторинга, чтобы регулярно проверять доступность удаленного SSH-сервера и предупреждать о возможных сбоях в работе.

- **Ssh-ping (HELP)**
    
    Описание каждой опции для команды **`ssh-ping`**:
    #TODO: Оформить в виде кода
    - **`4`**: Эта опция указывает использовать только IPv4 для соединения.
    - **`6`**: Эта опция указывает использовать только IPv6 для соединения.
    - **`c count`**: Опция **`c`** позволяет задать количество запросов для отправки. Программа завершит выполнение после отправки указанного числа пакетов.
    - **`F configfile`**: С помощью этой опции можно указать альтернативный файл конфигурации для пользователей. Если файл конфигурации указан в командной строке, то системный файл конфигурации **`/etc/ssh/ssh_config`** будет проигнорирован. По умолчанию используется файл конфигурации **`~/.ssh/config`** для каждого пользователя.
    - **`h`**: Эта опция позволяет вывести справочное сообщение (help), которое объясняет доступные опции.
    - **`i interval`**: С этой опцией можно установить интервал (в секундах) между отправкой каждого запроса. По умолчанию интервал составляет 1 секунду.
    - **`l user`**: Эта опция позволяет указать имя пользователя для попытки входа. По умолчанию используется имя пользователя, под которым выполнена текущая команда (переменная окружения **`$USER`**).
    - **`D`**: Опция **`D`** печатает временную метку в формате времени Unix (время в секундах с микросекундами, как в gettimeofday) перед каждой строкой вывода.
    - **`H`**: Опция **`H`** печатает временную метку в человекочитаемом формате перед каждой строкой вывода.
    - **`W timeout`**: Эта опция позволяет установить время ожидания ответа в секундах. Программа будет ожидать ответа в течение указанного времени.
    - **`p port`**: С помощью этой опции можно указать порт для подключения к удаленному хосту. Это можно задать на пер-хостовой основе в файле конфигурации. По умолчанию используется стандартный SSH-порт (22).
    - **`q`**: Опция **`q`** включает тихий вывод. Ничего не выводится, за исключением строк сводки при запуске и завершении выполнения.
    - **`v`**: Опция **`v`** включает подробный вывод (verbose). Она позволяет выводить дополнительную информацию о процессе выполнения команды, включая подробности о соединении и передаче данных.

Если использовать утилиту с другими пользователями, не относящиемеся непосредственно к системе, то скорее-всего, при настроенном на удаленном сервере **`fail2ban`**, IP будет заблокирован.

## 2 ssh-certinfo

Утилита **`ssh-certinfo`** предназначена для анализа и вывода информации о сертификатах SSH, которые используются для аутентификации на сервере SSH. Эта утилита позволяет получать информацию о сертификатах, включая их содержимое и сроки действия.

```bash
ssh-certinfo -c /path/to/certificate
```
- Утилита анализирует сертификат и выводит информацию о нем

Утилита **`ssh-certinfo`** не предназначена для работы с обычными ключами SSH. Эта утилита предназначена для работы с SSH-сертификатами, которые используются для аутентификации и обеспечения безопасности в SSH-соединениях. SSH-сертификаты представляют собой более сложные структуры данных, чем обычные ключи, и используются для подписи и проверки подлинности других ключей и параметров.

## 3 ssh-diff

ssh-diff - утилита, которая сравнивает два SSH-ключа, и если есть различия, то выводит их. 

Используется для проверки целостности ключей.

## 4 ssh-facts

ssh-facts - утилита, которая собирает информацию о сервере SSH (Конфигурация, поддерживаемые алгоритмы шифрования, аутентификационные методы).

Используется для анализа конфигурации сервера и его характеристик.

```bash
# Эта строка указывает, что операционная система сервера - Ubuntu
OS=ubuntu

# Здесь указана версия операционной системы Ubuntu, которая равна 20.04
OS_VERSION=20.04

# Информация о времени работы сервера. В данном случае, сервер работает 0 дней, 7 часов и 32 минут
UPTIME=0 days, 7 hours, 32 minutes

# Дата и время последней перезагрузки сервера
LAST_REBOOT=Oct 9 09:29:26 2023

# Количество ядер CPU на сервере
CPU_CORES=1

# Количество сокетов CPU на сервере
CPU_SOCKETS=2

# Имя хоста сервера
HOSTNAME=ubuntu

# Имя ядра операционной системы - Linux
KERNEL_NAME=Linux

# Архитектура сервера - x86_64
MACHINE=x86_64

# Тип машины, в данном случае, сервер виртуализирован с помощью VMware
MACHINE_TYPE=virtual_by_vmware

# Объем оперативной памяти сервера в байтах (в данном случае, 3,983,208 байт)
MEMORY=3983208

# Инит-система, используемая на сервере, - systemd
INIT=systemd

# Кодовое имя версии Ubuntu
LSB_CODENAME=focal

# Описание версии Ubuntu
LSB_DESCRIPTION=Ubuntu 20.04.3 LTS

# Идентификатор операционной системы - Ubuntu
LSB_ID=Ubuntu

# Версия операционной системы Ubuntu
LSB_RELEASE=20.04

# Уровень выполнения (runlevel) сервера. В данном случае, это уровень 5
RUNLEVEL=5

# Информация о дисковых устройствах на сервере. Включает в себя устройства виртуальных дисков (например, **`loop0`**, **`loop1`**) и реальные диски (**`sda`**, **`sdb`**)
DISKS=loop0 loop1 loop2 ... sda sdb
```
- Результат работы команды

## 5 ssh-hostkeys

ssh-hostkeys - утилита, которая отображает и управляет (Создание, добавление, изменение типа, проверка на целостность и подлинность) хост-ключами SSH-сервера.

Хост-ключи используются для аутентификации сервера SSH перед клиентами и обеспечения целостности и безопасности соединения. 

## 6 ssh-keygen

ssh-keygen - утилита, которая генерирует и управляет SSH-ключами.

Возможности:
- Генерация пары ключей (Публичного и приватного)
- Управление паролем (фраза-пароль) для приватного ключа, который обеспечивает доп. уровень безопасности
- Просмотр информации о ключе (Отпечаток ключа, дата создания и др)
- Копирование публичных ключей на удаленные серверы (ssh-copy-id)
- Конвертация ключей из одного формата в другой
- Добавление ключей в SSH-агент, что позволяет использовать ключи без повторной аутентификации

При запуске без аргументов ssh-keygen генерирует ключи по умолчанию (обычно RSA ключи) в каталоге пользователя (~/.ssh) или в указанном месте. В процессе генерации создается пара ключей - приватный и публичный. Приватный ключ хранится на вашем компьютере, а публичный ключ можно передавать на сервера для аутентификации.

```bash
ssh-keygen -p -f /home/litvinigor/.ssh/id_rsa
```
- Убрать парольную фразу из существующего ключа
```bash
ssh-keygen -t rsa -f /home/litvinigor/.ssh/id_rsa
```
- Создать новый ключ без парольной фразы 

## 7 ssh-keyinfo

ssh-keyinfo - утилита, которая предоставляет информацию о ключах SSH (тип, размер, хеш-значение и дополнительную информацию о ключе). 

Используется для анализа открытых и закрытых ключей SSH.


# SFTP

> Это безопасный протокол передачи файлов “Secure Shell”

Так как SFTP работает поверх SSH, первым делом необходимо установить OpenSSH как со стороны сервера (хранилища):

```bash
$ sudo apt install openssh-server
```

Также необходимо установить ssh на стороне клиента (устройства, с которого планируется доступ к хранилищу):

```bash
$ sudo apt install ssh
```

Для безопасного использования SFTP, лучше всего создать группы и пользователей, которые будут использовать только эту службу:

```bash
$ sudo useradd -g sftpgroup sftpuser
$ sudo passwd sftpuser
```

Cоздадим каталоги и изменим их доступ:

```bash
$ sudo mkdir -p /data/sftpuser/upload 
$ chown -R root.sftpgroup /data/sftp 
$ chown -R sftpuser.sftpgroup /data/sftp/upload
```

Доступ по sftp осуществляется аналогично с ssh — **sftp username@host** (чтобы узнать ip-адрес хоста выполните команду **ip a**) :

```bash
$ sftp sftpuser@192.168.183.128
```

Основные команды sftp:

1. `get` — загрузка содержимого с удаленного сервиса
2. `put` — загрузка содержимого из локальной системы в удаленную
3. `rm` — удаление файлов на сервере


# Практика SFTP

## У**становка**

```bash
$ apt-get install openssh-server
```

## Настройка

```bash
#создадим группу и пользователя, затем привяжем его к группе
$ groupadd sftpgroup
$ useradd -g sgtpgroup sftpuser

#зададим пароль
$ passwd sftpuser

#создание рабочей дериктории
$ mkdir -p /lesson/sftpuser/get
$ chown -R root.sftpgroup /lesson/sftpuser
$ chown -R root.sftpgroup /lesson/sftpuser/get

#идем в файл конфигурации
$ sudo nano /etc/ssh/ssh_config
```

Прописываем данные настройки

```bash
$ service ssh restart
```

## Проверка работы

В Windows 10 проверяем ping до Linux. И далее в программе WinSCP вводим адрес хоста Linux, имя пользователя и пароль. Далее нажимаем Yes

В случае успешной работы мы увидем файлы Linux’a

# MFA

## 1 Установка Google Authenticator

Необходимо установить приложение Google Authenticator на устройство Android или IOS, а также на Linux.

```bash
sudo apt install libpam-google-authenticator
```
- Установка Google Authenticator в Linux

## 2 Генерирование начального токена для пользователя

```bash
google-authenticator
```
- В качестве первого шага в настройке MFA необходимо выполнить следующую команду из терминала. Она выполнит начальную настройку и сгенерирует ключ TOTP. Этот ключ предназначен для пользователя, выполняющего команду, и не применим ко всем остальным пользователям системы

Существует определенная последовательность шагов, при выполнении которых будет предложено выбрать вариант (y/n).

Будет предложено выбрать токены аутентификации на основе времени. Токены аутентификации по времени будут генерировать новый код каждые 30 секунд. Нажмите «y», чтобы продолжить.

Секретный токен будет сгенерирован вместе с QR-кодом. Откройте мобильное приложение Google Authenticator и отсканируйте QR-код или введите секретный ключ вручную, чтобы зарегистрировать устройство. После этого приложение начнет генерировать токены каждые 30 секунд.

На этом этапе вам будет предложено обновить файл .google_authenticator в домашнем каталоге. В этом файле сохраняются все секретные ключи, код проверки, аварийные коды. Нажмите «y», чтобы продолжить.

При выборе «y» на этом шаге срок действия токена истечет сразу после того, как вы использовали его для аутентификации. В этом случае, даже если хакеры получат ваш токен, он будет просрочен.

Этот шаг определяет, сколько токенов будет разрешено, а также временные рамки. Если выбрать «n», то будет разрешено 3 токена в течение 90 секунд. Если выбрать «y», то будет разрешено 17 токенов в течение 240 секунд.

На этом шаге вам будет предложено включить ограничение частоты. Ограничение частоты позволяет злоумышленнику предпринимать только 3 попытки входа в систему каждые 30 секунд. Если токены неверны, то ему придется ждать временной интервал N, чтобы повторить попытку.

Откройте файл `~/.google_authenticator` и вы увидите все настройки и секретные коды, которые сделали в ходе всех этих шагов.

```bash
google-authenticator -q -t -d -f -r 3 -R 30 -w 3
```
- Также можете передать аргументы команде google-authenticator, которая создаст ключи и другие настройки без выполнения данной последовательности шагов
```bash
google-authenticator --help
```
- Обратитесь к разделу помощи аутентификатора Google, чтобы узнать, что эти аргументы означают.

## 3 Настройка SSH

Необходимо внести некоторые изменения в конфигурацию openSSH, чтобы можно было начать использовать MFA.

```bash
sudo cp /etc/ssh/sshd_config /etc/ssh/sshd_config.backup

sudo cp /etc/pam.d/sshd /etc/pam.d/sshd.backup
```
- Делаем резервные копии файлов конфигураций SSH

```bash
ChallengeResponseAuthentication yes
```
- Необходимо разрешить SSH использовать MFA, установив в файле /etc/ssh/sshd_config настройку
```bash
# Делает этот метод необязательным
auth required pam_google_authenticator.so nullok
# Разрешить пользователю войти в систему, если не используется MFA
auth required pam_permit.so
```
- Необходимо добавить строки в файл /etc/pam.d/sshd. Если вы хотите сделать MFA обязательным для всех пользователей, удалите слово «nullok».
```bash
sudo systemctl restart sshd
```
- Перезапускаем службу ssh, чтобы изменения вступили в силу

## 4 Проверка работы

Подключитесь к серверу через SSH, и вам будет предложено ввести пароль в качестве первого фактора, а затем проверочный код в качестве второго фактора аутентификации.

```bash
ssh user@hostname
```
- Подключение к серверу. После ввода пароля SSH и проверочного кода вы сможете войти в систему

## 5 Многофакторная аутентификация при аутентификации на основе ключей

Если настроили аутентификацию на основе ключей, то вам не будут предлагать ввести пароль или проверочные коды. Почему?

Потому что по умолчанию ssh сначала использует аутентификацию на основе открытого ключа, и если ключ найден, то аутентификация выполняется с его помощью. В случае, если ключ не найден, он будет использовать аутентификацию на основе пароля.

```bash
ssh -v -i ~/.ssh/id_rsa username@hostname
```
- Можно использовать режим verbose, чтобы проверить это
```bash
AuthenticationMethods publickey,password publickey,keyboard-interactive
```
- Добавляем строку в конец файла /etc/ssh/sshd_config
```bash
#@include common-auth
```
- Закомментируем строку в файле /etc/pam.d/sshd. Если не закомментировать «@include common-auth», то это позволит использовать более двух факторов для аутентификации. Сначала будет выполняться аутентификация с использованием ключей, затем пароля и токенов.

Для проверки подлинности нам нужен только ключ и токен, поэтому отключим аутентификацию с использованием пароля.

```bash
sudo systemctl restart sshd
```
- Перезапускаем службу

## 6 Восстановление

Иногда возникает ситуация, когда вы теряете или меняете свое мобильное устройство. В этом случае вам придется переустановить приложение google-authenticator и зарегистрировать секретный ключ, чтобы начать генерировать токены.

Если вы заблокированы в системе, то вам придется войти непосредственно на сервер, чтобы создать новые секретные ключи для регистрации и использования. Но есть и альтернативный подход, когда вы можете войти в систему по ssh и сгенерировать ключи вновь.

Помните коды, которые генерируются на начальном этапе? Вы можете использовать аварийный скретч-код в качестве маркера для входа в систему. Каждый скретч-код можно использовать только один раз. Сохраните его в надежном месте, чтобы он мог быть использован в нужный момент.

Коды сохраняются в файле ~/.google_authenticator.
