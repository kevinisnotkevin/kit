# SSH

- [**Что такое SSH?**](materials/networks/ssh.md)

**SSH** - это набор программ, которые позволяют выполнять команды на удаленном компьютере, а также перемещать файлы между компьютерами, организуя защищенное безопасное соединение поверх небезопасных каналов связи, которое не позволяет прослушивать или подменять трафик.

Протокол SSH возник как попытка обезопасить открытые незащищенные соединения. Впоследствии его функции были значительно расширены. Наиболее важными из них являются:

- **Безопасные команды доступа к хосту**: SSH дает возможность выполнять безопасные команды доступа к хосту, такие как ssh (удаленная оболочка), slogin (удаленный вход в систему), scp (удаленное копирование).
- **X11 Forwarding**: SSH предоставляет встроенный механизм для выполнения удаленных клиентов X Window.
- **Port forwarding**: SSH может выполнять переадресацию портов, передавая трафик c одного порта одной машины на другой порт другой машины (Туннелирование любых TCP-соединений). При этом передаваемый трафик шифруется.

---

**Обеспечение безопасности SSH**

Безопасность протокола достигается использованием нескольких решений, которые сводят к минимуму риск использования соединения:

- **Шифрованное соединение** не позволяет перехватить и использовать трафик. Выбор алгоритма шифрования делает систему более гибкой, позволяя не использовать алгоритмы, в которых обнаружены слабые места или которые не может поддерживать одна из сторон.
- **Аутентификация сервера** выполняется при любом соединении. Это не позволяет выполнить подмену сервера или подмену трафика.
- **Аутентификация клиента** может выполняться одним из нескольких доступных способов. Это с одной стороны может повысить надежность аутентификации, с другой - делает систему более гибкой и упрощает ее использование;
- **Проверка целостности пакетов** позволяет отследить любые несанкционированные изменения в трафике соединения. При обнаружении таких изменений, соединение немедленно разрывается.
- **Временные параметры аутентификации** не позволяют воспользоваться данными соединения в том случае, если спустя некоторое время после перехвата оно все-таки было расшифровано. Устаревание обычно происходит через час.

---

**Аутентификация сервера**

Аутентификация сервера производится при помощи инфраструктуры открытых ключей. Клиент, который хочет установить соединение с сервером шифрует данные известным ему открытым ключом сервера и отправляет их серверу. Сервер должен расшифровать их при помощи известного только ему секретного ключа, и отправить их назад. Так клиент может быть уверен в том, является ли хост тем, за кого себя выдает.

Аутентификация сервера по протоколу SSH выполняется при помощи инфраструктуры открытых ключей. Открытый ключ сервера клиент получает при первом соединении с ним.

Аутентификация сервера дает возможность не полагаться на службу имен и маршрутизацию пакетов. В том случае, если нарушителю удалось подменить запись в DNS или перенаправить IP-пакеты на свой хост, аутентификация не пройдет, поскольку хост не обладает необходимыми секретными ключами.

Ssh защищает от:

- **Подмены IP-адресов (IP-spoofing)**, когда удаленный хост посылает пакеты от имени другого хоста.
- **Подмены DNS-записей (DNS-spoofing)**, когда изменяется запись на сервере DNS и в результате соединение устанавливается не с желаемым хостом, а с тем, на который указывает новая запись.
- **Перехвата открытых паролей и прочих данных**, которые передаются в открытом виде и любой, кто имеет физический доступ к каналу, может их узнать.

---

**Аутентификация клиента**

Методы аутентификации клиентов:

- **Host-based аутентификация**: Метод аналогичный используемому в r-командах. В том случае, если соединение устанавливается с привилегированного порта, и файл .rhosts позволяет вход в систему, он разрешается. Этот метод является потенциально небезопасным, рекомендуется не использовать его. Для повышения уровня своей безопасности метод может быть дополнен ls /devRSA-аутентификацией клиентского хоста.
- **Аутентификация с помощью открытых ключей**: Клиент отправляет серверу открытый ключ. Если сервер знает его, он просит клиента доказать, что тот знает и секретный ключ тоже. Если клиент может это доказать, значит аутентификация считается успешной.
- **Kerberos-аутентификация**: Аутентификация проводится по схеме v5 Kerberos.
- **Парольная аутентификация**: Принцип аутентификации аналогичен тому, какой, например, используется в telnet с той разницей, что пароль передается по зашифрованному каналу.

## OpenSSH

Сразу после окончания разработки система SSH стала активно трансформироваться в закрытый коммерческий продукт в виде версии SSH2. Но благодаря сообществу GNU версии протокола SSH1 и SSH2 были реализованы в виде открытого и свободно распространяемого ПО openSSH.

**OpenSSH** - это реализация с открытым исходным кодом протокола SSH, позволяющая шифровать соединение в сети посредством набора программ. Состоит из сервера OpenSSH и клиентских пакетов.

Состав OpenSSH:

- **sshd (OpenSSH Daemon)**: Ожидает подключений от клиентов.
- **sftp-server**: Участвует в передаче файлов по потоколу sftp. Не предназначен для прямого вызова, задействуется демоном sshd.
- **ssh**: Осуществляет подключение к серверу.
- **scp**: Передает файлы.
- **ssh-keygen**: Генерирует пары ssh ключей.

Технология работает по принципу сервер-клиент. На удаленной машине нужно запустить сервер OpenSSH. К этому серверу можно подключаться с помощью клиентов OpenSSH. На одном компьютере могут быть одновременно установлены и сервер и клиент. Их запуск и настройка выполняется независимо друг от друга.

---

**Сервер sshd**

Сервер SSH реализован в виде программы sshd. Сервер sshd является независимой программой, поэтому его запуск нужно производить во время загрузки компьютера стартовыми скриптами. То есть, вызов sshd либо должен осуществляться явно одним из rc-скриптов, либо ссылки на скрипт запуска следует включить в иерархию `/etc/rc?.d/`.

Для того чтобы сервер sshd автоматически стартовал при запуске компьютера, необходимо добавить его вызов в скрипты загрузки.

Будучи запущенным, демон работает в фоновом режиме и обрабатывает все входящие запросы по порту 22 (По умолчанию). Для каждого соединения создается новая копия демона, который занимается только его обслуживанием.

Конфигурация демона определяется файлом `/etc/ssh/sshd_config`. Он представляет собой набор действующих строк, пустых строк и строк-комментариев. 

## Установка

В Debain, программы OpenSSH можно установить по отдельности, например, имеются пакеты для клиента и для сервера **openssh-client** и **openssh-server**. Либо можно установить метапакет **ssh**, который содержит и клиентскую, и серверную часть. Запуск службы OpenSSH требуется только на сервере.

```bash
apt install openssh-server  # Установка ssh-сервера
apt install ssh  # Установка ssh
```
- Установка.

## Примеры

```
sshd -t
```
- Проверка конфигурации sshd_config позволяет убедиться, что синтаксис и опции корректны. Не должно ничего возвращать

```bash
~/.ssh/config  # Настройки ssh конкретного пользователя
~/.ssh/id_type  # Пример приватного ключа
~/.ssh/id_type.pub  # Пример публичного ключа
~/.ssh/known_hosts  # Известные хосты
~/.ssh/authorized_keys  # Авторизованные ключи
```
- Описание некоторых файлов ssh.

```bash
# Посмотреть какие есть ключи и агент ssh
ls -l /etc/ssh/ssh_host_*
ps -ef | grep ssh-agent

# Покажет какие ключи в данный момент используются
ssh-add -L -
```
- Отладочные команды.

```bash
journalctl -u sshd.service
journalctl /usr/bin/sshd
journalctl -u "sshd*"
journalctl | grep -i ssh
journalctl | grep -i 'Failed password for'
```
- Способы вывода логов ssh.

## Параметры конфигураций

Файл конфигурации: `/etc/ssh/sshd_config`.

```bash
Port 22  # Default
```
- Параметр определяет порт, на котором будет работать ssh сервер.
- Если оставить значение по умолчанию, то порт будет часто сканироваться ботами.

```bash
AddressFamily any  # Слушать все доступные адреса.
```
- Параметр определяет семейства используемых ip-адресов.
- Если будут использоваться только ipv4 адреса, то лучше установить значение `inet`.
- Для ipv6 используется значение `inet6`.

```bash
ListenAddress 0.0.0.0  # Слушать все IPv4 адреса
ListenAddress ::  # Слушать все IPv6 адреса
ListenAddress 192.168.1.1  # Слушать на определенном сетевом интерфейсе 
ListenAddress 192.168.1.1:223  # Слушать на определенном сетевом интерфейсе с портом 
```
- Параметр определяет порты для отдельных сетевых интерфейсов.

```bash
Protocol 2
```
- Параметр определяет версию протокола.
- openssh позволяет работать с протоколами SSH1 и SSH2, ssh1 лучше отключить, так как эта версия является устаревшей.

```bash
HostKey /etc/ssh/ssh_host_rsa_key
HostKey /etc/ssh/ssh_host_dsa_key
```
- Путь к файлу, содержащему закрытый ключ RSA/DSA, используемый сервером для шифрования и аутентификации.

```bash
RekeyLimit default none
```
- Ограничение на переустановку ключей шифрования. По умолчанию не задано и переустановка ключей отключена.

```bash
SyslogFacility AUTH
```
- Параметр определяет, тип событий для записи в журнал `/var/log/auth.logs`.
- Доступные значения: DAEMON, USER, AUTH, LOCAL0, LOCAL1, LOCAL2, LOCAL3, LOCAL4, LOCAL5, LOCAL6, LOCAL7.
- AUTH - авторизация на сервере.

```bash
LogLevel INFO
```
- Параметр определяет уровень журналирования ssh.
- Доступные значения: SILENT, QUIET, FATAL, ERROR, INFO, VERBOSE, DEBUG, DEBUG1, DEBUG2, DEBUG3.
- По умолчанию INFO.

```bash
LoginGrameTime 2m
```
- Параметр определяет максимальное время, в течение которого пользователь может войти в систему после установления соединения. Иначе, соединение будет закрыто.

```bash
PermitRootLogin yes  # Default
```
- Параметр указывает на разрешение входа пользователя `root` в систему.
- `yes` - вход разрешен.
- `no` - вход запрещен.
- `prohibit-password` - вход разрешен только при наличии пароля.
- `without-password` - вход по паролю запрещен, по ключу разрешен.
- `forced-commands-only` - вход по паролю запрещен, вход по ключу разрешен, но только для выполнения команды.

```bash
StrictModes yes
```
- Параметр указывает на разрешение строгого режима проверки прав доступа к домашним каталогам и файлам пользователей.

```bash
MaxAuthTries 6
```
- Параметр ограничивает кол-во попыток аутентификации для одного соединения. Иначе, соединение будет закрыто.

```bash
MaxSessions 10
```
- Параметр определяет максимальное кол-во параллельных сеансов.

```bash
PubkeyAuthentication yes
```
- Параметр разрешает аутентификацию по ключу. В таком случае необходимо явно указывать, где хранятся открытые ключи пользователей с помощью параметра `AuthorizedKeysFile`.

```bash
AuthorizedKeysFile .ssh/authorized_keys .ssh/authorized_keys2  # Default

AuthorizedKeysFile %h/.ssh/authorized_keys  # Файл для пользователя
AuthorizedKeysFile etc/ssh/authorized_keys  # Общий файл
```
- Параметр определяет список файлов, в которых содержатся публичные ключи, используемые для аутентификации пользователей по открытому ключу. 
- Это может быть один общий файл с ключами пользователей (например, `etc/.ssh/authorized_keys`) или отдельные файлы ключей для каждого пользователя.
- Шаблон автоподстановки с маской `%h` будет использовать домашний каталог пользователя.

```bash
AuthorizedPrincipalsFile none
```
- Параметр определяет файл, содержащий принципалов, для которых разрешена аутентификация.

```bash
AuthorizedKeysCommand none
```
- Параметр определяет команду, которая может быть использована для получения списка авторизованных ключей.

```bash
AuthorizedKeysCommandUser nobody
```
- Параметр определяет пользователя, от имени которого будет запущена команда `AuthorizedKeysCommand`.

```bash
HostbasedAuthentication no
```
- Параметр определяет разрешение на аутентификацию на основе хостовой аутентификации.

```bash
IgnoreUserKnownHosts no
```
- Параметр определяет, будет ли игнорироваться файл `known_hosts` в домашнем каталоге пользователя.

```bash
IgnoreRhosts yes
```
- Параметр определяет, будут ли игнорироваться файлы `~/.rhosts` и `~/.shosts`.

```bash
PasswordAuthentication yes
```
- Параметр разрешает аутентификацию по паролю.

```bash
PermitEmptyPasswords no
```
- Параметр определяет разрешение использования пустых паролей.

```bash
ChallengeResponseAuthentication no
```
- Параметр определяет разрешение аутентификации с вызовом и ответом.

```bash
KerberosAuthentication no
```
- Параметр определяет разрешение аутентификации Kerberos.

```bash
KerberosOrLocalPasswd yes
```
- Параметр определяет, будет ли использоваться kerberos аутентификация или локальный пароль при аутентификации. Если установлено значение **`yes`**, то после неудачной Kerberos аутентификации будет предложено использовать локальный пароль.

```bash
KerberosTicketCleanup yes
```
- Параметр определяет, будет ли сервер удалять kerberos билеты после завершения сеанса.

```bash
KerberosGetAFSToken no
```
- Параметр определяет, будет ли сервер запрашивать AFS токены в случае успешной kerberos аутентификации.

```bash
GSSAPIAuthentication no
```
- Параметр определяет разрешение аутентификации с использованием GSSAPI.

```bash
GSSAPICLeanupCredentials yes
```
- Параметр определяет, будет ли сервер автоматически очищать данные GSSAPI после завершения сеанса.

```bash
GSSAPIStrictAcceptorCheck yes
```
- Параметр определяет, будет ли сервер строго проверять допустимость GSSAPI аутентификации на стороне сервера.

```bash
GSSAPIKeyExchange no
```
- Параметр определяет разрешение или запрет использования GSSAPI для обмена ключами.

```bash
UsePAM yes
```
- Параметр определяет, будет ли использоваться PAM аутентификация. Это позволяет использовать дополнительные методы аутентификации, определенные в PAM-конфигурации, и выполнять проверки учетных записей и сессий.

```bash
AllowAgentForwarding yes
```
- Параметр определяет разрешение передачи ssh агента.

```bash
AllowTcpForwarding yes
```
- Параметр определяет разрешение tcp перенаправления в сеансах ssh.

```bash
GatewayPorts no
```
- Параметр определяет разрешение создания прокси-шлюзов с открытыми портами.

```bash
X11Forwarding yes
```
- Параметр определяет разрешение перенаправления портов X-системы через ssh туннель, что позволяет пользователю выполнять графические приложения с удаленного сервера.
- Будет работать, если на сервере установлен XServer.

```bash
X11DisplayOffset 10
```
- Параметр определяет смещение дисплея X11.

```bash
X11UseLocalhost yes
```
- Параметр определяет, будет ли использоваться локальный хост для X11 Forwading.

```bash
PermitTTY yes
```
- Параметр определяет разрешение выделения терминала для ssh сеансов.

```bash
PrintMotd no
```
- Параметр определяет разрешение вывода сообщения дня (MOTD) при входе пользователя в систему по ssh.

```bash
PrintLastLog yes
```
- Параметр определяет, будет ли выводиться последний успешный вход пользователя в систему.

```bash
TCPKeepAlive yes
```
- Параметр определяет разрешение использования tcp keep-alive для поддержания активности соединения.

```bash
PermitUserEnvironment no
```
- Параметр определяет разрешение пользовательских переменных среды.

```bash
Compression delayed
```
- Параметр определяет метод сжатия данных для ssh-соединения. `delayed` - отложенное сжатие.

```bash
ClientAliveCountMax 3
```
- Параметр определяет кол-во запросов, которое ssh сервер отправляет ssh клиентам через определенные промежутки времени. Если клиент не ответит ни на один запрос, то соединение закроется.
- Без этого параметра сессии на сервере будут длиться вечно, занимая ресурсы.

```bash
ClientAliveInterval 20
```
- Параметр определяет интервал в секундах для отправки запросов `ClientAliveCountMax`.

```bash
UseDNS no
```
- Параметр определяет разрешение разрешения DNS имен для ssh клиентов.

```bash
UseLogin no  # Default
```
- Параметр определяет использование login для интерактивных сессий.

```bash
PidFile /var/run/sshd.pid
```
- Параметр определяет путь к файлу PID ssh сервера.

```bash
LoginGraceTime 120  # Default
```
- Параметр устанавливает время разрыва соединения в секундах, если пользователь не осуществит авторизацию.

```bash
MaxStartups 10:30:100
```
- Параметр определяет кол-во неавторизованных подключений к серверу ssh. Формат записи может быть `start:rate:full`. `start` - имеющееся кол-во неавторизованных подключений, `rate` - процент вероятности отклонения попытки подключения, `full` - максимальное кол-во неавторизованных подключений.
- В данном случае, если уже имеется 10 неавторизованных подключений, то следующее подключение будет отклонено с вероятностью 30%, а если кол-во неавторизованных подключений достигнет 100, то все последующие попытки подключения будут отвергнуты.
- Длительность подключения определяется `LoginGraceTime`.
- По умолчанию `10`.

```bash
PermitTunnel no
```
- Параметр определяет разрешение использования ssh туннелей.

```bash
ChrootDirectory none
```
- Параметр определяет директорию для chroot-окружения (ограниченной среды) пользователей ssh.

```bash
VersionAddendum none
```
- Параметр определяет дополнение к версии ssh сервера.

```bash
Banner none
```
- Параметр определяет путь к файлу баннера, который будет отображаться при попытке подключиться к серверу.

```bash
AcceptEnv LANG LC_*
```
- Параметр устанавливает переменные окружения, которые будут переданы клиенту.

```bash
Subsystem sftp /usr/lib/openssh/sftp-server
```
- Параметр определяет подсистему SFTP и указывает путь к исполняемому файлу stfp-server для обработки подсистему sftp.

```bash
Match User username
	X11Forwarding no
	AllowTcpForwarding no
	PermitTTY no
	PasswordAuthentication yes
```
- Параметры для пользователя `username`.

```bash
AllowUsers user1 user2  # Разрешение
DenyUsers user1 user2  # Запрет
```
- Параметры определяют разрешение и запрет доступа для перечисленных пользователей.
- Также допускается использование записи вида `user@host`, что означает разрешение доступа пользователю user с компьютера host.

```bash
AllowGroups group1 group2  # Разрешение
DenyGroups group1 group2  # Запрет
```
- Параметр определяет разрешение и запрет доступа для перечисленных групп пользователей.

```bash
UsePrivilegeSeparation yes
```
- Параметр определяет разрешения разделения привилегий. Сначала создается непривилегированный дочерний процесс для входящего сетевого трафика, а после успешной авторизации запускается другой процесс с привилегиями вошедшего пользователя.

## SSH Client

ssh подключается к удаленному хосту, используя для этого текущее имя пользователя или, если указано явно, имя пользователя. После этого происходит двусторонняя аутентификация, т.е. удаленный хост доказывает, что он именно тот, за кого себя выдает, а регистрирующийся пользователь в свою очередь доказывает это удаленному хосту.

После этого удаленный хост, выполняет заданную команду, либо если команда отсутствует, запускает командный интерпретатор и предоставляет к нему доступ. После того, как команда выполнена, либо оболочка командного интерпретатора завершила свою работу, соединение завершается.

Программа ssh имеет свой собственный конфигурационный файл, точно такого же формата, как и конфигурационный файл сервера sshd, только в котором используются другие директивы.

```bash
ssh server  # Вход под текущим пользователем
ssh user@server [command]
```
- Подключение к серверу по ssh на 22 порт.
- Флаг `-p` позволяет указать другой порт удаленного хоста.
- Флаг `-i` позволяет указать ключ для подключения.
- Флаг `-v` выводит отладочные сообщения во время подключения.
- Флаг `-f` переводит в фоновый режим сразу после прохождения этапа регистрации.
- Флаг `-l` указывает имя пользователя для входа (Вместо `username@server`).
- Флаг `-L` перенаправляет порт локального хоста на хостпорт удаленного хоста.
- Флаг `-R` перенаправляет порт удаленного хоста на хостпорт локального хоста.
- Флаг `-o` позволяет указать опции, которые перекроют опции из конфигурационного файла.
- `[command]` - команда для выполнения на сервере. Например, сжатие и скачивание директории `"tar cvzf - ~/source" > output.tgz`.

## SSH Pubkeys

Аутентификация с использованием открытых ключей проходит следующим образом. Хост, на котором выполняется удаленная регистрация предлагает пользователю аутентифицировать себя. Для этого он пересылает сообщение, зашифрованное известным ему открытым ключом пользователя. Если пользователь расшифрует сообщение, значит он знает секретный ключ, следовательно, является тем за кого себя выдает.

Секретные ключи хранятся в файлах `identity`, `id_dsa` и `id_rsa` в локальном каталоге `~/.ssh` (разные файлы для разных алгоритмов шифрования). Открытые ключи должны быть в файлах `authorized_keys` и `authorized_keys2` в каталоге `~/.ssh` на удаленном компьютере, на котором производится регистрация. В качестве домашнего рассматривается каталог пользователя, под именем которого выполняется регистрация. Файл `authorized_keys` используется для хранения открытых ключей для SSH1, а в `authorized_keys2` — для SSH2.

ssh позволяет использовать один из трех различных алгоритмов асимметричного шифрования RSA или DSA:

- **rsa1**: Тип ключа RSA1, используемый в SSH1
- **rsa**: Тип ключа RSA, используемый в SSH2
- **dsa**: Тип ключа DSA, используемый в SSH2

**ssh-keygen** генерирует пару открытый ключ - секретный ключ. При этом она спрашивает, в какие файлы нужно записать ключи. По умолчанию секретный ключ записывается в ~/.ssh/identity (или ~/.ssh/id_rsa, ~/.ssh/id_dsa), а открытый в ~/.ssh/identity.pub.

Сгенерированный секретный ключ защищается при помощи парольной фразы (passphrase), которую нужно обязательно знать, для того чтобы воспользоваться ключом. Секретная фраза вводится в момент генерирования ключей. Она может быть затем изменена, без повторного копирования ключей.

Можно сгенерировать секретные ключи, в которых парольная фраза будет отсутствовать. Хотя это и упрощает использование ключей, делать этого не рекомендуется, поскольку в этом случае файл с секретным ключом автоматически влечет за собой полный беспрепятственный доступ ко всем системам, где установлена его открытая пара.

Полученный открытый ключ нужно добавить в файлы authorized_keys удаленных хостов, к которым будет производится доступ.

Можно ограничиться только второй версией SSH, однако в том случае, если SSH-сервер на удаленной машине не поддерживает SSH-протокол версии 2, аутентификацию с использованием открытых ключей провести не удастся.

После того, как аутентификация с использованием открытых ключей настроена, доступ к удаленному компьютеру можно получить без пароля.

```bash
ssh user@server
Enter passphrase for key '/home/user/.ssh/id_rsa':
```
- Для того, чтобы воспользоваться локальным секретным ключом, нужно ввести парольную фразу.

```bash
ssh-keygen -t rsa -b 4096
```
- Генерация нового ключа.
- Флаг `-t` задачет тип ключа.
- Флаг `-b` задает кол-во бит в ключе.

```bash
ssh-copy-id user@server
cat ~/.ssh/id_rsa.pub | ssh user@server 'cat >> ~/.ssh/authorized_keys'
```
- Способы отправки публичного ключа на сервер.

## Aliases

Иногда, когда следует задавать мультисерверную конфигурацию, удобно использовать алиасы, что позволяет настроить сразу несколько режимов доступа (с разными хостами, портами и т. д.) и использовать их, указывая при этом конкретный алиас. Настройки для алиасов хранятся либо глобально в `/etc/ssh/ssh_config`, либо раздельно для пользователей в `~/.ssh/config`.

```
Host alias_name
Port 22
HostName 192.168.10.10
User username
```
- Пример настройки алиас.

```bash
ssh alias_name
```
- Пример использования алиас.

## SSH Tools

**ssh-tools** - это обобщенное название для набора утилит и инструментов, связанных с SSH (Secure Shell) и предназначенных для работы с этим протоколом. Эти утилиты предоставляют различные функции и возможности для аутентификации, управления ключами, установления SSH-соединений и других операций в контексте SSH.

```bash
apt install ssh-tools
```
- Установка утилит.

---

**SSH Ping**

**ssh-ping** - это утилита, которая проверяет доступность ssh сервера и замеряет время ответа для мониторинга доступности, тестирования конфигурации, диагностики сетевых проблем.

Если использовать утилиту с другими пользователями, не относящиемеся непосредственно к системе, то скорее-всего, при настроенном на удаленном сервере **`fail2ban`**, IP будет заблокирован.

---

**SSH Certinfo**

**ssh-certinfo** - это утилита, которая анализирует и выводит информацию о сертификатах ssh (Владелец, срок действия, ключи и др), используемых для аутентификации на ssh сервере.

```bash
ssh-certinfo -c /path/to/certificate
```
- Анализ сертификата и вывод информации о нем.

Утилита не предназначена для работы с обычными ключами ssh. Эта утилита предназначена для работы с ssh-сертификатами, которые используются для аутентификации и обеспечения безопасности в ssh-соединениях. ssh-сертификаты представляют собой более сложные структуры данных, чем обычные ключи, и используются для подписи и проверки подлинности других ключей и параметров.

---

**SSH Diff**

**ssh-diff** - это утилита, которая сравнивает два ssh ключа и выявляет различия между ними. 

---

**SSH Facts**

**ssh-facts** - это утилита, которая собирает информацию о ssh сервере (Конфигурация, поддерживаемые алгоритмы шифрования, аутентификационные методы).

---

**SSH Hostkeys**

**ssh-hostkeys** - это утилита, которая отображает и управляет (Создание, добавление, изменение типа, проверка на целостность и подлинность) хост-ключами ssh сервера.

---

**SSH Keygen**

**ssh-keygen** - это утилита, которая генерирует и управляет SSH-ключами.

**ПРИМЕНЕНИЕ**

- Генерация пары ключей (Публичного и приватного).
- Управление паролем (фраза-пароль) для приватного ключа, который обеспечивает доп. уровень безопасности.
- Просмотр информации о ключе (Отпечаток ключа, дата создания и др).
- Копирование публичных ключей на удаленные серверы (ssh-copy-id).
- Конвертация ключей из одного формата в другой.
- Добавление ключей в SSH-агент, что позволяет использовать ключи без повторной аутентификации.

При запуске без аргументов ssh-keygen генерирует ключи по умолчанию (обычно RSA ключи) в каталоге пользователя (`~/.ssh`) или в указанном месте. В процессе генерации создается пара ключей - приватный и публичный. Приватный ключ хранится на хосте, а публичный ключ можно передать на сервер для аутентификации.

```bash
ssh-keygen -p -f /home/litvinigor/.ssh/id_rsa
```
- Пример использования.
- Флаг `-p` убирает парольную фразу существующего ключа.
- Флаг `-t` отключает парольную фразу при создании.
- Флаг `-f` определяет расположение ключа.

---

**SSH Keyinfo**

**ssh-keyinfo** - это утилита, которая предоставляет информацию о ключах SSH (тип, размер, хеш-значение и дополнительную информацию о ключе) для анализа.

## SFTP

**sftp** - это утилита для передачи файлов по безопасному каналу, похожая на `ftp`, но, работающая поверх ssh.

```bash
useradd -g sftpgroup sftpuser
passwd sftpuser
```
- Для безопасного использования SFTP, лучше всего создать группы и пользователей, которые будут использовать только эту службу.

```bash
mkdir -p /data/sftpuser/upload 
chown -R root.sftpgroup /data/sftp 
chown -R sftpuser.sftpgroup /data/sftp/upload
```
- Создание каталогов, регулирование прав доступа.

```bash
sftp sftpuser@server
```
- Подключение по sftp (Аналогично ssh).

Основные команды sftp:

1. `get` - загрузка содержимого с удаленного сервиса
2. `put` - загрузка содержимого из локальной системы в удаленную
3. `rm` - удаление файлов на сервере

## SCP

**scp** - это утилита, которая копирует файлы между хостами, используя ssh.

Команда устанавливает защищенное соединение между хостом1 и хостом2 и копирует файл1 хоста1 в файл2 хоста2. Любой из хостов может быть локальным. Если имя хоста не указано, подразумевается локальный хост.

```bash
scp user@host:/from/file.txt to/  # С сервера на хост
scp user@host:/from/file.txt user@host:/to  # С сервера на сервер
scp /from/file.txt user@host:/to  # С хоста на сервер
```
- Способы копирования файла.
- Флаг `-r` позволяет рекурсивно копировать директорию и ее содержимое.
- Флаг `-P` позволяет указать другой порт.
- Флаг `-C` сжимает данные с помощью gzip.
- Флаг `-v` выводит отладочную информацию.
- Флаг `-p` сохраняет атрибуты файлов при копировании.
- Флаг `-q` не выдавать индикатор прогресса.

## MFA

Реализация MFA для SSH.

---

**1 Установка Google Authenticator**

Необходимо установить приложение Google Authenticator на устройство Android или IOS, а также на Linux.

```bash
sudo apt install libpam-google-authenticator
```
- Установка Google Authenticator в Linux.

---

**2 Генерирование начального токена для пользователя**

```bash
google-authenticator
```
- В качестве первого шага в настройке MFA необходимо выполнить следующую команду из терминала. Она выполнит начальную настройку и сгенерирует ключ TOTP. Этот ключ предназначен для пользователя, выполняющего команду, и не применим ко всем остальным пользователям системы

Существует определенная последовательность шагов, при выполнении которых будет предложено выбрать вариант (y/n).

Будет предложено выбрать токены аутентификации на основе времени. Токены аутентификации по времени будут генерировать новый код каждые 30 секунд. Нажмите «y», чтобы продолжить.

Секретный токен будет сгенерирован вместе с QR-кодом. Откройте мобильное приложение Google Authenticator и отсканируйте QR-код или введите секретный ключ вручную, чтобы зарегистрировать устройство. После этого приложение начнет генерировать токены каждые 30 секунд.

На этом этапе вам будет предложено обновить файл .google_authenticator в домашнем каталоге. В этом файле сохраняются все секретные ключи, код проверки, аварийные коды. Нажмите «y», чтобы продолжить.

При выборе «y» на этом шаге срок действия токена истечет сразу после того, как вы использовали его для аутентификации. В этом случае, даже если хакеры получат ваш токен, он будет просрочен.

Этот шаг определяет, сколько токенов будет разрешено, а также временные рамки. Если выбрать «n», то будет разрешено 3 токена в течение 90 секунд. Если выбрать «y», то будет разрешено 17 токенов в течение 240 секунд.

На этом шаге вам будет предложено включить ограничение частоты. Ограничение частоты позволяет злоумышленнику предпринимать только 3 попытки входа в систему каждые 30 секунд. Если токены неверны, то ему придется ждать временной интервал N, чтобы повторить попытку.

Откройте файл `~/.google_authenticator` и вы увидите все настройки и секретные коды, которые сделали в ходе всех этих шагов.

```bash
google-authenticator -q -t -d -f -r 3 -R 30 -w 3
```
- Также можете передать аргументы команде google-authenticator, которая создаст ключи и другие настройки без выполнения данной последовательности шагов
```bash
google-authenticator --help
```
- Обратитесь к разделу помощи аутентификатора Google, чтобы узнать, что эти аргументы означают.

---

**3 Настройка SSH**

Необходимо внести некоторые изменения в конфигурацию openSSH, чтобы можно было начать использовать MFA.

```bash
sudo cp /etc/ssh/sshd_config /etc/ssh/sshd_config.backup

sudo cp /etc/pam.d/sshd /etc/pam.d/sshd.backup
```
- Делаем резервные копии файлов конфигураций SSH

```bash
ChallengeResponseAuthentication yes
```
- Необходимо разрешить SSH использовать MFA, установив в файле /etc/ssh/sshd_config настройку
```bash
# Делает этот метод необязательным
auth required pam_google_authenticator.so nullok
# Разрешить пользователю войти в систему, если не используется MFA
auth required pam_permit.so
```
- Необходимо добавить строки в файл /etc/pam.d/sshd. Если вы хотите сделать MFA обязательным для всех пользователей, удалите слово «nullok».
```bash
sudo systemctl restart sshd
```
- Перезапускаем службу ssh, чтобы изменения вступили в силу

---

**4 Проверка работы**

Подключитесь к серверу через SSH, и вам будет предложено ввести пароль в качестве первого фактора, а затем проверочный код в качестве второго фактора аутентификации.

```bash
ssh user@hostname
```
- Подключение к серверу. После ввода пароля SSH и проверочного кода вы сможете войти в систему

---

**5 Многофакторная аутентификация при аутентификации на основе ключей**

Если настроили аутентификацию на основе ключей, то вам не будут предлагать ввести пароль или проверочные коды. Почему?

Потому что по умолчанию ssh сначала использует аутентификацию на основе открытого ключа, и если ключ найден, то аутентификация выполняется с его помощью. В случае, если ключ не найден, он будет использовать аутентификацию на основе пароля.

```bash
ssh -v -i ~/.ssh/id_rsa username@hostname
```
- Можно использовать режим verbose, чтобы проверить это
```bash
AuthenticationMethods publickey,password publickey,keyboard-interactive
```
- Добавляем строку в конец файла /etc/ssh/sshd_config
```bash
#@include common-auth
```
- Закомментируем строку в файле /etc/pam.d/sshd. Если не закомментировать «@include common-auth», то это позволит использовать более двух факторов для аутентификации. Сначала будет выполняться аутентификация с использованием ключей, затем пароля и токенов.

Для проверки подлинности нам нужен только ключ и токен, поэтому отключим аутентификацию с использованием пароля.

```bash
sudo systemctl restart sshd
```
- Перезапускаем службу

---

**6 Восстановление**

Иногда возникает ситуация, когда вы теряете или меняете свое мобильное устройство. В этом случае вам придется переустановить приложение google-authenticator и зарегистрировать секретный ключ, чтобы начать генерировать токены.

Если вы заблокированы в системе, то вам придется войти непосредственно на сервер, чтобы создать новые секретные ключи для регистрации и использования. Но есть и альтернативный подход, когда вы можете войти в систему по ssh и сгенерировать ключи вновь.

Помните коды, которые генерируются на начальном этапе? Вы можете использовать аварийный скретч-код в качестве маркера для входа в систему. Каждый скретч-код можно использовать только один раз. Сохраните его в надежном месте, чтобы он мог быть использован в нужный момент.

Коды сохраняются в файле ~/.google_authenticator.
