# RAID

**RAID** - технология объединения двух и более накопителей в единый логический элемент с целью повышения производительности и (или) отказоустойчивости отдельно взятого элемента массива.

В системах хранения данных критически важны сохранность и время восстановления в случае сбоя. Свою ценность, а в некоторых задачах и более высокую, имеет скорость работы накопителей. Использование RAID-массивов в различных конфигурациях - это поиск компромисса между перечисленными параметрами.

**Аппаратные и программные RAID-массивы**
- Программные массивы создаются уже после установки ОС средствами программных продуктов и утилит, что и является главным недостатком таких дисковых массивов
- Аппаратные RAID’ы создают дисковый массив до установки ОС и от неё не зависят

**Далее мы рассмотрим именно программную реализацию RAID системы.**

В случае, когда происходит поломка РЕЙД-контроллера, восстановить информацию практически невозможно (не относится к «Зеркалу»). Даже если купить точно такой же контроллер, высока вероятность, что RAID будет собран из других секторов диска, а значит информация на дисках будет потеряна.

# 1 Уровни RAID

Система RAID традиционно описывается в терминах “уровней”, определяющих конкретные детали параллелизма и избыточности. Возможно, этот термин является неудачным, потому что более высокий уровень не обязательно оказывается лучшим . Уровни - это просто разные конфигурации; вы можете использовать любой из них.

## RAID 1

RAID 1 (также называют «Mirror» - Зеркало) - предполагает полное дублирование данных с одного физического диска на другой.

К недостаткам RAID 1 можно отнести то, что вы получаете в два раза меньше дискового пространства. Т.е. ели вы используете ДВА диска по 250 Гб, то система будет видеть всего ОДИН размером 250 Гб.

Данный вид RAID **не дает выигрыша в скорости, но значительно повышает уровень отказоустойчивости**, ведь если один диск выйдет из строя, всегда есть его полная копия. Запись и стирание с дисков происходит одновременно. Если информация была намеренно удалена, то возможности восстановить её с другого диска уже не будет.

![https://i.imgur.com/634RXgy.png](https://i.imgur.com/634RXgy.png)

## RAID 0

RAID 0 (также называют «Striping» - Чередование) - предполагает разделение информации на блоки и одновременная запись разных блоков на разные диски.

Такая технология _**повышает скорость чтения/записи**_, позволяет пользователю использовать полный суммарный объем дисков, однако **понижает отказоустойчивость**, вернее сводит её на ноль. Так, в случае выхода из строя одного из дисков, восстановить информацию будет практически невозможно. Для сборки RAID 0 рекомендуется использовать исключительно высоконадежные диски.

![https://i.imgur.com/sRhmNAi.png](https://i.imgur.com/sRhmNAi.png)

## RAID 5

**RAID 5 можно назвать более усовершенствованным RAID 0**. Можно использовать от 3 жестких дисков. На все, кроме одного записывается рейд 0, а на последний специальная контрольная сумма, что позволяет сохранить информацию на винчестерах в случае «смерти» одного из них (но не более одного). Скорость работы такого массива высокая. На восстановление информации в случае замены диска потребуется много времени.

![https://i.imgur.com/Qr17qlJ.png](https://i.imgur.com/Qr17qlJ.png)

## RAID 2, 3, 4

**Это способы распределенного хранения информации с использованием дисков, выделенных под коды четности**. Отличаются друг от друга только размерами блока. На практике практически не используются в связи с необходимостью отдавать большую долю дисковой емкости под хранение кодов ЕСС и/или четности, а также в связи с невысокой производительностью.

## RAID 10

RAID 10 - микс RAID массивов 1 и 0. Объединяет в себе плюсы от каждого:  высокая производительность и высокая отказоустойчивость.

![https://i.imgur.com/M5bqRTE.png](https://i.imgur.com/M5bqRTE.png)

Массив обязательно содержит четное количество дисков (минимум 4) и является самым надежным вариантом сохранения информации. Недостатком является высокая стоимость дискового массива: эффективная емкость составит половину от общей емкости дискового пространства.

## RAID 50

RAID 50 - микс RAID массивов 5 и 0. Строится RAID 5, но его составляющими будут не самостоятельные жесткие диски, а массивы RAID 0.

![https://i.imgur.com/JEB1Dpk.png](https://i.imgur.com/JEB1Dpk.png)

# 2 RAID в Linux (mdadm)

Стандартная реализация программного обеспечения RAID для системы Linux называется md, драйвер “нескольких дисков” (“multiple disks” driver). Его внешний интерфейс обеспечивает команда `mdadm`.

Драйвер md поддерживает все конфигурации RAID, перечисленные выше. Предыдущая система под названием `raidtools` больше не используется .

Также можно реализовать RAID в системе Linux с помощью диспетчера логических томов (LVМ2), или Btrfs, или другой файловой системы со встроенными функциями управления томами и поддержки RAID.

Все эти системы активно поддерживаются, поэтому выбирайте в зависимости от того, что вы предпочитаете. Сайтам без установленной базы лучше всего перейти непосредственно на систему “все-в-одном”, например Btrfs.

# 3 Создание массива RAID 5

В следующем сценарии выполняется конфигурация массива RAID 5, состоящего из трех идентичных жестких дисков объемом 1 Тбайт. Несмотря на то что драйвер md может использовать в качестве компонентов неформатированные диски , мы предпочитаем снабдить каждый диск таблицей разделов, поэтому начинаем с запуска утилиты gparted, создающей таблицу разделов GРТ на каждом диске , и выделения всего дискового пространства одному разделу типа “Linux RAID”.

Совершенно не обязательно задавать тип раздела, но это будет полезной информацией для тех, кто станет просматривать таблицу разделов позднее:

Первое, что делаем - это вводим команду `fdisk -l` и смотрим какие диски не заняты.

```bash
mdadm --create --v /dev/md5 --level=5 --raid-devices=3 /dev/sde /dev/sdg /dev/sdf
```
- Создание RAID 5
- `/dev/md5` — устройство RAID, которое появится после сборки;
- `level 5` — уровень RAID;
- `-raid-devices=3` — количество дисков, из которых собирается массив;
- `/dev/sde, /dev/sdg, /dev/sdf` — сборка выполняется из дисков sde, sdg и sdf.

```bash
cat /proc/mdstat
```
- Виртуальный файл `/proc/mdstat` всегда содержит краткое описание состояния драйвера md, а также состояния всех массивов RAID, существующих в системе. Особенно полезно проанализировать содержимое файла `/proc/mdstat` после добавления нового диска или замены неисправного

Драйвер md не следит за тем, какой блок в массиве был использован, поэтому он должен вручную синхронизировать все блоки четности с их соответствующими блоками данных. Драйвер md запускает операцию “восстановления” (“recovery”) данных, потому что, по существу, она совпадает с той процедурой, которая выполняется после замены неисправного диска. Для больших массивов она может выполняться довольно длительное время (несколько часов, или даже дней).

Обратите внимание на то, что при выполнении команды `mdadm -create` указывается путь к устройству для составного массива. Пути md-устройств старого стиля выглядели как `/dev/md0`, но когда вы указываете путь в каталоге `/dev/md`, как это было сделано в данном примере, mdadm записывает выбранное имя в суперблок массива.

```bash
mkdir /home/raid5
mkfs.ext4 /dev/md5
mount /dev/md5 /home/raid5
```
- Создание файловой системы на raid5 и монтирование его к директории
```bash
/dev/md5 /home/raid5 ext4 defaults 1 2
```
Добавляем данные в /etc/fstab. Эта мера гарантирует, что вы всегда можете найти массив по логическому пути, даже если после перезагрузки массив активизирован автоматически и ему может быть присвоен другой номер. Как видно из записей журнала, приведенных выше, массив также имеет традиционное имя (здесь, **/dev/md5**), а `/dev/md/extra` - это просто символическая ссылка на реальное устройство массива

## 3.1 mdadm.соnf: документирование конфигурации массива

Формально, команда mdadm не требует наличия файла конфигурации, но если он есть, она его использует (как правило, это файл `/etc/mdadm/mdadm.conf` или `/etc/mdadm.conf`). В результате вы создадите в стандартном месте документацию по конфигурации системы RAID, позволяя администратору просмотреть информацию при возникновении проблемы.

В качестве альтернативы использованию файла конфигурации можно задавать конфигурацию в командной строке при каждой активизации массива. Команда `mdadm --detail --scan` записывает текущие настройки системы RAID в файл конфигурации `mdadm.conf`

```bash
sudo mdadm --detail --scan

	ARRAY /dev/md/extra metadata= 1.2 name=ubuntu
	: extra UUID=b72de2fb : 60b30Заf : Зс176048 : dс5Ьбс8Ь
```

Теперь команда mdadm сможет прочитать файл mdadm.conf при загрузке или завершении работы системы, что намного упростит управление массивом.

```bash
sudo mdadm -S /dev/md/extra
```

```bash
sudo mdadm -Ав /dev/md/extra
```

Первая из приведенных выше команд сработает, даже если файла mdadm.conf не существует, а вторая - нет

Команда mdadm имеет режим `--monitor`, в котором она выполняется постоянно как демон и сообщает по электронной почте о проблемах, возникших в массиве RAID.

_**Для того чтобы ее настроить, добавьте строку МAILADDR в свой файл mdadm.conf.**_ Конфигурация MAILADDR указывает адресата, которому следует отправлять предупреждения по электронной почте

# 4 Создание RAID 1

```bash
mdadm --create --verbose /dev/md0 -l 1 -n 2 /dev/sdb /dev/sdc
```
- Создаем RAID 1 с двумя дисками
- `/dev/md0` — устройство RAID, которое появится после сборки;
- `l 1` — уровень RAID;
- `n 2` — количество дисков, из которых собирается массив;
- `/dev/sd{b,c}` — сборка выполняется из дисков sdb и sdc.
```bash
lsblk
```
- С помощью lsblk проверяем

## 4.1 Создание файла mdadm.conf

```bash
mkdir /etc/mdadm
echo "DEVICE partitions" > /etc/mdadm/mdadm.conf
mdadm --detail --scan --verbose | awk '/ARRAY/ {print}' >> /etc/mdadm/mdadm.conf
```
- Создание файла. В файле mdadm.conf находится информация о RAID-массивах и компонентах, которые в них входят

## 4.2 Создание файловой системы и монтирование массива

![https://i.imgur.com/INadKqY.png](https://i.imgur.com/INadKqY.png)
- Создаем на md0 файловую систему ext4
```bash
mount /dev/md0 /home/raid1
```
- Монтируем массив в каталог /home/raid1
```bash
/dev/md0 /mnt ext4 defaults 1 2
```
- Добавляем строку в fstab, чтобы данный раздел также монтировался при загрузке системы

## 4.3 Информация о RAID

```bash
cat /proc/mdstat
```
- Посмотреть состояние всех RAID можно командой
- md0 - имя RAID устройства
- raid1 sdc[1] sdb[0] - уровень избыточности и из каких дисков собран
- 1046528 blocks - размер массива
- 2/2 - количество юнитов, которые на данный момент используются

```bash
mdadm -D /dev/md0
```
- Подробная информация о массиве
- Version — версия метаданных.
- Creation Time — дата в время создания массива.
- Raid Level — уровень RAID.
- Array Size — объем дискового пространства для RAID.
- Used Dev Size — используемый объем для устройств. Для каждого уровня будет индивидуальный расчет: RAID1 — равен половине общего размера дисков, RAID5 — равен размеру, используемому для контроля четности.
- Raid Devices — количество используемых устройств для RAID.
- Total Devices — количество добавленных в RAID устройств.
- Update Time — дата и время последнего изменения массива.
- State — текущее состояние. clean — все в порядке.
- Active Devices — количество работающих в массиве устройств.
- Working Devices — количество добавленных в массив устройств в рабочем состоянии.
- Failed Devices — количество сбойных устройств.
- Spare Devices — количество запасных устройств.
- Consistency Policy — политика согласованности активного массива (при неожиданном сбое). По умолчанию используется resync — полная ресинхронизация после восстановления. Также могут быть bitmap, journal, ppl.
- Name — имя компьютера.
- UUID — идентификатор для массива.
- Events — количество событий обновления.
- Chunk Size (для RAID5) — размер блока в килобайтах, который пишется на разные диски.

```bash
fdisk -l /dev/md0
```
- Информация о разделах и дисковом пространстве массива

## 4.4 Проверка целостности массивов

```bash
echo 'check' > /sys/block/md0/md/sync_action
```
- Для проверки целостности вводим
```bash
cat /sys/block/md0/md/mismatch_cnt
```
- Результат проверки смотрим командой. Если команда возвращает 0, то с массивом все в порядке
```bash
echo 'idle' > /sys/block/md0/md/sync_action
```
- Остановка проверки

## 4.5 Восстановление RAID

```bash
cat /proc/mdstat
```
- Смотрим файл, чтобы определить, что один из дисков массива вышел из строя. О наличии проблемы нам говорит нижнее подчеркивание вместо U — [U_] вместо [UU]
```bash
mdadm -D /dev/md0
```
- Или так. Статус degraded говорит о проблемах с RAID

```bash
mdadm /dev/md0 --remove /dev/sdc
```
- Для восстановления, сначала удалим сбойный диск
```bash
mdadm /dev/md0 --add /dev/sde
```
- Теперь добавим новый
```bash
mdadm -D /dev/md0
```
- Смотрим состояние массива
- recovering говорит, что RAID восстанавливается; Rebuild Status — текущее состояние восстановления массива (в данном примере он восстановлен на 40%)
```bash
echo '10000' > /proc/sys/dev/raid/speed_limit_min
```
- Если синхронизация выполняется слишком медленно, можно увеличить ее скорость. По умолчанию скорость speed_limit_min = 1000 Кб, speed_limit_max — 200000 Кб. Для изменения скорости, можно поменять только минимальную

## 4.6 Пересборка массива

```bash
mdadm --assemble --scan
```
- Находим необходимую конфигурацию и восстанавливаем RAID, чтобы вернуть ранее разобранных или развалившийся массив из дисков, которые уже входили в состав RAID
```bash
mdadm --assemble /dev/md0 /dev/sdb /dev/sdc
```
- Указываем из каких дисков пересобрать массив

## 4.7 Запасной диск (Hot Spare)

Если в массиве будет запасной диск для горячей замены, при выходе из строя одного из основных дисков, его место займет запасной.

```bash
mdadm /dev/md0 --add /dev/sdd
```
- Добавляем диск к массиву. Диском Hot Spare станет тот, который просто будет добавлен к массиву
```bash
mdadm -D /dev/md0
```
- Информация о массиве
```bash
mdadm /dev/md0 --fail /dev/sdc
```
- Проверим работоспособность резерва вручную, симулировав выход из строя одного из дисков
```bash
mdadm -D /dev/md0
```
- И смотрим состояние. На замену вышедшему из строя диску встал hot-spare диск.

## 4.8 Добавить диск к массиву

В данном примере рассмотрим вариант добавления активного диска к RAID, который будет использоваться для работы, а не в качестве запасного.

```bash
mdadm /dev/md0 --add /dev/sde
```
- Добавляем диск к массиву
```bash
4 8 16 - spare /dev/sde
```
- Новый диск мы увидим в качестве spare
```bash
mdadm -G /dev/md0 --raid-devices=3
```
- Теперь расширяем RAID. Подразумевается, что у нас RAID 1 и мы добавили к нему 3-й диск