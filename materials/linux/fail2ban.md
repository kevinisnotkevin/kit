# FAIL2BAN

fail2ban - утилита, которая отслеживает log-файлы запущенных программ, и на основании различных условий блокирует IP.  

Fail2ban известен благодаря готовности «из коробки» к защите SSH-сервера от атак типа «bruteforce», то есть к защите SSH от перебора паролей.

Написана на языке программирования Python, может работать на POSIX-системах имеющих встроенный менеджер пакетов и брандмауэр, например, iptables.  

Принцип работы fail2ban прост. Специальный сервис ищет в системных журналах (логах) записи о неудачных попытках аутентификации и при определенных условиях с помощью iptables блокирует IP-адреса, с которых ведется атака.

# Конфигурация  

Базовая защита SSH сервера от перебора паролей будет включена по умолчанию.  

У программы два основных файла конфигурации:  
- /etc/fail2ban/fail2ban.conf - отвечает за настройки запуска процесса Fail2ban  
- /etc/fail2ban/jail.conf - содержит настройки защиты конкретных сервисов  

Файл jail.conf поделён на секции, каждая секция отвечает за определённый сервис и тип атаки. Например секция [ssh] отвечает за защиту SSH от brute–force атак.Параметры из секции [DEFAULT] применяются ко всем секциям.

# Основные параметры файла jail.conf  

- ignoreip - IP–адреса, которые не должны быть заблокированы. Можно задать список IP-адресов разделённых пробелами, маску подсети, или имя DNS–сервера  
- bantime - время бана в секундах, по истечении которого IP–адрес удаляется из списка заблокированных  
- maxretry - количество подозрительных событий, после которых применяется правило. В контексте брутфорса - это число неудавшихся попыток логина, после которых происходит блокировка
- enabled - значение указывает что данный jail активен, выключает действие изолятора  
- port - указывает на каком порту или портах запущен целевой сервис  
- filter - имя фильтра с регулярными выражениями, по которым идёт поиск «подозрительных совпадений» в журналах сервиса  
- logpath - путь к файлу журнала, который программа Fail2ban будет обрабатывать с помощью заданного ранее фильтра. Вся история удачных и неудачных входов в систему, в том числе и по SSH, по умолчанию записывается в log–файл

# Пример настройки fail2ban  
  
Прежде чем вносить изменения следуя рекомендациям, отметим, что не стоит редактировать основной файл настроек jail.conf, для этого предусмотрены файлы с расширением *.local, которые автоматически подключаются и имеют высший приоритет.  

```bash
nano /etc/fail2ban/jail.local
```
- Изменение настроек

```bash
[DEFAULT]
## Постоянный IP-адрес.
## Если не переопределить ignoreip здесь,
## то стоит закомментировать этот параметр в jail.conf.
ignoreip = [57.66.158.131](https://57.66.158.131)

[ssh]
## если в течении 1 часа:
findtime = 3600
## произведено 6 неудачных попыток логина:
maxretry = 6
## то банить IP на 24 часа:
bantime = 86400
```

```bash
service fail2ban restart
```  
- Перезапуск fail2ban

# Практика

```bash
[sshd]
enable = true # модуль hhd включен
port = ssh # номер порта ssh
filter = sshd # применяемый фильтр
logpath = /var/log/auth.log # log-файл
maxretry = 3 # максимальное количество попыток входа
bantime = 3600 # после максимального количества попыток забанить на 3600 сек
ignoreip = [127.0.0.1](https://127.0.0.1)

[nginx-limit-req]
port = http, https
enabled = true
filter = nginx-limit-req
action = iptables-multiport[name=ReqLimit, port="http,https", protocol=tcp]
logpath = /var/log/nginx/*error.log
findtime = 600
bantime = 3600
maxretry = 4
```
- Внесем параметры jail.conf

Но как мы уже знаем, настройки конфигурационных файлов поумолчанию могут быть перезаписаны при обновлении, поэтому создаём новый файл.

```bash
[Init]
blocktype = DROP
```
- Создаем файл iptables-blocktype.local и записываем туда
```bash
service fail2ban restart
```
- Перезагрузка сервиса