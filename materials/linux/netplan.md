# NETPLAN

- Начиная с релиза Ubuntu 17.10, для управления конфигурацией сети используется утилита netplan. Раньше для этих целей применялся скрипт ifupdown, конфигурационные файлы которого находились в папке /etc/network/interfaces. Недостатком такого подхода было то, что файлы настройки сети были разбросаны по всей системе, частью настроек мог управлять NetworkManager, частью systemd-networkd, а часть вообще делалась с помощью ifupdown
- Все конфигурационные файлы Netplan находятся в папке /etc/netplan/. Во время запуска службы, она преобразовывает свою конфигурацию в конфигурацию той службы, которая будет управлять сетью и помещает её в каталог /run/
- По умолчанию управление всей сетью передаётся утилите NetworkManager

> [!NOTE] Параметры netplan
> - **renderer** - программа для обработки конфигурации
> - **dhcp4** - получение IPv4 адреса по DHCP
> - **dhcp6** - получение IPv6 адреса по DHCP
> - **dhcp-identifier** - если передать значение "mac", то будет использоваться MAC-адрес в качестве идентификатора DHCP
> - **addresses** - добавляет статические адреса к интерфейсу, можно несколько
> - **gateway4** - указывает шлюз IPv4
> - **gateway6** - указывает шлюз IPv6
> - **nameservers** - указывает DNS-серверы
> - **macaddress** - устанавливает новый MAC-адрес
> - **routes** - позволяет настроить маршруты таблицы маршрутизации
> - **routing-policy** - дополнительная настройка маршрутов, для IP или подсети
> - **access-points** - список точек доступа для Wi-Fi
> - **password** - пароль для точки доступа Wi-Fi
> - **mode** - режим работы сетевой карты Wi-Fi

```yaml
ls /sys/class/net
```
- Названия сетевых интерфейсов в системе
```yaml
# /etc/netplan/02-networkd.yaml

network:
  version: 2
  renderer: networkd
   ethernets:
    ens33:
     dhcp4: yes
```
- Настройка динамического IP-адреса для интерфейса enp3s0
```yaml
network:
  version: 2
  renderer: networkd
  ethernets:
    ens33:
      dhcp4: yes
      nameservers:
        addresses:
          - 8.8.8.8
          - 8.8.4.4
```
- В качестве программы для обработки конфигурации используем Networkd, далее указываем сетевой интерфейс и включаем получение IPv4 адреса по DHCP. Все остальные параметры тоже подтянутся по DHCP. Или мы можем вручную настроить DNS для этого интерфейса
```bash
netplan generate
netplan apply
```
- Проверка и применение конфигурации. Для детального вывода добавить флаг debug
```yaml
network:
  version: 2
  renderer: networkd
  ethernets:
    ens33:
      dhcp4: no
      addresses: [ 192.168.1.10/24 ]
      gateway4: 192.168.1.1
      nameservers:
        addresses: [ 8.8.8.8, 8.8.4.4 ]
```
- Статический IP-адрес в netplan настроить немного сложнее. Нужно будет задать не только непосредственно сам адрес, но и другие параметры, которые система раньше получала по DHCP. Надо указать шлюз для доступа в интернет и DNS-серверы. Отключаем получение IP адреса по DHCP (dhcp4).  **addresses** параметр ожидает список IP-адресов, которые нужно присвоить сетевой карте. В конце адреса указывается префикс маски (/24). Маску можно указать только с помощью префикса. **gateway4** задаёт адрес роутера, через который компьютер сможет получить доступ в интернет. Списки можно оформлять не только с помощью черточек, для каждого пункта с новой строки, но и с помощью квадратных скобок, тогда элементы записываются в одну строку через запятую
```yaml
network:
  version: 2
  renderer: networkd
  wifis:
    wlp3s0b1:
      dhcp4: yes
      dhcp6: no
      nameservers:
        addresses: [ 8.8.8.8, 8.8.4.4 ]
      access-points:
        "AccessPoint":
          password: "12345678"
```
- Кроме проводного подключения, система конфигурации netplan умеет управлять подключением к Wi-Fi. Для работы Wi-Fi через Networkd необходим пакет wpasupplicant. На примере показано подключение к точке доступа AccessPoint с паролем 12345678


```
network:
    version: 2
    renderer: networkd
    ethernets:
        ens3:
            dhcp4: true
        ens7:
            dhcp4: no
            addresses: [192.168.122.195/24]
            routes:
              - to: default
                via: 192.168.122.1
            mtu: 1500
            nameservers:
                addresses: [8.8.8.8, 77.88.8.8]
                search: [ dmosk.local ]
        ens9:
            dhcp4: no
            addresses: [192.168.1.10/24, 192.168.1.20/24]
            nameservers:
                addresses:
                    - 8.8.8.8
                    - 77.88.8.8
                search: [ dmosk.local, dmosk.ru ]
```
- Пример настройки 3-х сетевых интерфейсов. Два из них будут с IP-адресами назначенными вручную (static IP), один по DHCP
- **version** - версия YAML. На момент обновления статьи, была 2
- **renderer** - менеджер сети (networkd или NetworkManager)
- **ethernets** - настройка сетевых адаптеров ethernet
- **ens3, ens7, ens9** - настройки для соответствующих сетевых адаптеров. В данном примере мы настраиваем 3 сетевых адаптера
- **dhcp4** - будет ли получать сетевой адаптер IP-адрес автоматически. Возможны варианты yes/true - получать адрес автоматически; no/false - адрес должен быть назначен вручную
- **addresses** - задает IP-адреса через запятую
- **routes** - настройка маршрутов. Для шлюза по умолчанию используем опцию и значение to: default. Ранее использовалась директива gateway4, но теперь она считается устаревшей (при применении настройки с ней система вернет предупреждение gateway4 has been deprecated, use default routes instead)
- **mtu** - при желании, можно задать значение MTU
- **nameservers** - настройка серверов имен (DNS)
- **nameservers addresses** - указываем серверы DNS. Обратите внимание на разный формат записи для ens7 и ens9. Приемлемы оба варианта
- **nameservers search** - дописывает окончание домена, если мы обращаемся к узлу сети только по его имени. Стоит обратить внимание, что мы можем указать несколько доменов через запятую
```
network:
    version: 2
    renderer: networkd
    ethernets:
        ens9:
            dhcp4: no
            addresses: 192.168.1.10/24
            nameservers:
                addresses:
                    - 8.8.8.8
                    - 77.88.8.8
            routes:
              - to: 192.168.0.0/24
                via: 192.168.1.1
                on-link: true
```
- Настройка маршрута для сетевого интерфейса ens9
- **to** - направление маршрута (в какую сеть мы должны попадать). В данном примере, 192.168.0.0/24
- **via** - через какой шлюз мы попадаем в сеть to
- **on-link** - активация маршрута при поднятии линка на сетевом интерфейсе


```
network:
    version: 2
    renderer: networkd
    ethernets:
        ens2f0: {}
        ens2f1: {}
    bonds:
        bond0:
            dhcp4: no
            interfaces:
            - ens2f0
            - ens2f1
            parameters:
                mode: active-backup
            addresses:
                - 192.168.122.195/24
            gateway4: 192.168.122.1
            mtu: 1500
            nameservers:
                addresses:
                    - 8.8.8.8
                    - 77.88.8.8
```
- Пример объединения интерфейсов (bonds). Объединяем физические интерфейсы ens2f0 и ens2f1; настройка parameters mode указываем на тип объединения:
- **balance-rr** (задействуются оба интерфейса по очереди, распределение пакетов по принципу Round Robin)
- **active-backup** (используется только один интерфейс, второй активируется в случае неработоспособности первого)
- **balance-xor** (задействуются оба интерфейса по очереди, распределение пакетов на основе политики хеширования xmit_hash_policy)
- **broadcast** (задействуются оба интерфейса одновременно, пакеты передаются все интерфейсы)
- **802.3ad** (задействуются оба интерфейса по очереди, распределение пакетов на основе политики хеширования xmit_hash_policy)
- **balance-tlb** (задействуются оба интерфейса по очереди, пакеты распределяются в соответствии с текущей нагрузкой)

```
network:
    version: 2
    renderer: networkd
    ethernets:
        ens2f0: {}
    bridges:
        br0:
            macaddress: ce:ce:ce:45:45:45
            interfaces:
                - ens2f0
            addresses:
                - 192.168.1.15/24
            gateway4:
            nameservers:
                addresses:
                    - 77.88.8.8
                    - 8.8.8.8
            mtu: 1500
            parameters:
                stp: true
                forward-delay: 4
            dhcp4: false
            dhcp6: false

```
- Пример настройки сетевого моста (bridge). Сетевой мост позволяет пропускать сетевой трафик через другой сетевой адаптер. Это можно применить, например, для организации хоста виртуальных машин (для трансфера трафика к виртуальным машинам KVM через единственный сетевой интерфейс сервера)
- **bridges** — настройки для интерфейсов bridge
- **bridges br0** — настройка интерфейса br0
- **macaddress** — физический адрес (MAC) интерфейса. Настройка важна для некоторых провайдеров VPS — без нее бридж может не заработать
- **interfaces** — перечисление интерфейсов, из которых собираем мост. В данном примере ens2f0
- **addresses, gateway4, nameservers** — сетевые настройки (IP-адрес, шлюз, сервер имен)
- **mtu** — одноименный параметр. Для сетей ethernet обычно равен 1500
- **parameters stp** — включает или отключает устранение петель в сети. В данном примере включено
- **parameters forward-delay** — время в секундах в течение которого мост будет оставаться в состояниях «Listening» и «Learning»
- **dhcp4, dhcp6** — включает или отключает автоматическое получение IP-адреса. В нашем случае, отключает

```
network:
    version: 2
    renderer: networkd
    ethernets:
        ens3: {}
    vlans: 
        vlan5:
            id: 5
            link: ens3
            dhcp4: no
            addresses: [10.0.0.15/24]
            gateway: 10.0.0.1
```
- Пример настройки тегированного интерфейса vlan с тегом 5 на физическом адаптере ens3

**Отключение netplan и возврат к interfaces**

```bash
vi /etc/default/grub
```
- Открываем настройку grub

`GRUB_CMDLINE_LINUX="netcfg/do_not_use_netplan=true"`
- Находим опцию GRUB_CMDLINE_LINUX и дописываем в нее параметр. Если GRUB_CMDLINE_LINUX содержит другие настройки, то наш параметр добавляем через пробел

```bash
apt install ifupdown
```
- Устанавливаем пакет ifupdown

```bash
nano /etc/network/interfaces
```
- Настраиваем сеть в файле

```
auto lo
iface lo inet loopback

auto ens5
iface ens5 inet dhcp
```
- Настраиваем сетевой интерфейс ens5 на автоматическое получение IP-адреса

```bash
update-grub
```
- Применяем настройки загрузчика

```bash
shutdown -r now
```
- Перезагружаем систему
