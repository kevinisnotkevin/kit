# nmap

[lab](materials/labs/linux_labs/lab_13.md)

nmap (Network Mapper) - утилита для аудита сети, поиска открытых портов на удаленных хостах.

Используется для сканирования хостов за фаерволом, поиска дыр в настройках HTTP-сервера, организации DoS-атаки, поднятия веб-сервера.

# 0 Основные флаги

```bash
-sL - просто создать список работающих хостов, но не сканировать порты nmap
-sP - только проверять доступен ли хост с помощью ping
-PN - считать все хосты доступными, даже если они не отвечают на ping
-sS/sT/sA/sW/sM - TCP сканирование
-sU - UDP сканирование nmap
-sN/sF/sX - TCP NULL и FIN сканирование
-sC - запускать скрипт по умолчанию
-sI - ленивое Indle сканирование
--p - указать диапазон портов для проверки
-sV - детальное исследование портов для определения версий служб
-O - определять операционную систему
-T[0-5] - скорость сканирования, чем больше, тем быстрее
-D - маскировать сканирование с помощью фиктивных IP
-S - изменить свой IP адрес на указанный
-e - использовать определенный интерфейс
--spoof-mac - установить свой MAC адрес
-A - определение операционной системы с помощью скриптов
```

```bash
-iL <inputfilename>: Input from list of hosts/networks
-iR <num hosts>: Choose random targets
--exclude <host1[,host2][,host3],...>: Exclude hosts/networks
--excludefile <exclude_file>: Exclude list from file
```

```bash
**HOST DISCOVERY:**
-sL: List Scan - simply list targets to scan
-sn: Ping Scan - disable port scan
-Pn: Treat all hosts as online -- skip host discovery
-PS/PA/PU/PY[portlist]: TCP SYN/ACK, UDP or SCTP discovery to given ports
-PE/PP/PM: ICMP echo, timestamp, and netmask request discovery probes
-PO[protocol list]: IP Protocol Ping
-n/-R: Never do DNS resolution/Always resolve [default: sometimes]
--dns-servers <serv1[,serv2],...>: Specify custom DNS servers
--system-dns: Use OS's DNS resolver
--traceroute: Trace hop path to each host
```

```bash
**SCAN TECHNIQUES:**
-sS/sT/sA/sW/sM: TCP SYN/Connect()/ACK/Window/Maimon scans
-sU: UDP Scan
-sN/sF/sX: TCP Null, FIN, and Xmas scans
--scanflags <flags>: Customize TCP scan flags
-sI <zombie host[:probeport]>: Idle scan
-sY/sZ: SCTP INIT/COOKIE-ECHO scans
-sO: IP protocol scan
-b <FTP relay host>: FTP bounce scan
PORT SPECIFICATION AND SCAN ORDER:
-p <port ranges>: Only scan specified ports
Ex: -p22; -p1-65535; -p U:53,111,137,T:21-25,80,139,8080,S:9
--exclude-ports <port ranges>: Exclude the specified ports from scanning
-F: Fast mode - Scan fewer ports than the default scan
-r: Scan ports consecutively - don't randomize
--top-ports <number>: Scan <number> most common ports
--port-ratio <ratio>: Scan ports more common than <ratio>
```

```bash
**SERVICE/VERSION DETECTION:**
-sV: Probe open ports to determine service/version info
--version-intensity <level>: Set from 0 (light) to 9 (try all probes)
--version-light: Limit to most likely probes (intensity 2)
--version-all: Try every single probe (intensity 9)
--version-trace: Show detailed version scan activity (for debugging)
```

```bash
**SCRIPT SCAN:**
-sC: equivalent to --script=default
--script=<Lua scripts>: <Lua scripts> is a comma separated list of
directories, script-files or script-categories
--script-args=<n1=v1,[n2=v2,...]>: provide arguments to scripts
--script-args-file=filename: provide NSE script args in a file
--script-trace: Show all data sent and received
--script-updatedb: Update the script database.
--script-help=<Lua scripts>: Show help about scripts.
<Lua scripts> is a comma-separated list of script-files or
script-categories.
```

```bash
**OS DETECTION:**
-O: Enable OS detection
--osscan-limit: Limit OS detection to promising targets
--osscan-guess: Guess OS more aggressively
TIMING AND PERFORMANCE:
Options which take <time> are in seconds, or append 'ms' (milliseconds),
's' (seconds), 'm' (minutes), or 'h' (hours) to the value (e.g. 30m).
-T<0-5>: Set timing template (higher is faster)
--min-hostgroup/max-hostgroup <size>: Parallel host scan group sizes
--min-parallelism/max-parallelism <numprobes>: Probe parallelization
--min-rtt-timeout/max-rtt-timeout/initial-rtt-timeout <time>: Specifies
probe round trip time.
--max-retries <tries>: Caps number of port scan probe retransmissions.
--host-timeout <time>: Give up on target after this long
--scan-delay/--max-scan-delay <time>: Adjust delay between probes
--min-rate <number>: Send packets no slower than <number> per second
--max-rate <number>: Send packets no faster than <number> per second
```

```bash
**FIREWALL/IDS EVASION AND SPOOFING:**
-f; --mtu <val>: fragment packets (optionally w/given MTU)
-D <decoy1,decoy2[,ME],...>: Cloak a scan with decoys
-S <IP_Address>: Spoof source address
-e <iface>: Use specified interface
-g/--source-port <portnum>: Use given port number
--proxies <url1,[url2],...>: Relay connections through HTTP/SOCKS4 proxies
--data <hex string>: Append a custom payload to sent packets
--data-string <string>: Append a custom ASCII string to sent packets
--data-length <num>: Append random data to sent packets
--ip-options <options>: Send packets with specified ip options
--ttl <val>: Set IP time-to-live field
--spoof-mac <mac address/prefix/vendor name>: Spoof your MAC address
--badsum: Send packets with a bogus TCP/UDP/SCTP checksum
```

```bash
**OUTPUT:**
-oN/-oX/-oS/-oG <file>: Output scan in normal, XML, s|<rIpt kIddi3,
and Grepable format, respectively, to the given filename.
-oA <basename>: Output in the three major formats at once
-v: Increase verbosity level (use -vv or more for greater effect)
-d: Increase debugging level (use -dd or more for greater effect)
--reason: Display the reason a port is in a particular state
--open: Only show open (or possibly open) ports
--packet-trace: Show all packets sent and received
--iflist: Print host interfaces and routes (for debugging)
--append-output: Append to rather than clobber specified output files
--resume <filename>: Resume an aborted scan
--stylesheet <path/URL>: XSL stylesheet to transform XML output to HTML
--webxml: Reference stylesheet from [Nmap.Org](<http://nmap.org/>) for more portable XML
--no-stylesheet: Prevent associating of XSL stylesheet w/XML output
```

```bash
**MISC:**
-6: Enable IPv6 scanning
-A: Enable OS detection, version detection, script scanning, and traceroute
--datadir <dirname>: Specify custom Nmap data file location
--send-eth/--send-ip: Send using raw ethernet frames or IP packets
--privileged: Assume that the user is fully privileged
--unprivileged: Assume the user lacks raw socket privileges
-V: Print version number
-h: Print this help summary page.
```

# 1 Введение

```bash
nmap 192.168.0.1
```
- Скан хоста

Запущенный с правами обычного пользователя nmap крайне неэффективен. Весь процесс сканирования при этом фактически сводится к попытке установить полноценное соединение с каждым из портов. 

В случае протокола TCP это значит, что nmap пошлет на удаленную сторону пакет SYN; если запрошенный порт открыт, машина ответит пакетом SYN/ACK, после чего nmap отправит пакет ACK и только потом закроет соединение с помощью пакета FIN.

Весь этот процесс осуществляется с помощью системного вызова connect() и, по сути, целиком ложится на сетевой стек ОС. В результате страдает как производительность сканирования, так и скрытность (сервисы, висящие на сканируемых портах, будут активно логировать соединения).

Совсем по-другому nmap ведет себя, когда запущен с правами root.

```bash
sudo nmap 192.168.0.1
```
- Запуск nmap с правами суперпользователя

В процессе сканирования отправляются различные типы сетевых пакетов (например, TCP SYN пакеты) на целевое устройство и анализируются ответы, чтобы определить открытые порты и доступные сервисы. Полученная информация о портах и сервисах отображается в виде отчета, который выводится в командной строке после завершения сканирования.

```bash
# Это уведомление о запуске программы nmap версии 7.80 в 14:37 по координированному всемирному времени (UTC) на указанную дату
Starting Nmap 7.80 ( <https://nmap.org> ) at 2024-05-16 14:37 UTC

# Это заголовок отчета сканирования, указывающий на IP-адрес сканируемого устройства
Nmap scan report for 192.168.0.1

# Это сообщение о том, что устройство доступно и имеет очень низкую задержку (0.000043 секунды)
Host is up (0.000043s latency).

# Это информация о скрытых портах: из 1000 возможных портов, только 3 открыты, остальные 997 закрыты
Not shown: 997 closed ports

# Это заголовок таблицы, описывающий столбцы портов, состояния и типа сервиса
PORT     STATE SERVICE

# Это строка в таблице, означающая, что порт 22 (протокол TCP) открыт для SSH (Secure Shell) сервиса
22/tcp   open  ssh

# Это строка в таблице, означающая, что порт 80 (протокол TCP) открыт для HTTP (Hypertext Transfer Protocol) сервиса
80/tcp   open  http

# Это строка в таблице, означающая, что порт 3000 (протокол TCP) открыт для PPP (Point-to-Point Protocol) сервиса
3000/tcp open  ppp

# Это сообщение о завершении сканирования. В результате сканирования был обнаружен 1 доступный хост (устройство) за 0.37 секунды
Nmap done: 1 IP address (1 host up) scanned in 0.37 seconds
```
- Отчет о результате сканирования

nmap сканирует не весь диапазон портов (65 536), а только 1000 портов типовых служб, определенных в файле `/usr/share/nmap/nmap-services`.

```bash
nmap -sS -sU -p 1-65535 192.168.0.1
```
- Отправка SYN-пакетов на каждый TCP-порт в указанном диапазоне и анализ ответов для определения состояния портов (открыт, закрыт или фильтрованный). Также nmap отправляет UDP-пакеты на каждый UDP-порт в указанном диапазоне и анализирует ответы для определения состояния портов. Результаты сканирования выводятся в консоль, показывая состояние каждого сканированного порта
- **`sS`** - опция указывает nmap использовать сканирование SYN, которое является одним из самых быстрых методов сканирования портов. Это позволяет определить, открыт ли порт на целевом устройстве, отправляя только пакеты SYN
- **`sU`** - эта опция указывает nmap выполнить UDP-сканирование, которое позволяет обнаружить открытые UDP-порты на целевом устройстве
- **`p 1-65535`** - опция указывает nmap сканировать все порты в диапазоне от 1 до 65535. Это включает как TCP, так и UDP порты

## 1.1 Определение названия и версии сервиса на порте

```bash
nmap -sV --version-all 192.168.0.1
```
- Сканирование устройства с IP-адресом 192.168.0.1. Флаг **`-sV`** указывает на выполнение сканирования с целью определения версий программных продуктов, работающих на открытых портах. Флаг **`--version-all`** активирует полное сканирование версий, что включает в себя более широкий диапазон тестов на определение версий программ

## 1.2 Обнаружение машин в сети

Хотя nmap известен именно как сканер портов, это также отличный инструмент для обнаружения машин в сети. Его можно натравить на любое количество хостов и буквально за несколько секунд получить результат пинга тысяч хостов. Вот только пингует хосты он совсем не так, как всем известная утилита ping. По умолчанию перед началом сканирования портов nmap посылает несколько пакетов, чтобы удостовериться в доступности хоста:
- ICMP Echo request - аналог того, как работает ping
- SYN-пакет на порт 443
- ACK-пакет на порт 80
- ICMP timestamp request

Так много способов проверки необходимы для обхода брандмауэров и ситуаций, когда, например, в ОС или сетевом оборудовании включен запрет отвечать на запросы ICMP Echo (сегодня это частая практика).

```bash
nmap -sP 192.168.127.197/24
nmap -sn 192.168.127.0/24
```
- Сканирование без проверки доступности
```bash
nmap -sU 192.168.127.0/24
```
- Сканирование UDP портов на указанном диапазоне IP адресов
- Nmap отправляет UDP пакеты на все порты узла в подсети 192.168.127.0/24
- Если узел отвечает на UDP запрос, то порт считается открытым
- Nmap анализирует ответы и выводит информацию о найденных открытых UDP портах на каждом узле в указанной подсети.

```bash
nmap -sn -iL /путь/до/файла
```
- `-sn` - опция, которая указывает Nmap на сканирование без отправки пакетов ping, что позволяет определить активные узлы в сети без их непосредственного контакта
- `-iL /путь/до/файла` - опция, которая указывает nmap на файл, содержащий список IP-адресов или диапазонов, которые необходимо просканировать. Nmap будет сканировать каждый IP-адрес из этого файла

## 1.3 Состояния портов

- open - порт открыт
- closed - порт закрыт
- filtered - порт фильтруется, неизвестно, закрыт или открыт
- unfiltered - порт не фильтруется, неизвестно, закрыт или открыт (такой результат может дать только ACK-сканирование)
- open|filtered - порт либо открыт, либо фильтруется
- closed|filtered - порт либо закрыт, либо фильтруется (такой результат может дать только Idle-сканирование)

# 2 Определение имени и версии ОС

```bash
nmap -O 192.168.0.1
```
- Отправка нестандартных пакетов и сопоставление ее ответов (время ответа, значения полей TTL, MTU, ACK, флаги TCP и др) с «базой отпечатков ОС» (/usr/share/nmap/nmap-os-db), для определения ОС

На основе собранных данных nmap делает предположение о типе ОС, которая работает на целевом устройстве. Это предположение может быть не точным из-за возможных манипуляций сетевыми параметрами или фильтрацией сетевого трафика.

```bash
# Это предположение о типе устройства, которое сканируется. В данном случае, предполагается, что это устройство общего назначения
Device type: general purpose

# Это предположение о операционной системе, которая запущена на целевом устройстве. В данном случае, это Linux версии 2.6.X
Running: Linux 2.6.X

# Общее описание операционной системы с использованием CPE (Common Platform Enumeration). Здесь указывается, что используется операционная система Linux с ядром версии 2.6.32
OS CPE: cpe:/o:linux:linux_kernel:2.6.32

# Более подробное описание операционной системы, указывающее на Linux версии 2.6.32
OS details: Linux 2.6.32

# Это оценка расстояния до целевого устройства в сети. В данном случае, устройство находится на расстоянии 0 хопов, что означает, что оно находится в той же локальной сети, что и источник сканирования
Network Distance: 0 hops
```
- Пример отчета

```bash
nmap -A 192.168.0.1
```
- Агрессивное сканирование (`-A`), включая определение ОС (`-O`) и дополнительную информацию о сервисах (`-sV`), а также сканирование версий (`-sV`) и сканирование на наличие уязвимостей (`-script`)

# 3 Повышение скорости сканирования

При сканировании сети с использованием утилиты nmap важно выбрать подходящий режим времени для баланса между скоростью сканирования и нагрузкой на сеть. В nmap представлено пять различных режимов времени, обозначаемых буквами T1, T2, T3, T4 и T5.

**T1 (Timing template 1)**:
- Это самый медленный режим сканирования, который предназначен для минимизации воздействия на сеть и снижения риска обнаружения.
- Рекомендуется для сканирования в высокобезопасных средах, где важно сохранить анонимность и минимизировать следы на сети.
**T2 (Timing template 2)**:
- Этот режим более агрессивный по сравнению с T1, но все еще остается медленным и предназначен для сканирования без существенного воздействия на сеть.
- Используется, когда требуется более точное сканирование, но при этом необходимо осторожно относиться к сетевой инфраструктуре.
**T3 (Timing template 3)**:
- T3 является сбалансированным режимом, который обеспечивает компромисс между скоростью и агрессивностью сканирования.
- Рекомендуется для общего сканирования сети, когда требуется достаточно быстрый результат без значительного воздействия на производительность.
**T4 (Timing template 4)**:
- Этот режим является наиболее распространенным и предпочтительным в большинстве случаев.
- Он более агрессивен и быстр, что позволяет сканировать большие сети за разумное время.
- Рекомендуется для обычного сканирования сети в большинстве сценариев.
**T5 (Timing template 5)**:
- T5 является самым быстрым и наиболее агрессивным режимом сканирования.
- Он отправляет максимальное количество запросов в секунду, что существенно ускоряет процесс сканирования.
- Рекомендуется только в случаях, когда требуется минимальное время сканирования, и риск обнаружения высок.

```bash
nmap -T1 -Pn --open -oN security_art.txt 192.168.0.1
```
- nmap используется для создания "картины безопасности" сети. Здесь каждый открытый порт и обнаруженное устройство становятся частью "художественного полотна" безопасности
```bash
nmap -T2 --reason -A -oX network_mystery.xml 192.168.0.1
```
- nmap выступает в роли исследователя, ищущего тайны в сети. `--reason` поможет раскрыть причины, по которым определенные порты были открыты, а `-A` добавит дополнительную информацию о сервисах. `-oX` указывает Nmap сохранить результаты сканирования в формате XML в файле `network_mystery.xml`
```bash
nmap -T3 -sn -oG network_panorama.gnmap 192.168.0.1
```
- nmap используется для создания "панорамного снимка" сети, где `-sn` (ping scan) используется для быстрого определения активных хостов, а `-oG` выводит результаты в формате GNMAP
```bash
nmap -T4 -sV -p- -oA network_detective 192.168.0.1
```
- nmap используется для обнаружения всех служб на целевом хосте с помощью `-sV` и сканирования всех портов с `-p-`, а `-oA` сохраняет результаты во всех трех форматах: XML, nmap
```bash
nmap -T5 -p1-65535 -oX network_furious.xml 192.168.0.1
```
- nmap сканирует все порты от 1 до 65535. Результаты сохраняются в XML

```bash
nmap -A -sV -p- -sS -T4 -v -oN scan_results.txt 192.168.0.1
```
- `-A` - включает в себя множество функций, включая обнаружение операционной системы, версий сервисов и сканирование на наличие уязвимостей
- `-sV` - позволяет определить версии сервисов, работающих на открытых портах
- `-p-` - сканирует все 65535 портов на устройстве
- `-sS` - запускает SYN Stealth сканирование, чтобы определить открытые порты
- `-T4` - устанавливает агрессивный режим сканирования
- `-v` - устанавливает уровень подробности вывода на высокий
- `-oN scan_results.txt` - указывает на сохранение результатов в файл `scan_results.txt`

# 4 Скрытие следов

## 4.1 Увеличение задержки между пробами портов

Одновременный запуск нескольких потоков сканирования, подменяя обратный IP-адрес во всех случаях, кроме одного. Смысл в том, чтобы запутать IDS и администратора машины. В логах IDS окажется сразу несколько попыток сканирования с разных адресов, среди которых будет только один настоящий.

```bash
nmap -D адрес1,адрес2,адрес3 192.168.0.1
```

```bash
nmap -sS -T4 -Pn -D RND:40 192.168.0.0/24
```
- Сканирование сети с использованием сканирования SYN, установленной скорости передачи данных и отключенным обнаружением хостов.  `-D RND:40` включает использование поддельных IP-адресов при сканировании (Каждый поддельный адрес будет выбираться из пула 40 адресов

## 4.2 Idle

**Более сложный способ** — организовать так называемое Idle-сканирование. Это очень интересная техника, которая базируется на трех простых фактах:

- При выполнении SYN-сканирования удаленная сторона посылает пакет SYN/ACK в случае, если порт открыт, и пакет RST, если нет.
- Машина, получившая не запрошенный пакет SYN/ACK, должна отвечать пакетом RST, а при получении не запрошенного RST — игнорировать его.
- Каждый IP-пакет, отправленный машиной, имеет IPID, а многие ОС при отправке пакета просто увеличивают IPID.

Это метод сканирования сети, который использует неактивные или "простаивающие" устройства в сети для выполнения сканирования. Этот метод позволяет сканировать сеть, минимизируя обнаружение и регистрацию активности сканирования.

Механика работы Idle-сканирования заключается в том, что сканирование выполняется через устройства, которые в данный момент не активно общаются в сети. Например, можно использовать устройство, которое находится в "спящем" режиме или неактивно в данный момент времени. Это позволяет сканировать сеть, обходя системы обнаружения вторжений, которые могут замечать активные сканирования.

Логика работы Idle-сканирования заключается в том, что сканирование происходит через устройства, которые обычно не вызывают подозрений. Таким образом, сканирование может быть более эффективным и менее заметным для защитных систем.

```bash
nmap -sI 192.168.1.2 192.168.127.0/24
```
- Сканирование в режиме ожидания, используя зомби-хост 192.168.1.2 в сети 192.168.127.0/24

## 4.3 Обход IDS и фаерволов

Обойти IDS и брандмауэры с помощью nmap можно с помощью различных техник и опций, которые помогут скрыть сканирование от обнаружения

```bash
-T - установить скорость сканирования на низкий уровень, чтобы избежать обнаружения
-f для фрагментации пакетов, что может помочь обойти некоторые брандмауэры
-D для подделки IP-адресов и сделать сканирование более анонимным
-sS для сканирования SYN, что может помочь обойти некоторые IDS
-Pn для сканирования без пинга, чтобы избежать обнаружения с помощью ICMP
```

Сегодняшние IDS и брандмауэры намного умнее тех, что существовали во времена, когда в nmap появились средства борьбы с ними. Поэтому многие приведенные здесь техники могут уже не работать, но это не повод ими не пользоваться, в Сети полно доисторического оборудования.

Начнем с того, что даже без дополнительных опций nmap уже способен хоть и не обойти, но обнаружить брандмауэр.

Происходит так потому, что при SYN-сканировании состояние открыт/закрыт определяется путем анализа ответа машины: SYN/ACK — открыт, FIN — закрыт. Однако брандмауэры, чтобы минимизировать процессорные ресурсы, зачастую просто дропают пакеты, адресуемые фильтруемым портам (даже при настройке iptables в Linux стандартная практика — это дропнуть пакет с помощью -j DROP).

nmap отслеживает, при пробе каких портов не было получено ответа, и помечает эти порты filtered.

Еще одна техника обнаружения брандмауэра заключается в том, чтобы заставить nmap генерировать «невероятные пакеты», такие как пакеты без единого флага (-sN), FIN-пакеты (-sF) и Xmas-пакеты, содержащие флаги FIN, PSH и URG (-sX). RFC описывает все эти ситуации, поэтому любое расхождение с RFC nmap интерпретирует как наличие брандмауэра.

```bash
nmap -sA 192.168.0.1
```
- Многие брандмауэры можно обойти и точно определить, фильтруется порт или нет. Для этого можно использовать ACK-сканирование

Теория здесь следующая: брандмауэр должен отбивать все новые TCP-подключения к порту, но также обязан не препятствовать прохождению пакетов в рамках уже установленных соединений. Простой способ сделать это — отбивать все SYN-пакеты (используется для установки соединения), но не мешать ACK-пакетам (используется для отправки пакетов в рамках уже открытого соединения).

Но есть одна тонкость. Дело в том, что есть так называемые stateful-брандмауэры. Они умеют отслеживать состояние соединения и проверяют такие поля пакетов, как IP-адрес и номер последовательности TCP, чтобы отслеживать, какие пакеты действительно пришли в рамках открытого ранее соединения, а какие были отправлены nmap в рамках ACK-сканирования (iptables в Linux может работать в обоих режимах, но по умолчанию он не stateful, это более производительный вариант).

Выяснить, какой тип брандмауэра используется, можно, выполнив SYN-сканирование и сразу за ним - ACK-сканирование.

Например, в выводе сканирования видно, что у устройства с IP адресом 192.168.127.254 все 1000 отсканированных портов находятся в игнорируемом состоянии. Это может указывать на то, что на данном устройстве настроен брандмауэр, который блокирует доступ к всем портам и не позволяет сканировать их состояние. Таким образом, наличие большого количества игнорируемых портов может свидетельствовать о наличии брандмауэра на устройстве.

```bash
nmap --source-port 53 192.168.0.1
```
- nmap будет использовать 53 порт для отправки пакетов к целевому узлу. Это эксплуатация старой ошибки настройки брандмауэра, которая заключается в том, что админ открывает доступ всему входящему трафику (включая протокол TCP) с порта 53, чтобы позволить приложениям беспрепятственно выполнять DNS-запросы. Сегодня такое встречается редко, но, как показывает практика, некомпетентность со временем не исчезает

**Как это выглядит при использовании в таком режиме NMAP**
- Запускаем NMAP на одной из машинок
- Далее на этой же машинке, смотрим через Wireshark как выглядят запросы
- Посмотрим, что видно на другой машинке, будем использовать tcpdump
- Находим строку, которая содержит информацию о сетевом пакете, который был отправлен с IP-адреса хоста на IP-адрес целевого узла. Пакет отправлен с порта domain (53) на порт 8008. Флаги [S] указывают на то, что это пакет синхронизации, который используется для установления соединения TCP. Последовательный номер (seq) равен 4280756250, размер окна (win) равен 1024. Опции включают максимальный размер сегмента (mss) равный 1460. Длина пакета равна 0, что означает, что в этом пакете нет данных, только заголовок
- Такое может произойти, например, в случае отправки пустого пакета для установления соединения или в случае отправки пакета с флагом SYN, чтобы начать установление соединения без передачи данных
- Это может быть сделано для сканирования портов или для проверки доступности хоста. В данном случае, возможно, что злоумышленник или утилита для сканирования сети генерирует такие пакеты без данных, чтобы проверить, открыт ли порт 8008 на целевом хосте

```bash
nmap -f 192.168.127.197
```
- Сканирование узла с использованием фрагментации пакетов. Фрагментация пакетов позволяет скрыть сканирование от некоторых сетевых систем обнаружения и предотвратить блокировку сканирования. nmap будет разбивать пакеты на фрагменты размером 8 байт, чтобы брандмауэр или IDS не смогли собрать пакет из фрагментов и проанализировать его заголовок (по причине плохой реализации или в угоду производительности) и просто пропустит пакет или отбросит

Анализ через Wireshark:
- Первая строка указывает на фрагментацию IP-протокола, где пакет с ID=d5dd был разделен на несколько фрагментов, один из которых был перенаправлен на другой порт
- Вторая строка показывает отправку запроса SYN с хоста на порт 113 целевого узла
- Третья и четвертая строки также указывают на фрагментацию IP-протокола, где пакет с ID=5e7d был разделен на несколько фрагментов, которые были успешно собраны
- Пятая строка показывает отправку запроса SYN с хоста на порт 23 целевого узла
- Шестая строка указывает на ответ от целевого узла на запрос SYN с хоста, где целевой узел отправляет пакет с флагом RST, ACK для сброса соединения и подтверждения получения данных
- **Header Checksum: 0x8b83 [validation disabled]**. Эта строка указывает на контрольную сумму заголовка пакета данных, которая равна 0x8b83 (или 35715 в десятичной системе). Кроме того, в сообщении указано, что проверка контрольной суммы отключена **(validation disabled)**. Эта информация может говорить о том, _**что данные строки связаны с обработкой сетевых пакетов или сетевым сканированием**_. **Например, nmap** - это популярная утилита для сканирования сети, которая может генерировать фрагментацию данных для скрытия своей активности
- Фрагментация данных может быть связана с процессом разделения больших пакетов данных на более мелкие фрагменты для передачи их через сеть. В данном контексте, если данные строки связаны с фрагментацией данных, это может указывать на использование тактики фрагментации для обхода сетевых фильтров или обнаружения

```bash
nmap --mtu 16 192.168.0.1
```
- То же самое, но контролируя размер пакета (в данном случае 16). Можно использовать против брандмауэров и IDS, которые умеют ловить факты сканирования с помощью nmap, анализируя размер фрагмента

Если подобных сообщений более 100, это может указывать на попытку сканирования портов или атаку на сеть. Подобное поведение может быть связано как с действиями злоумышленника, так и с работой некоторых сетевых утилит, таких как nmap. Присутствие фрагментации данных также может указывать на попытку обойти сетевые фильтры или провести атаку на уязвимости в протоколе IP.

```bash
nmap --data-length 25 192.168.0.1
```
- Добавляет в конец пакета указанное количество рандомных байт. Цель та же, что и в предыдущем случае: обмануть IDS, которая может быть способна обнаружить сканирование, анализируя размер пакета (nmap всегда посылает пакеты длиной 40 байт при использовании протокола TCP). Если бы не большое количество однотипных сообщений, то могло бы сложиться ощущение, что это легитимный трафик

# 5 Скрипты

nmap поддерживает использование скриптов, которые позволяют автоматизировать процесс сканирования и анализа сети. С помощью скриптов можно выполнять различные действия, такие как определение версии сервисов, обнаружение уязвимостей, анализ SSL-соединений и многое другое.

Для работы с скриптами в nmap используется параметр `--script` или `-sC`, который позволяет указать конкретные скрипты для выполнения во время сканирования. Скрипты в nmap разделены на категории, такие как `default`, `discovery`, `external`, `intrusive`, `safe` и другие. Каждая категория содержит набор скриптов, предназначенных для выполнения определенных задач. Скрипты nmap хранятся в каталоге `/usr/share/nmap/scripts/`.

```bash
nmap -sC 192.168.127.197/24
```
- `-sC` указывает nmap на использование стандартных скриптов для сканирования

**Nmap поставляется с более чем 500 скриптами, которые могут относиться к одной или нескольким из четырнадцати категорий:**
- **auth** - проверка возможности логина. Например, скрипт ftp-anon пробует выполнить анонимный логин на FTP-сервер и выводит список файлов, помечая доступные для записи файлы;
- **broadcast** - различные виды обнаружения хостов в сети.
    - _**Пример: broadcast-upnp-info**_ - скрипт для поиска UPnP-сервисов;
- **brute** - реализация техник брутфорса паролей.
    - _**Пример: http-brute**_ - брутфорс паролей от веб-сервера;
- **default** - скрипты, запускаемые автоматически при указании опции -A или -sC. Обычно это простые быстрые скрипты, собирающие дополнительную информацию о машине, вроде уже приведенного выше ftp-anon;
- **discovery** - практически аналог broadcast.
    - _**Пример: smb-enum-shares**_ - поиск расшаренных с помощью протокола SMB дисков;
- **dos** - скрипты для организации DoS-атак.
    - _**Пример: smb-vuln-regsvc-dos**_ - выводит из строя Windows 2000 путем эксплуатации уязвимости MSRC8742;
- **exploit** - эксплуатация или проверка на уязвимость.
    - _**Пример: smb-vuln-ms06-025**_ - проверка машин Windows на уязвимость MS06-025;
- **external** - скрипты, использующие внешние ресурсы для получения дополнительной информации о машине.
    - _**Пример: whois;**_
- **fuzzer** - скрипты, посылающие удаленной стороне неожиданные и неправильно сформированные данные с целью поиска уязвимостей или попытки выполнить DoS.
    - _**Пример: dns-fuzz;**_
- **intrusive** - скрипты, выполняющие активные действия в отношении машины.
    - _**Пример: snmp-brute**_ - брутфорс SNMP-сервера;
- **malware** - проверка на зараженность машины вирусами и бэкдорами.
    - _**Пример: smtp-strangeport**_ - поиск SMTP-сервера на нестандартном порте, что может быть свидетельством заражения машины трояном, рассылающим спам;
- **safe** - «безопасные» скрипты, которые не совершают активных действий в отношении машины, не забивают канал пакетами и не эксплуатируют уязвимости.
    - _**Пример: ssh-hostkey**_ - получает публичные ключи SSH-сервера;
- **version** - получение версий работающих служб.
    - _**Пример: pptp-version**_ - выводит на экран дополнительную информацию о PPTP-сервере;
- **vuln** - проверка служб на уязвимости.
    - Если указать опции -A или -sC, скрипты категории default будут запускаться автоматически. Для запуска скриптов других категорий можно использовать опцию --script.

```bash
nmap --script "not intrusive" 192.168.0.1
```
- Запустить все скрипты, кроме тех, что относятся к указанной категории
```bash
nmap -p80 --script "http-enum" 192.168.0.1
```
- Имя нужного скрипта (http-enum выполняет дирбастинг HTTP-сервера)
```bash
nmap -p80 --script "http-*" 192.168.0.1
```
- Запустить все скрипты, относящиеся к протоколу HTTP

# 6 Веб-сервер

В комплекте с nmap идет утилита ncat. Это аналог известнейшего netcat - универсального сетевого инструмента, с помощью которого можно тестировать сетевые службы, выполнять удаленные команды, передавать файлы, прокидывать через сеть аудио, слушать порты и делать множество других интересных вещей.

**С его же помощью можно запустить простейший веб-сервер:**

```bash
ncat -lk -p 8080 --sh-exec "echo -e 'HTTP/1.1 200 OK'; cat index.html"
```
- Запуск ncat в режиме прослушивания (-lk) на порту 8080, выполнение команды --sh-exec "echo -e 'HTTP/1.1 200 OK'; cat index.html", которая отправляет HTTP-заголовок "200 OK" и выводит содержимое файла index.html в ответ на запросы, поступающие на порт 8080

# Примеры

```bash
# Основное сканирование IP-адреса
nmap 0.0.0.0

# Сканирование конкретного диапазона портов
nmap -p 1-1000 0.0.0.0

# Сканирование с указанием версии служб
nmap -sV 0.0.0.0

# Сканирование устройств в сети + пинг найденных устройств (-P)
nmap -sP 192.168.0.1/24

# Сканирование устройств в сети и их портов
nmap -Pn 192.168.0.1/24

# Брутфорс ssh с помощью скрипта
nmap --script ssh-brute -p 22 0.0.0.0

# Брутфорс http auth с помощью скрипта и вордлистов
nmap -p 80 --script http-brute --script-args "http-brute.hostname=0.0.0.0,http-brute.method=POST,http-brute.path=PATH,passdb=pwd.txt,userdb=usr.txt" -v 0.0.0.0

# Поиск скрытых файлов и каталогов
nmap --script http-enum 0.0.0.0

# 
nmap -A --top-ports 10000 0.0.0.0 -vv

# Трассировка до хоста
nmap --traceroute

# Если вы не хотите сканировать порты, а хотите просто выполнить трассировку, то добавьте опцию -sn. Это значительно сократит время работы
nmap --traceroute -sn

# Бывает, что выводимые при трассировке программой nmap данные не являются полными. В этом случае попробуйте дополнительно добавить опцию -PE
nmap --traceroute -sn -PE 192.168.1.1
```
