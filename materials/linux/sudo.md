# SUDO

**sudo** (substitute user and do, подменить пользователя и выполнить) позволяет строго определенным пользователям выполнять указанные программы с административными привилегиями без ввода пароля суперпользователя root.

Использование sudo позволяет выполнять привилегированные команды обычным пользователям без необходимости ввода пароля суперпользователя root. Список пользователей и перечень их прав по отношению к ресурсам системы может быть настроен оптимальным образом для обеспечения комфортной и безопасной работы. Например, команда sudo в Ubuntu Linux, используется в режиме, позволяющем выполнять любые задачи администрирования системы без интерактивного входа под учетной записью root.

Параметры командной строки:
- `A, --askpass` - использовать вспомогательную программу для ввода пароля
- `b, --background` - выполнить команду в фоновом режиме
- `C, --close-from=num` - закрыть все дескрипторы файлов >= num
- `E, --preserve-env` - сохранить пользовательское окружение при выполнении команды
- `e, --edit` - редактировать файлы вместо выполнения команды
- `g, --group=group` - выполнить команду от имени или ID указанной группы
- `H, --set-home` - установить для переменной HOME домашний каталог указанного пользователя
- `h, --help` - показать справку и выйти
- `h, --host=host` - выполнить команду на узле (если поддерживается модулем)
- `i, --login` - запустить оболочку входа в систему от имени указанного пользователя; также можно задать команду
- `K, --remove-timestamp` - полностью удалить файл с timestamp
- `k, --reset-timestamp` - объявить недействительным файл timestamp
- `l, --list` - показать список прав пользователя или проверить заданную команду; в длинном формате используется дважды
- `n, --non-interactive` - автономный режим без вывода запросов пользователю
- `P, --preserve-groups` - сохранить вектор группы вместо установки целевой группы
- `p, --prompt=prompt` - использовать указанный запрос пароля
- `S, --stdin` - читать пароль из стандартного ввода
- `s, --shell` - запустить оболочку от имени указанного пользователя; также можно задать команду
- `U, --other-user=user` - в режиме списка показывать права пользователя
- `u, --user=user` - выполнить команду (или редактировать файл) от имени или ID указанного пользователя
- `V, --version` - показать сведения о версии и выйти
- `v, --validate` - обновить временную метку пользователя без выполнения команды
- `–` - прекратить обработку аргументов командной строки

```bash
# Обновить список пакетов
sudo apt update

# Удалить все файлы журналов
sudo rm -rf /var/log

# Редактировать файл конфигурации nginx
sudo nano /etc/nginx/nginx.conf

# Отобразить список команд, доступных для выполнения текущему пользователю. Кроме списка команд отображаются параметры среды, которые будут применяться при их выполнении
sudo –l

# Отобразить список команд, доступных для выполнения текущему пользователю в расширенном формате
sudo -ll

# Отобразить информацию о сетевом оборудовании с правами суперпользователя root
sudo lshw -C network

# Посмотреть список команд, доступных для выполнения пользователю user1. Для выполнения данной команды пользователь должен быть root или иметь право на выполнение команды sudo -l, что обеспечивается настройками утилиты sudo в файле /etc/sudoers
sudo –l –U user1

# Выполнить команду ipmitool sensor с правами root
sudo ipmitool sensor

- **`sudo su`** - выполнить команду su, т.е. создать сеанс суперпользователя root
- **`sudo -i`** - запустить командную оболочку с правами суперпользователя root. Для выполнения данной команды пользователь должен иметь право на выполнение программы оболочки в среде sudo, например - /bin/bash
- **`sudo ls /usr/local/protected`** - получить список файлов каталога, доступного только root
- **`sudo -u user2 ls ~`** - получить список файлов домашнего каталога пользователя user2
- **`sudo -u www vi ~www/htdocs/index.html`** - редактировать файл ~www/htdocs/index.html от имени пользователя www
- **`sudo -g adm view /var/log/syslog`** - просмотреть файл системного журнала, доступного только суперпользователю root и членам группы adm
- **`sudo -u user1 -g users2 vi /home/users2/textfile.txt`** - редактировать текстовый файл как пользователь user1, с принадлежностью к первичной группе users2
- **`sudo -E /usr/bin/firefox`** - запустить браузер firefox от имени суперпользователя root, сохранив параметры среды текущего пользователя. Возможность выполнения команд с сохранением среды пользователя должна быть разрешена параметром SETENV в настройках файла конфигурации sudo

```
- Примеры использования команды

Настройки sudo определяется содержимым файла `/etc/sudoers`. Поскольку ошибочные данные в данном файле могут привести к серьезным проблемам доступа к ресурсам системы, рекомендуется выполнять его изменение с помощью специального редактора sudoedit (в некоторых дистрибутивах - visudo), который поддерживает функции проверки синтаксиса и значительно снижает риск создания неработоспособной конфигурации sudo.

Содержимое файла `/etc/sudoers` определяет имена пользователей и групп, перечень выполняемых программ, необходимость введения паролей, и некоторые другие настройки, связанные с формированием переменных окружения при смене пользователя.

Кроме данного файла, настройки sudo могут определяться содержимым файлов из каталога `/etc/sudoers.d`, что позволяет структурировать систему предоставления прав на использование sudo в виде набора файлов с осмысленными именами, что полезно при большом количестве пользователей и сложной системе разграничения прав. Имена файлов конфигураций в каталоге `/etc/sudoers.d` могут быть любыми, но их содержимое должно полностью соответствовать формату файла `/etc/sudoers`.

**Специальные псевдонимы (Alias-ы)**

Синтаксис настроек в файле /etc/sudoers позволяет использовать специальные псевдонимы (Alias-ы), с помощью которых значительно упрощается как настройка, так и восприятие конфигурационной информации sudo:

- **В файле конфигурации /etc/sudoers возможно использование четырех разновидностей псевдонимов**
    
    - **User_Alias** - списки пользователей, для которых настраивается политика использования sudo.
    - **Runas_Alias** - списки пользователей, от имени которых может быть задано выполнение команд через sudo.
    - **Host_Alias** - списки узлов, с которых выполняется подключение к системе.
    - **Cmnd_Alias** - списки команд, использующиеся в настройках, выполняемых директивами файла /etc/sudoers
    
    **Примеры:**
    
    - **Host_Alias ADMCOMPS = localhost, server, admin** - определяет псевдоним ADMCOMPS, который определяет группу компьютеров с именами localhost, server, admin.
    - **Host_Alias MAILSERVERS = 192.168.0.100, smtp2** - определяет группу из двух компьютеров с указанными IP и именем. Возможно использование адресов подсетей.
    - **User_Alias ADMINS = jsmith, admusr** - определяет группу ADMINS, в которую входят пользователи с именами jsmith и admusr.
    
    <aside> 💡 Аналогичным образом можно создать псевдонимы для различных наборов команд, доступных для выполнения в sudo
    
    </aside>
    
- **Группы команд**
    
    - **Для работы в сети, псевдоним Networking**
        - Cmnd_Alias NETWORKING = /sbin/route, /sbin/ifconfig, /bin/ping, /sbin/dhclient, /usr/bin/net, /sbin/iptables, /usr/bin/rfcomm, /usr/bin/wvdial, /sbin/iwconfig, /sbin/mii-tool
    - **Для управления установкой и удалением программ, псевдоним SOFTWARE**
        - Cmnd_Alias SOFTWARE = /bin/rpm, /usr/bin/up2date, /usr/bin/yum
    - **Для управления системными службами, псевдоним SERVICES**
        - Cmnd_Alias SERVICES = /sbin/service, /sbin/chkconfig
    
    <aside> 💡 _Аналогичным образом можно создать псевдонимы для групп команд, выполнение которых делегируется одиночным или объединенных псевдонимами пользователей._
    
    </aside>
    
- **Формат записей**
    
    Основная часть настроек в файле /etc/sudoers задает правила, определяющие, какие пользователи, каких компьютеров, какие команды могут выполнять. Формат записей:
    
    - `user MACHINE=COMMANDS`
        - user - имена или псевдонимы пользователей.
        - MACHINE - имена или псевдонимы компьютеров
        - COMMANDS - секция команд, включающая имена или псевдонимы команд и дополнительные параметры.

```bash
# Разрешить выполнение пользователю root любых команд
root ALL=(ALL) ALL

# Разрешить выполнение всех команд для user через sudo. При данной настройке, у пользователя будет запрашиваться пароль (его личный, а не пароль суперпользователя root)
user ALL=(ALL) ALL

# Не запрашивать пароль для команд при использовании параметра NOPASSWD
user ALL=(ALL) NOPASSWD: /usr/bin/su, /usr/bin/drakxconf

# Разрешить группе пользователей, определенной псевдонимом “ADMINS” выполнять любые команды при подключении через петлевой интерфейс “localhost” без ввода пароля
ADMINS localhost=(ALL) NOPASSWD:ALL

# Разрешить группе пользователей, объединенных псевдонимом “ADMINS” выполнять группы команд, объединенные псевдонимами “NETWORKING” и “SOFTWARE”
ADMINS ALL=NETWORKING, SOFTWARE

# Разрешить локальным пользователям выключение компьютера
users localhost=/sbin/shutdown -h now

# Разрешить членам группы “operators” монтирование и размонтирование указанных устройств
operators ALL=/sbin/mount /mnt/cdrom, /sbin/umount /mnt/cdrom

# Разрешить членам группы “powerusers” выполнять команды группы “NETWORKING” с вводом пароля и команду “su” без пароля
powerusers ALL=NETWORKING, NOPASSWD: /usr/bin/su

# Разрешить группе пользователей, объединенных псевдонимом “ADMINS” выполнение всех команд, кроме команд, объединенных псевдонимом “NETWORKING”
ADMINS ALL= ALL, !NETWORKING

# Разрешение выполнения через sudo для всех пользователей группы “ADMINS”, всех команд, кроме команд смены оболочки
ADMINS ALL= ALL, !/bin/bash, !/usr/bin/su

# Кроме настроек доступа, в файле /etc/sudoers присутствуют директивы Defaults, определяющие некоторые настройки путей исполняемых файлов и создание переменных окружения при выполнении команд
Defaults secure_path = /sbin:/bin:/usr/sbin:/usr/bin
Defaults env_reset
Defaults env_keep = “COLOS DISPLAY HOSTNAME HISTSIZE INPUTRC KDEDIR LS_COLORS”
Defaults env_keep += “MAIL PS1 PS2 QTDIR USERNAME LANG LC_ADDRESS LC_CTYPE”
Defaults env_keep += “LC_COLLATE LC_IDENTIFICATION LC_MEASUREMENT LC_MESSAGES”
Defaults env_keep += “LC_MONETARY LC_NAME LC_NUMERIC LC_PAPER LC_TELEPHONE”
Defaults env_keep += “LC_TIME LC_ALL LANGUAGE LINGUAS _XKB_CHARSET XAUTHORITY”

# По умолчанию, если интервал выполнения команд с использованием sudo, не превышает 5 минут, то повторный ввод пароля не требуется. Однако, это значение можно изменить, добавив значение timestamp_timeout в минутах. В данном случае, если команда sudo будет выполняться не позже, чем через 1 минуту после ввода пароля для предыдущей команды, то повторно пароль запрашиваться не будет. Если значение `“timestamp_timeout”` сделать равным нулю, то пароль будет запрашиваться при каждом запуске sudo, если сделать отрицательным (-1), то повторный ввод пароля не будет запрашиваться никогда
Defaults timestamp_timeout=1

# Исключение возможности выполнения sudo-команд при подключении через ssh
# Для исключения возможности выполнения sudo-команд при подключении через ssh без авторизации, по умолчанию, должна использоваться команда “ssh –t “

# sudo можно запускать только из сеанса входа в систему, а не с помощью других средств, таких как скрипты `cron, shell/perl/python` или `cgi-bin scripts`. Этот флаг установлен по умолчанию на многих дистрибутивах
Defaults    requiretty

# Подробная справка по использованию sudo
man sudo
man sudoers
```
- Примеры конфигурации /etc/sudoers
- Использование псевдонимов позволяет уменьшить необходимое число записей для определения прав пользователей, которые могут подключаться к системе с разных компьютеров и входить в разные группы
- Довольно часто возникает необходимость исключения разрешения на выполнение отдельных команд из списка, объединенных псевдонимом. В этом случае, перед именем команды или псевдонима ставится восклицательный знак – !
